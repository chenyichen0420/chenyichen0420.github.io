<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>算法总结</title><link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px !important; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }
  .typora-export #write::after { height: 0px; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none 0s ease 0s; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="mermaid"] svg, [lang="flow"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
svg[id^="mermaidChart"] { line-height: 1em; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
mark .md-meta { color: rgb(0, 0, 0); opacity: 0.3 !important; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

html {
    font-size: 16px;
}

body {
    font-family: "Open Sans","Clear Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}
#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    padding-bottom: .3em;
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
   padding-bottom: .3em;
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}
h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table tr td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}


</style>
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><h1><a name="前言" class="md-header-anchor"></a><span>前言</span></h1><p><span>为什么会有这个东西呢？主要是我在做</span><a href='https://vjudge.net/contest/668083#problem/N'><span>这个题单</span></a><span>的时候，发现省选的时候这些算法都过过一遍，但是掌握情况相当的差。其他的题单也有部分的知识是我没有掌握到的。</span></p><p><span>所以，为了更好的完成这些题单，也为了为之后在省选有完备的的资料可查，或者为之后的人铺平道路，整理以下的内容。</span></p><p><span class='math-in-toc'>$\text{NOIP RP++!}$</span><span>。</span></p><p><span class='math-in-toc'>$2024.11.28$</span></p><p><span>为了能够及时更新，你会在我拖更的地方看到这样一句友情提示：</span></p><h6><a name="这里有你没写完的东西杂鱼" class="md-header-anchor"></a><span>这里有你没写完的东西，杂鱼...</span></h6><h1><a name="大纲" class="md-header-anchor"></a><span>大纲</span></h1><p><span>任务列表：</span></p><p><span>可并堆</span></p><p><span>线段树分裂与合并</span></p><p><span>动态DP</span></p><p><span>最小树形图  </span></p><blockquote><p><span>动态规划</span></p><blockquote><p>&nbsp;</p></blockquote><p><span>图论</span></p><blockquote><p><span>网络流</span></p><blockquote><p><span>FF-EK-Dinic</span>
<span>费用流</span>
<span>上下界流</span>
<span>模拟费用流</span></p></blockquote><p><span>2-SAT</span></p></blockquote><p><span>数据结构</span></p><blockquote><p><span>线段树</span>
<span>树状数组</span>
<span>莫队</span></p><blockquote><p><span>普通莫队</span>
<span>带修莫队</span>
<span>回滚莫队</span>
<span>树上莫队</span></p></blockquote><p><span>笛卡尔树</span>
<span>树套树</span></p><blockquote><p><span>线段树二分/树状数组倍增</span>
<span>多树二分</span></p></blockquote><p><span>整体二分</span>
<span>CDQ分治</span>
<span>ZKW线段树</span>
<span>李超线段树(</span><span class='math-in-toc'>$L_iC_{hao}T_{ree}$</span><span>)</span>
<span>动态树(</span><span class='math-in-toc'>$L_{ink}C_{at}T_{ree}$</span><span>)</span>
<span>快速傅里叶变换(</span><span class='math-in-toc'>$FFT$</span><span>)</span>
<span>快速数论变换(</span><span class='math-in-toc'>$NTT$</span><span>)</span>
<span>prufer序列</span>
<span>可并堆</span></p><blockquote><p><span>斜堆</span>
<span>随机堆</span>
<span>左偏树</span></p></blockquote><p><span>KDT</span></p></blockquote><p><span>数学</span></p><blockquote><p><span>卡特兰数</span>
<span>威尔逊定理</span>
<span>错排列</span>
<span>圆排列</span>
<span>多重集排列组合</span>
<span>BSGS 与 EXBSGS</span>
<span>生成函数</span></p><blockquote><p><span>普通生成函数</span>
<span>指数生成函数</span>
<span>狄利克雷生成函数</span></p></blockquote><p><span>狄利克雷卷积</span>
<span>莫比乌斯反演</span>
<span>杜教筛</span>
<span>第一类斯特林数</span>
<span>第二类斯特林数</span>
<span>斯特林反演</span>
<span>二项式反演</span>
<span>Burnside定理</span>
<span>Polya定理</span>
<span>博弈论</span>
<span>二次剩余</span>
<span>线性基</span></p></blockquote><p><span>字符串</span></p><blockquote><p><span>字符串哈希</span>
<span>KMP</span>
<span>EXKMP</span>
<span>ACAM</span><span class='math-in-toc'>$^{[1]}$</span><span>(AC自动机)</span>
<span>SAM(后缀自动机)</span>
<span>SA(后缀数组)</span></p></blockquote><p><span>杂谈</span></p><blockquote><p>&nbsp;</p></blockquote></blockquote><h3><a name="注" class="md-header-anchor"></a><span>注：</span></h3><p><span class='math-in-toc'>$[1]$</span><span>：AM 在字符串中，默认指 </span><span class='math-in-toc'>$\text{automation}$</span><span>，即自动机。</span></p><h1><a name="动态规划" class="md-header-anchor"></a><span>动态规划</span></h1><h2><a name="期望与概率dp" class="md-header-anchor"></a><span>期望与概率DP</span></h2><p><span>首先想一下能不能从高斯消元入手。比如说：小明在一个 </span><span class='math-in-toc'>$[1,n]$</span><span> 的序列上随机游走，每次会随机走到距离 </span><span class='math-in-toc'>$\le1$</span><span> 的一个位置，求走到 </span><span class='math-in-toc'>$n$</span><span> 的期望步数。</span></p><p><span>我们可以写出他的转移方程：</span></p><p><span>$ $。</span></p><p><span>这时候，我们把它写成矩阵，玩高斯消元，获得一个 </span><span class='math-in-toc'>$O(n^3)$</span><span> 的算法。</span></p><p><span>但是这类随机游走的核心就在于他的矩阵非常稀疏。比如这道题，我们大致只有 </span><span class='math-in-toc'>$3\times n$</span><span> 个非零值。</span></p><h6><a name="这里有你没写完的东西杂鱼-n3318" class="md-header-anchor"></a><span>这里有你没写完的东西，杂鱼...</span></h6><h1><a name="图论" class="md-header-anchor"></a><span>图论</span></h1><h2><a name="网络流" class="md-header-anchor"></a><span>网络流</span></h2><h3><a name="ff-ek-dinic" class="md-header-anchor"></a><span>FF-EK-Dinic</span></h3><h4><a name="ffford--fulkerson-增广思路" class="md-header-anchor"></a><span>FF(Ford–Fulkerson) 增广思路</span></h4><p><span>FF，即 Ford–Fulkerson 增广。该方法运用贪心的思想，通过寻找增广路来更新并求解最大流。</span></p><p><span>其中有一个概念叫做增广路，说白了就是所有边剩余流量大于零的路径。使用这条边显然可以使答案增加，但是直接贪心是错的。</span></p><p><span>接下来，我们进行反悔贪心。当我们给 </span><span class='math-in-toc'>$x\to y$</span><span> 这条边增加 </span><span class='math-in-toc'>$v$</span><span> 的流量时，就将 </span><span class='math-in-toc'>$x\to y$</span><span> 的剩余流量减去 </span><span class='math-in-toc'>$v$</span><span>，而将 </span><span class='math-in-toc'>$y\to x$</span><span> 的剩余流量增加 </span><span class='math-in-toc'>$v$</span><span>。</span></p><p><span>正如 OI-wiki 的一张图：</span></p><p><img src="https://oi-wiki.org/graph/flow/images/flow2.png" referrerpolicy="no-referrer"></p><p><span>可以严格证明，这里略去。</span><del><span>反正不考证明</span></del><span>。其本质上就是 </span><a href='https://oi-wiki.org/graph/flow/max-flow/#%E6%9C%80%E5%A4%A7%E6%B5%81%E6%9C%80%E5%B0%8F%E5%89%B2%E5%AE%9A%E7%90%86'><span>最大流-最小割</span></a><span> 定理。</span></p><h4><a name="ek-算法" class="md-header-anchor"></a><span>EK 算法</span></h4><p><span>使用 BFS时，FF 增广表现为 EK 算法。其本质上就是将找出任意一条变成了找出最短的一条，每次使用 BFS 找出最短的增广路并增广。时间复杂度为 </span><span class='math-in-toc'>$O(nm^2)$</span><span>。时间复杂度劣，而且和 Dinic 难度大致相当，不附代码。</span></p><h4><a name="dinic-算法" class="md-header-anchor"></a><span>Dinic 算法</span></h4><p><span>他的优化就在于他同时对多条增广路进行处理，具体的流程如下：</span></p><p><span>首先，对当前的图做一次 BFS，求出每个点的“深度”。</span></p><p><span>然后，进行 DFS。每次 DFS 时，记录当前节点和当前携带流量。随后，一直向深度大 </span><span class='math-in-toc'>$1$</span><span> 的子节点分配尽可能多的流量，直到没有子节点或者自己流量用完。贡献就是所有被分配到的子节点的贡献之和。</span></p><p><span>这里还常用一个“当前弧”优化，其实说白了，就是之前已经被分配满的子节点以后不可能再分配了，因此记录一个已枚举位置就行。参考代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//就这你还想看？没更新呢！</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><h3><a name="费用流" class="md-header-anchor"></a><span>费用流</span></h3><p><span>对于没有负圈的普通费用流，常用 SSP(Successive Shortest Path) 进行求解，思路类似于 FF，每一次找一条或多条单位费用最大/小的路进行增广。</span></p><p><span>负圈是指单位费用为负的圈。</span></p><p><span>注意费用流的时间复杂度是 </span><span class='math-in-toc'>$O(nmf)$</span><span> 的，</span><span class='math-in-toc'>$f$</span><span> 是最大流。可以被卡到 </span><span class='math-in-toc'>$O(n^32^{\frac{n}{2}})$</span><span>。</span></p><p><span>给出基于 Dinic 的参考代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">SSP</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">struct</span> <span class="cm-def">node</span> { <span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable">f</span>, <span class="cm-variable">v</span>; }<span class="cm-variable">tmp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">node</span><span class="cm-operator">&gt;</span><span class="cm-variable">e</span>; <span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">h</span>[<span class="cm-number">5005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">ins</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">f</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tmp</span>.<span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>; <span class="cm-variable">tmp</span>.<span class="cm-variable">f</span> <span class="cm-operator">=</span> <span class="cm-variable">f</span>; <span class="cm-variable">tmp</span>.<span class="cm-variable">v</span> <span class="cm-operator">=</span> <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">h</span>[<span class="cm-variable">l</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">e</span>.<span class="cm-variable">size</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">e</span>.<span class="cm-variable">emplace_back</span>(<span class="cm-variable">tmp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tmp</span>.<span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">l</span>; <span class="cm-variable">tmp</span>.<span class="cm-variable">f</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">tmp</span>.<span class="cm-variable">v</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">h</span>[<span class="cm-variable">r</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">e</span>.<span class="cm-variable">size</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">e</span>.<span class="cm-variable">emplace_back</span>(<span class="cm-variable">tmp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>} <span class="cm-comment">//加边函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">d</span>[<span class="cm-number">5005</span>]; <span class="cm-variable">bitset</span><span class="cm-operator">&lt;</span><span class="cm-number">5005</span><span class="cm-operator">&gt;</span><span class="cm-variable">vis</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">spfa</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vis</span>.<span class="cm-variable">reset</span>(); <span class="cm-variable">fill</span>(<span class="cm-variable">d</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">d</span> <span class="cm-operator">+</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-number">0x3f3f3f3f3f3f3f3f</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">queue</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">q</span>; <span class="cm-variable">q</span>.<span class="cm-variable">emplace</span>(<span class="cm-variable">s</span>); <span class="cm-variable">d</span>[<span class="cm-variable">s</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">q</span>.<span class="cm-variable">size</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">tp</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>.<span class="cm-variable">front</span>(); <span class="cm-variable">q</span>.<span class="cm-variable">pop</span>(); <span class="cm-variable">vis</span>[<span class="cm-variable">tp</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> : <span class="cm-variable">h</span>[<span class="cm-variable">tp</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">f</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">d</span>[<span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span>] <span class="cm-operator">&gt;</span> <span class="cm-variable">d</span>[<span class="cm-variable">tp</span>] <span class="cm-operator">+</span> <span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">v</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">d</span>[<span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">d</span>[<span class="cm-variable">tp</span>] <span class="cm-operator">+</span> <span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">v</span>, <span class="cm-operator">!</span><span class="cm-variable">vis</span>[<span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">q</span>.<span class="cm-variable">emplace</span>(<span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span>), <span class="cm-variable">vis</span>[<span class="cm-variable">e</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">d</span>[<span class="cm-variable">t</span>] <span class="cm-operator">!=</span> <span class="cm-number">0x3f3f3f3f3f3f3f3f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>} <span class="cm-comment">//分层，这里的“距离”从 $1$ 变成了边权，因为有负权，所以需要 spfa</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">pr</span>[<span class="cm-number">5005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">dfs</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">f</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">p</span> <span class="cm-operator">==</span> <span class="cm-variable">t</span> <span class="cm-operator">||</span> <span class="cm-operator">!</span><span class="cm-variable">f</span>) <span class="cm-keyword">return</span> <span class="cm-variable">f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">v</span>; <span class="cm-variable">vis</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">pr</span>[<span class="cm-variable">p</span>];<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">h</span>[<span class="cm-variable">p</span>].<span class="cm-variable">size</span>();<span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">sp</span> <span class="cm-operator">=</span> <span class="cm-variable">e</span>[<span class="cm-variable">h</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">vis</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">sp</span>.<span class="cm-variable">f</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">d</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">==</span> <span class="cm-variable">d</span>[<span class="cm-variable">p</span>] <span class="cm-operator">+</span> <span class="cm-variable">sp</span>.<span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span> <span class="cm-operator">=</span> <span class="cm-variable">dfs</span>(<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>, <span class="cm-variable">min</span>(<span class="cm-variable">f</span>, <span class="cm-variable">sp</span>.<span class="cm-variable">f</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">v</span>) <span class="cm-variable">d</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">0x3f3f3f3f3f3f3f3f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sp</span>.<span class="cm-variable">f</span> <span class="cm-operator">-=</span> <span class="cm-variable">v</span>; <span class="cm-variable">e</span>[<span class="cm-variable">h</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-variable">^</span> <span class="cm-number">1</span>].<span class="cm-variable">f</span> <span class="cm-operator">+=</span> <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ret</span> <span class="cm-operator">+=</span> <span class="cm-variable">v</span>; <span class="cm-variable">f</span> <span class="cm-operator">-=</span> <span class="cm-variable">v</span>; <span class="cm-variable">ans</span> <span class="cm-operator">+=</span> <span class="cm-variable">v</span> <span class="cm-operator">*</span> <span class="cm-variable">sp</span>.<span class="cm-variable">v</span>; <span class="cm-comment">//要在这里统计费用，边权不一致。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">f</span>) <span class="cm-keyword">return</span> <span class="cm-variable">ret</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vis</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-keyword">return</span> <span class="cm-variable">ret</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">que</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">spfa</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fill</span>(<span class="cm-variable">pr</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">pr</span> <span class="cm-operator">+</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-number">0</span>); <span class="cm-comment">//当前弧优化</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">v</span>;<span class="cm-variable">v</span> <span class="cm-operator">=</span> <span class="cm-variable">dfs</span>(<span class="cm-variable">s</span>, <span class="cm-number">0x3f3f3f3f3f3f3f3f</span>);) <span class="cm-variable">mxf</span> <span class="cm-operator">+=</span> <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">mxf</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//que 返回最大流，ans 存最小费用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">ssp</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1127px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1127px;"></div></div></div></pre><h3><a name="上下界流" class="md-header-anchor"></a><span>上下界流</span></h3><p><span>正如其名，原先只有上界的网络流也有下界拉！一篇较好的</span><a href='https://blog.csdn.net/EQUINOX1/article/details/135953172'><span>博客</span></a><span>专讲基础上下界流。</span></p><h4><a name="存在性判定" class="md-header-anchor"></a><span>存在性判定</span></h4><p><span>对于每一个点，我们令 </span><span class='math-in-toc'>$cin_i=\sum f(j,i),cout_i=\sum f(i,j),rd_i=cin_i-cout_i$</span><span>，然后思考：</span></p><ol start='' ><li><span>对于 </span><span class='math-in-toc'>$rd_i=0$</span><span> 的点，其入度的下界与出度的下界相同，也就是说这些边我们可以将上界重写为 </span><span class='math-in-toc'>$fmax-fmin$</span><span>，仍满足流量守恒。</span></li><li><span>对于 </span><span class='math-in-toc'>$rd_i&lt;0$</span><span> 的点，他若直接将上界重写为 </span><span class='math-in-toc'>$fmax-fmin$</span><span>，则不满足流量守恒，出度过小。需要向超级汇点连一条容量上界为 </span><span class='math-in-toc'>$-rd_i$</span><span> 的边。</span></li><li><span>对于 </span><span class='math-in-toc'>$rd_i&gt;0$</span><span> 的点，他若直接将上界重写为 </span><span class='math-in-toc'>$fmax-fmin$</span><span>，则不满足流量守恒，入度过小。需要从超级源点连一条容量上界为 </span><span class='math-in-toc'>$rd_i$</span><span> 的边。</span></li></ol><p><span>此时，若从超级源点到超级汇点满流，则存在，反之不存在，由源汇点的流量与原图的流量守恒关系不难证得。</span></p><h4><a name="有源状态下的判定" class="md-header-anchor"></a><span>有源状态下的判定</span></h4><p><span>从 </span><span class='math-in-toc'>$t$</span><span> 向 </span><span class='math-in-toc'>$s$</span><span> 连一条容量无限的边，就完美地将有源强转成了无源，然后就能做了。</span></p><h4><a name="最大小流有源" class="md-header-anchor"></a><span>最大/小流(有源)</span></h4><p><span>我们还是先有源强转无源跑判定，判定完了之后记录 </span><span class='math-in-toc'>$s$</span><span> 到 </span><span class='math-in-toc'>$t$</span><span> 的最大流，删除 </span><span class='math-in-toc'>$t$</span><span> 到 </span><span class='math-in-toc'>$s$</span><span> 的边，然后分情况：</span></p><p><span>如果是最大流，就跑出 </span><span class='math-in-toc'>$s$</span><span> 到 </span><span class='math-in-toc'>$t$</span><span> 的最大流和开始的那个最大流相加得到结果。</span></p><p><span>如果是最小流，就跑出 </span><span class='math-in-toc'>$t$</span><span> 到 </span><span class='math-in-toc'>$s$</span><span> 的最大流和开始的那个最大流相减得到结果。</span></p><p><span>问什么正确呢？其实判定的本质就是强制流量守恒，也就是强制将上下界流改成普通流。</span></p><p><span>判定如果成功的话，那么所有的点都在同一个“势能面”上了，多余的就是在推流/反流。</span></p><p><span>比如针对两个的</span><a href=''><span>缝合体</span></a><span>红石科技，我们可以这样写：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define int long long</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">...<span class="cm-comment">//定义变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">ULBNF</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>...<span class="cm-comment">//定义变量与其他函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">dneflow</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">sm</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">bfs</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fill</span>(<span class="cm-variable">cur</span>, <span class="cm-variable">cur</span> <span class="cm-operator">+</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">4</span>, <span class="cm-number">0</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ans</span> <span class="cm-operator">+=</span> <span class="cm-variable">dfs</span>(<span class="cm-variable">s</span>, <span class="cm-number">1e18</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ans</span> <span class="cm-operator">!=</span> <span class="cm-variable">sm</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">maxflow</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">bfs</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fill</span>(<span class="cm-variable">cur</span>, <span class="cm-variable">cur</span> <span class="cm-operator">+</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">4</span>, <span class="cm-number">0</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ans</span> <span class="cm-operator">+=</span> <span class="cm-variable">dfs</span>(<span class="cm-variable">s</span>, <span class="cm-number">1e18</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">minflow</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">bfs</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fill</span>(<span class="cm-variable">cur</span>, <span class="cm-variable">cur</span> <span class="cm-operator">+</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">4</span>, <span class="cm-number">0</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ans</span> <span class="cm-operator">-=</span> <span class="cm-variable">dfs</span>(<span class="cm-variable">s</span>, <span class="cm-number">1e18</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">net</span>; <span class="cm-comment">//upper-lower bound network flow</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">n</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">m</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">ys</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">yt</span>; <span class="cm-variable">s</span> <span class="cm-operator">=</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>; <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">a</span>, <span class="cm-variable">b</span>, <span class="cm-variable">c</span>, <span class="cm-variable">d</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">a</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">b</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">c</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">d</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">net</span>.<span class="cm-variable">ins</span>(<span class="cm-variable">a</span>, <span class="cm-variable">b</span>, <span class="cm-variable">d</span> <span class="cm-operator">-</span> <span class="cm-variable">c</span>, <span class="cm-number">0</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rd</span>[<span class="cm-variable">a</span>] <span class="cm-operator">-=</span> <span class="cm-variable">c</span>, <span class="cm-variable">rd</span>[<span class="cm-variable">b</span>] <span class="cm-operator">+=</span> <span class="cm-variable">c</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">bool</span> <span class="cm-variable">ext</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rd</span>[<span class="cm-variable">i</span>] <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>) <span class="cm-variable">sm</span> <span class="cm-operator">+=</span> <span class="cm-variable">rd</span>[<span class="cm-variable">i</span>], <span class="cm-variable">net</span>.<span class="cm-variable">ins</span>(<span class="cm-variable">s</span>, <span class="cm-variable">i</span>, <span class="cm-variable">rd</span>[<span class="cm-variable">i</span>], <span class="cm-number">0</span>), <span class="cm-variable">ext</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">rd</span>[<span class="cm-variable">i</span>] <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) <span class="cm-variable">net</span>.<span class="cm-variable">ins</span>(<span class="cm-variable">i</span>, <span class="cm-variable">t</span>, <span class="cm-operator">-</span><span class="cm-variable">rd</span>[<span class="cm-variable">i</span>], <span class="cm-number">0</span>), <span class="cm-variable">ext</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-comment">// :)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">net</span>.<span class="cm-variable">ins</span>(<span class="cm-variable">yt</span>, <span class="cm-variable">ys</span>, <span class="cm-number">1e18</span>, <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">net</span>.<span class="cm-variable">dneflow</span>(<span class="cm-variable">sm</span>)) <span class="cm-keyword">return</span> <span class="cm-variable">puts</span>(<span class="cm-string">"A clever xzy~~~"</span>), <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-variable">net</span>.<span class="cm-variable">e</span>.<span class="cm-variable">back</span>().<span class="cm-variable">f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">net</span>.<span class="cm-variable">dellast</span>(<span class="cm-variable">yt</span>, <span class="cm-variable">ys</span>); <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-variable">ys</span>, <span class="cm-variable">s</span> <span class="cm-operator">=</span> <span class="cm-variable">yt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> (<span class="cm-variable">ext</span> <span class="cm-operator">?</span> <span class="cm-variable">net</span>.<span class="cm-variable">minflow</span>() <span class="cm-operator">-</span> <span class="cm-number">1</span> : <span class="cm-operator">-</span><span class="cm-number">1</span>) <span class="cm-operator">&lt;&lt;</span> <span class="cm-string">' '</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">s</span> <span class="cm-operator">=</span> <span class="cm-variable">ys</span>, <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-variable">yt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">net</span>.<span class="cm-variable">maxflow</span>() <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1035px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1035px;"></div></div></div></pre><h4><a name="最大小费用可行流" class="md-header-anchor"></a><span>最大/小费用可行流</span></h4><p><span>基于我们前面所讲的判定的本质就是强制流量守恒，我们不管在建出来的辅助图上跑网络流还是费用流，反正只要限定是最大流，就能对应出原图的一个可行流。</span></p><p><span>所以说，我们建出辅助图并且提前计算砍去下界少算的费用，辅助图的最大/小费用最大流就是原图的最大/小费用可行流。比最大/小流(有源)还少一步。</span></p><p><span>核心代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">ULBNF</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">d</span>[<span class="cm-number">505</span>]; <span class="cm-variable-3">bool</span> <span class="cm-variable">vis</span>[<span class="cm-number">505</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">spfa</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fill</span>(<span class="cm-variable">vis</span>, <span class="cm-variable">vis</span> <span class="cm-operator">+</span> <span class="cm-variable">t</span> <span class="cm-operator">+</span> <span class="cm-number">4</span>, <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">d</span>, <span class="cm-number">0x0f</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">d</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vis</span>[<span class="cm-variable">s</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">d</span>[<span class="cm-variable">s</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">queue</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">q</span>; <span class="cm-variable">q</span>.<span class="cm-variable">push</span>(<span class="cm-variable">s</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">q</span>.<span class="cm-variable">size</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">tp</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>.<span class="cm-variable">front</span>();<span class="cm-variable">q</span>.<span class="cm-variable">pop</span>(); <span class="cm-variable">vis</span>[<span class="cm-variable">tp</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">h</span>[<span class="cm-variable">tp</span>].<span class="cm-variable">size</span>();<span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">sp</span> <span class="cm-operator">=</span> <span class="cm-variable">e</span>[<span class="cm-variable">h</span>[<span class="cm-variable">tp</span>][<span class="cm-variable">i</span>]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sp</span>.<span class="cm-variable">f</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">d</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">&gt;</span> <span class="cm-variable">d</span>[<span class="cm-variable">tp</span>] <span class="cm-operator">+</span> <span class="cm-variable">sp</span>.<span class="cm-variable">v</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">d</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">d</span>[<span class="cm-variable">tp</span>] <span class="cm-operator">+</span> <span class="cm-variable">sp</span>.<span class="cm-variable">v</span>, <span class="cm-operator">!</span><span class="cm-variable">vis</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">q</span>.<span class="cm-variable">push</span>(<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>), <span class="cm-variable">vis</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">d</span>[<span class="cm-variable">t</span>] <span class="cm-operator">&lt;</span> <span class="cm-number">1e8</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">cur</span>[<span class="cm-number">505</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">dfs</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">a</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">p</span> <span class="cm-operator">==</span> <span class="cm-variable">t</span> <span class="cm-operator">||</span> <span class="cm-variable">a</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>) &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">a</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">f</span>; <span class="cm-variable">vis</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">cur</span>[<span class="cm-variable">p</span>]; <span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">h</span>[<span class="cm-variable">p</span>].<span class="cm-variable">size</span>(); <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">sp</span> <span class="cm-operator">=</span> <span class="cm-variable">e</span>[<span class="cm-variable">h</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">vis</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">d</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">==</span> <span class="cm-variable">d</span>[<span class="cm-variable">p</span>] <span class="cm-operator">+</span> <span class="cm-variable">sp</span>.<span class="cm-variable">v</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">sp</span>.<span class="cm-variable">f</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">f</span> <span class="cm-operator">=</span> <span class="cm-variable">dfs</span>(<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>, <span class="cm-variable">min</span>(<span class="cm-variable">a</span>, <span class="cm-variable">sp</span>.<span class="cm-variable">f</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">f</span>) <span class="cm-variable">d</span>[<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">0x0f0f0f0f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sp</span>.<span class="cm-variable">f</span> <span class="cm-operator">-=</span> <span class="cm-variable">f</span>; <span class="cm-variable">e</span>[<span class="cm-variable">h</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-variable">^</span> <span class="cm-number">1</span>].<span class="cm-variable">f</span> <span class="cm-operator">+=</span> <span class="cm-variable">f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ret</span> <span class="cm-operator">+=</span> <span class="cm-variable">f</span>; <span class="cm-variable">a</span> <span class="cm-operator">-=</span> <span class="cm-variable">f</span>; <span class="cm-variable">miv</span> <span class="cm-operator">+=</span> <span class="cm-variable">sp</span>.<span class="cm-variable">v</span> <span class="cm-operator">*</span> <span class="cm-variable">f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">a</span>) <span class="cm-keyword">return</span> <span class="cm-variable">ret</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vis</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-keyword">return</span> <span class="cm-variable">ret</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">micflow</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">spfa</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fill</span>(<span class="cm-variable">cur</span>, <span class="cm-variable">cur</span> <span class="cm-operator">+</span> <span class="cm-variable">t</span> <span class="cm-operator">+</span> <span class="cm-number">4</span>, <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">v</span>;<span class="cm-variable">v</span> <span class="cm-operator">=</span> <span class="cm-variable">dfs</span>(<span class="cm-variable">s</span>, <span class="cm-number">12</span>);) <span class="cm-variable">ans</span> <span class="cm-operator">+=</span> <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">miv</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">net</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 989px;"></div><div class="CodeMirror-gutters" style="display: none; height: 989px;"></div></div></div></pre><p><span>当然还是别忘了要给原图中的 </span><span class='math-in-toc'>$t\to s$</span><span> 建一条没费用的无限流。</span></p><h3><a name="模拟费用流" class="md-header-anchor"></a><span>模拟费用流</span></h3><p><span>思路类似于手动消元，说白了就是利用建出来的图的性质进行针对性的优化，从而加速计算。</span><a href='https://vjudge.net/problem/QOJ-7185#author=luzchancc'><span>例题1</span></a><span>。</span></p><p><span>在这道题中，建模其实非常的裸，但是点数过大，完全不能跑费用流，因此需要手动最短路。</span></p><p><span>那怎么做呢？我们注意到原图近似是一个二分图，也就是说任意一条路径可以视为 </span><span class='math-in-toc'>$s\to l\to r$</span><span>，任意多条 </span><span class='math-in-toc'>$r\to l\to r$</span><span> 和 </span><span class='math-in-toc'>$r\to t$</span><span> 拼接而成的。第三段费用为 </span><span class='math-in-toc'>$0$</span><span>，所以只用分别维护第一二段从每个 </span><span class='math-in-toc'>$r$</span><span> 出发的最优边。</span></p><p><span>给出一份仅保留核心的参考代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">enable</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">lp</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lus</span>[<span class="cm-variable">lp</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rls</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>]) <span class="cm-variable">sh</span>[<span class="cm-variable">i</span>].<span class="cm-variable">emplace</span>(<span class="cm-variable">c</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>], <span class="cm-variable">lp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//这里是在处理添加左点对 slr 路径的影响</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">j</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">j</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">rls</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">j</span>] <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">rls</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">hh</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>].<span class="cm-variable">emplace</span>(<span class="cm-variable">c</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">j</span>] <span class="cm-operator">-</span> <span class="cm-variable">c</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>], <span class="cm-variable">lp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//这里是在处理添加左点对 rlr 路径的影响</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">disable</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">lp</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lus</span>[<span class="cm-variable">lp</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rls</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>]) <span class="cm-variable">sh</span>[<span class="cm-variable">i</span>].<span class="cm-variable">erase</span>(<span class="cm-variable">sh</span>[<span class="cm-variable">i</span>].<span class="cm-variable">find</span>(<span class="cm-variable">node</span>(<span class="cm-variable">c</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>], <span class="cm-variable">lp</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//这里是在处理删除左点对 slr 路径的影响</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">j</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">j</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">rls</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">j</span>] <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">rls</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">hh</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>].<span class="cm-variable">erase</span>(<span class="cm-variable">hh</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>].<span class="cm-variable">find</span>(<span class="cm-variable">node</span>(<span class="cm-variable">c</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">j</span>] <span class="cm-operator">-</span> <span class="cm-variable">c</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">i</span>], <span class="cm-variable">lp</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//这里是在处理删除左点对 rlr 路径的影响</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">solvpas</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>, <span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;&amp;</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">v</span>[<span class="cm-variable">l</span>][<span class="cm-variable">r</span>] <span class="cm-operator">==</span> <span class="cm-variable">pv</span>[<span class="cm-variable">l</span>][<span class="cm-variable">r</span>]) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">p</span>.<span class="cm-variable">emplace_back</span>(<span class="cm-variable">l</span>); <span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">solvpas</span>(<span class="cm-variable">l</span>, <span class="cm-variable">pp</span>[<span class="cm-variable">l</span>][<span class="cm-variable">r</span>], <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//<span class="cm-tab" role="presentation" cm-text="	">  </span>p.emplace_back(pp[l][r]);</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//<span class="cm-tab" role="presentation" cm-text="	">  </span>实际上查询子区间时总会找到这些“叶子”节点并加入队列中。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">solvpas</span>(<span class="cm-variable">pp</span>[<span class="cm-variable">l</span>][<span class="cm-variable">r</span>], <span class="cm-variable">r</span>, <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">delt1</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) { <span class="cm-comment">//传入的是右侧点的编号。暂未更改，可以倒推出左侧点编号</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">sh</span>[<span class="cm-variable">p</span>].<span class="cm-variable">begin</span>()<span class="cm-operator">-&gt;</span><span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">disable</span>(<span class="cm-variable">lp</span>); <span class="cm-variable">lus</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rls</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">p</span>] <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">enable</span>(<span class="cm-variable">lp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">delt2</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">ap</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">bp</span>) { <span class="cm-comment">//同上</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">cp</span> <span class="cm-operator">=</span> <span class="cm-variable">hh</span>[<span class="cm-variable">ap</span>][<span class="cm-variable">bp</span>].<span class="cm-variable">begin</span>()<span class="cm-operator">-&gt;</span><span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">disable</span>(<span class="cm-variable">cp</span>); <span class="cm-variable">rls</span>[<span class="cm-variable">cp</span>][<span class="cm-variable">bp</span>] <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rls</span>[<span class="cm-variable">cp</span>][<span class="cm-variable">ap</span>] <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">enable</span>(<span class="cm-variable">cp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>); <span class="cm-variable">m</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">rls</span>, <span class="cm-number">1</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">rls</span>); <span class="cm-comment">//初始全部可用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">a</span>[<span class="cm-variable">i</span>], <span class="cm-variable">n</span> <span class="cm-operator">+=</span> <span class="cm-variable">a</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">j</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>) <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">c</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">lus</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">enable</span>(<span class="cm-variable">i</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">tms</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">tms</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>;<span class="cm-operator">++</span><span class="cm-variable">tms</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//总计 n 次增广；m 是源点，m+1 是汇点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">v</span>, <span class="cm-number">0xcf</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">v</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">pp</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">pp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">j</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">j</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">hh</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>].<span class="cm-variable">size</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>] <span class="cm-operator">=</span> <span class="cm-variable">hh</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>].<span class="cm-variable">begin</span>()<span class="cm-operator">-&gt;</span><span class="cm-variable">l</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sh</span>[<span class="cm-variable">i</span>].<span class="cm-variable">size</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">m</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">sh</span>[<span class="cm-variable">i</span>].<span class="cm-variable">begin</span>()<span class="cm-operator">-&gt;</span><span class="cm-variable">l</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">fl</span>[<span class="cm-variable">i</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">a</span>[<span class="cm-variable">i</span>]) <span class="cm-variable">v</span>[<span class="cm-variable">i</span>][<span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">j</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pv</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">k</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;<span class="cm-operator">++</span><span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">j</span> <span class="cm-operator">!=</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">v</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>][<span class="cm-variable">k</span>] <span class="cm-operator">+</span> <span class="cm-variable">v</span>[<span class="cm-variable">k</span>][<span class="cm-variable">j</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>][<span class="cm-variable">k</span>] <span class="cm-operator">+</span> <span class="cm-variable">v</span>[<span class="cm-variable">k</span>][<span class="cm-variable">j</span>], <span class="cm-variable">pp</span>[<span class="cm-variable">i</span>][<span class="cm-variable">j</span>] <span class="cm-operator">=</span> <span class="cm-variable">k</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">pas</span>; <span class="cm-variable">ans</span> <span class="cm-operator">+=</span> <span class="cm-variable">v</span>[<span class="cm-variable">m</span>][<span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">solvpas</span>(<span class="cm-variable">m</span>, <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">pas</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//处理路径，因为要开始增删边了。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">pas</span>.<span class="cm-variable">size</span>() <span class="cm-operator">-</span> <span class="cm-number">1</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">delt2</span>(<span class="cm-variable">pas</span>[<span class="cm-variable">i</span>], <span class="cm-variable">pas</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">delt1</span>(<span class="cm-variable">pas</span>[<span class="cm-number">1</span>]); <span class="cm-variable">fl</span>[<span class="cm-variable">pas</span>.<span class="cm-variable">back</span>()]<span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">ans</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">\\然而并不能过这一道题。</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1817px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1817px;"></div></div></div></pre><p><a href='https://codeforces.com/problemset/problem/724/E'><span>例题2</span></a><span>，同样非常好建模，但是不难发现边太多了，没法玩。</span></p><p><span>所以我们可以从最大流-最小割定理入手，算他的最小割。显然，因为图只有一层，即每一个城市对应的点都直连源汇，所以每一个点要么断源，要么断汇。</span></p><p><span>显然断汇的点仍有能力向后面的城市流货，而断源的不能，所以写一个 DP 出来就完了。核心代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">j</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">i</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">dp</span>[<span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>][<span class="cm-variable">j</span>] <span class="cm-operator">=</span> <span class="cm-variable">dp</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>][<span class="cm-variable">j</span>] <span class="cm-operator">+</span> <span class="cm-variable">p</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-variable">j</span> <span class="cm-operator">*</span> <span class="cm-variable">m</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tmin</span>(<span class="cm-variable">dp</span>[<span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>][<span class="cm-variable">j</span>], <span class="cm-variable">dp</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>][<span class="cm-variable">j</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">+</span> <span class="cm-variable">s</span>[<span class="cm-variable">i</span>]);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><h2><a name="2-sat" class="md-header-anchor"></a><span>2-SAT</span></h2><p><span>记得我们曾经学过一个东西叫做“扩展域并查集”，说白了就是令每一坨 </span><span class='math-in-toc'>$[(k-1)\times n+1,k\times n]$</span><span> 的区间中的点 </span><span class='math-in-toc'>$i=(k-1)\times n+t$</span><span> 对应表示 </span><span class='math-in-toc'>$t$</span><span> 在 </span><span class='math-in-toc'>$k$</span><span> 状态下与别的状态的联系。两个点在一起就认为两个点对应的状态必定同时满足。</span></p><p><span>那这玩意这么好用，能不能用到 2-SAT 上呢？</span></p><p><span>很可惜，需要改一下题才能用得到。把或改成异或就行了。</span></p><p><span>思考一下并查集的底层逻辑：两个点对应的状态必定同时满足。换言之，你只能加双向边。</span></p><p><span>然而 2-SAT 并不是这样的，他用的是或，也就是说硬性的约束条件是：</span><span class='math-in-toc'>$x_i=\neg v_i\implies x_j=v_j$</span><span> 和 </span><span class='math-in-toc'>$x_j=\neg v_j\implies x_i=v_i$</span><span>。都是单向的约束。</span></p><p><span>那我们思考一下这些限制中的强连通分量意味着什么？</span></p><p><span>显然，这意味着这些点对应的状态成立与否是相同的。同时我们就推出了如果 </span><span class='math-in-toc'>$x_i$</span><span> 与 </span><span class='math-in-toc'>$\neg x_i$</span><span> 在同一个强连通分量内，那么必定无解。</span></p><p><span>强连通分量怎么求呢？Kosaraju 和 tarjan 你选一个吧。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">a</span>, <span class="cm-variable">b</span>, <span class="cm-variable">c</span>, <span class="cm-variable">d</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">a</span> <span class="cm-operator">=</span> <span class="cm-variable">io</span>.<span class="cm-variable">read</span>(), <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-variable">io</span>.<span class="cm-variable">read</span>(), <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">io</span>.<span class="cm-variable">read</span>(), <span class="cm-variable">d</span> <span class="cm-operator">=</span> <span class="cm-variable">io</span>.<span class="cm-variable">read</span>(),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">a</span> <span class="cm-operator">+</span> <span class="cm-variable">b</span> <span class="cm-operator">*</span> <span class="cm-variable">n</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">c</span> <span class="cm-operator">+</span> (<span class="cm-variable">d</span> <span class="cm-variable">^</span> <span class="cm-number">1</span>) <span class="cm-operator">*</span> <span class="cm-variable">n</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">c</span> <span class="cm-operator">+</span> <span class="cm-variable">d</span> <span class="cm-operator">*</span> <span class="cm-variable">n</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">a</span> <span class="cm-operator">+</span> (<span class="cm-variable">b</span> <span class="cm-variable">^</span> <span class="cm-number">1</span>) <span class="cm-operator">*</span> <span class="cm-variable">n</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//模板题约束条件示例</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><span>当然了，2-SAT 只是一个最直接的应用。其实他给我们提供的是一种单向限制的处理思路，适用性比 2-SAT 本身要更广很多。</span></p><p><span>顺带讲两个常用优化技巧：</span></p><h3><a name="线段树优化建图" class="md-header-anchor"></a><span>线段树优化建图</span></h3><p><span>T1</span><a href='https://www.luogu.com.cn/problem/AT_arc069_d'><span>rt</span></a><span>，</span><a href='https://www.luogu.com.cn/problem/UVA1146'><span>弱化版</span></a><span>。</span></p><p><span>翻译一下就是有 </span><span class='math-in-toc'>$n$</span><span> 个数 </span><span class='math-in-toc'>$a_i$</span><span> 和 </span><span class='math-in-toc'>$n$</span><span> 个数 </span><span class='math-in-toc'>$b_i$</span><span>，</span><span class='math-in-toc'>$n$</span><span> 次从 </span><span class='math-in-toc'>$a_i$</span><span> 或 </span><span class='math-in-toc'>$b_i$</span><span> 中选出一个数放入 </span><span class='math-in-toc'>$c$</span><span>，排序后询问最小的 </span><span class='math-in-toc'>$\min_{i=1}^{n-1}c_{i+1}-c_i$</span><span>。</span></p><p><span>我们可以假定 </span><span class='math-in-toc'>$a_i&lt;b_i$</span><span>。解法大概率会是二分答案。首先如果 </span><span class='math-in-toc'>$|a_j-a_i|&lt;d$</span><span>，那么这俩不能同时出现。以此来建边进行求解，复杂度 </span><span class='math-in-toc'>$O(n^2\log V)$</span><span>。可以过弱化版。</span></p><p><span>但是这样并不够优，究其原因是我们需要大量的向一个区间内的点建边。</span></p><p><span>而这，我们显然可以使用线段树优化建边来飞过去。具体方式可以看下面这幅图：</span></p><p><span>比如本来是 </span><span class='math-in-toc'>$2$</span><span> 要向 </span><span class='math-in-toc'>$[1,2]$</span><span> 和 </span><span class='math-in-toc'>$[4,6]$</span><span> 两个区间建边。</span></p><p><img src="https://www.helloimg.com/i/2025/04/25/680b7a4451dd4.png" referrerpolicy="no-referrer"></p><p><span>现在我们可以对原本的 </span><span class='math-in-toc'>$[1,6]$</span><span> 区间建一颗线段树如图：</span></p><p><img src="https://www.helloimg.com/i/2025/04/25/680b7a4f25685.png" referrerpolicy="no-referrer"></p><p><span>那这时候 </span><span class='math-in-toc'>$7$</span><span> 向 </span><span class='math-in-toc'>$8$</span><span> 连等同于向 </span><span class='math-in-toc'>$[1,2]$</span><span> 连，向 </span><span class='math-in-toc'>$11$</span><span> 连等同于向 </span><span class='math-in-toc'>$[4,6]$</span><span> 连。</span></p><p><span>显然这样下来每次要连的边数锐减至 </span><span class='math-in-toc'>$O(\log n)$</span><span> 条。总复杂度降至 </span><span class='math-in-toc'>$O(n\log n\log V)$</span><span>。</span></p><p><span>比较核心的就是这坨：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">seg_tree</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">struct</span> <span class="cm-def">node</span> { <span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable">r</span>; }<span class="cm-variable">re</span>[<span class="cm-number">10005</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">3</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">segid</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) { <span class="cm-keyword">return</span> <span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> <span class="cm-variable">n</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">build</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">l</span>; <span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">==</span> <span class="cm-variable">r</span>) <span class="cm-keyword">return</span> <span class="cm-variable-3">void</span>(<span class="cm-variable">son</span>[<span class="cm-variable">segid</span>(<span class="cm-variable">p</span>)].<span class="cm-variable">push_back</span>(<span class="cm-variable">ref</span>(<span class="cm-variable">a</span>[<span class="cm-variable">l</span>].<span class="cm-variable">id</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">build</span>(<span class="cm-variable">l</span>, (<span class="cm-variable">l</span> <span class="cm-operator">+</span> <span class="cm-variable">r</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>), <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">build</span>((<span class="cm-variable">l</span> <span class="cm-operator">+</span> <span class="cm-variable">r</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>) <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">segid</span>(<span class="cm-variable">p</span>)].<span class="cm-variable">push_back</span>(<span class="cm-variable">segid</span>(<span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">segid</span>(<span class="cm-variable">p</span>)].<span class="cm-variable">push_back</span>(<span class="cm-variable">segid</span>(<span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">link</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">lp</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">l</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">r</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">r</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable-3">void</span>(<span class="cm-variable">son</span>[<span class="cm-variable">lp</span>].<span class="cm-variable">push_back</span>(<span class="cm-variable">segid</span>(<span class="cm-variable">p</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">re</span>[<span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>].<span class="cm-variable">r</span>) <span class="cm-variable">link</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">lp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">r</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">re</span>[<span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>].<span class="cm-variable">r</span>) <span class="cm-variable">link</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">lp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">sgt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//注意只对区间连边有效</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 437px;"></div><div class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre><h3><a name="前缀优化建图" class="md-header-anchor"></a><span>前缀优化建图</span></h3><p><span>T2</span><a href='https://www.luogu.com.cn/problem/P6378'><span>rt</span></a><span>。</span></p><p><span>题意简单明了，转化也非常的明显，但是问题也就出在了这里。</span></p><p><span>相当于说在同一个部分内的 </span><span class='math-in-toc'>$x\neq y$</span><span>，一定要 </span><span class='math-in-toc'>$x_1$</span><span> 到 </span><span class='math-in-toc'>$y_0$</span><span> 连一条边。只要我把所有的点放在同一个部分内，你的边数就是 </span><span class='math-in-toc'>$n^2$</span><span> 的。包炸的。</span></p><p><span>所以现在就是要去优化这个东西。我们不难发现，其实如果我们将这个部分内的点任意排序，那第 </span><span class='math-in-toc'>$i$</span><span> 个点一定要向第 </span><span class='math-in-toc'>$[1,i-1]\cup[i+1,size]$</span><span> 都连上边。</span></p><p><span>线段树优化建图不太好使，因为数据范围真的够大。但是思考如下结构：</span></p><p><img src="https://www.helloimg.com/i/2025/04/25/680b44ed7af63.png" referrerpolicy="no-referrer"></p><p><span>不难注意到，如果我们给整个部分添加两个辅助的侧链</span><del><span>基团</span></del><span>，那么这时候指向 </span><span class='math-in-toc'>$x_l$</span><span> 就间接指向了 </span><span class='math-in-toc'>$[1,x]$</span><span>，指向 </span><span class='math-in-toc'>$x_r$</span><span> 就间接指向了 </span><span class='math-in-toc'>$[x,size]$</span><span>。</span></p><p><span>非常妙，此题可解。我们称这种建图方式为前缀优化建图。比较核心的代码就是这坨：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">sz</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">k</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-variable">sz</span> <span class="cm-operator">=</span> <span class="cm-variable">io</span>.<span class="cm-variable">read</span>();<span class="cm-variable">j</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>;<span class="cm-operator">--</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vl</span>[<span class="cm-variable">j</span>] <span class="cm-operator">=</span> <span class="cm-variable">io</span>.<span class="cm-variable">read</span>(),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_lp</span>)].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_0</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_rp</span>)].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_0</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">j</span> <span class="cm-operator">!=</span> <span class="cm-variable">sz</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_rp</span>)].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>], <span class="cm-variable">stat_rp</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_1</span>)].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>], <span class="cm-variable">stat_rp</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-variable">sz</span>;<span class="cm-variable">j</span> <span class="cm-operator">&gt;</span> <span class="cm-number">1</span>;<span class="cm-operator">--</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_lp</span>)].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>], <span class="cm-variable">stat_lp</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span>], <span class="cm-variable">stat_1</span>)].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">id</span>(<span class="cm-variable">vl</span>[<span class="cm-variable">j</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>], <span class="cm-variable">stat_lp</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 276px;"></div><div class="CodeMirror-gutters" style="display: none; height: 276px;"></div></div></div></pre><h1><a name="数据结构" class="md-header-anchor"></a><span>数据结构</span></h1><h2><a name="莫队" class="md-header-anchor"></a><span>莫队</span></h2><p><span>这绝对称得上是离线算法中的代表之一。话说，彼时的 </span><span class='math-in-toc'>$\text{OI}$</span><span> 界 </span><span class='math-in-toc'>$\text{RMQ}$</span><span> 问题并起，而我们的暴力却不能骗到太多分，于是 </span><span class='math-in-toc'>$\text{CF}$</span><span> 高手圈内流行起了一种快速处理离线问题的算法，并由莫涛整理，这种算法便被称之为莫队。后人便在此基础上加以拓展，统称为莫队算法。</span></p><p><span>算法的实现就是询问区间依靠 </span><span class='math-in-toc'>$l,r$</span><span> 指针反复横跳。他要求我们能够在较优的时间复杂度内（一般为 </span><span class='math-in-toc'>$O(1)$</span><span>）用 </span><span class='math-in-toc'>$[l,r]$</span><span> 的答案及状态转移出 </span><span class='math-in-toc'>$[l\pm1,r]$</span><span> 或 </span><span class='math-in-toc'>$[l,r\pm1]$</span><span> 的答案及状态。这时候，我们通过一定的方式找到一个较优的询问序列，使得其左右横跳的次数较为少。</span></p><p><span>这时候莫队的神奇重排询问方式发挥了作用。首先我们先这 </span><span class='math-in-toc'>$n$</span><span> 个点顺序平均分成 </span><span class='math-in-toc'>$\sqrt n$</span><span> 个块，然后询问间排序时以左端点所在的块编号为第一关键字，右端点为第二关键字。这时候，右端点右移距离不超过 </span><span class='math-in-toc'>$n\sqrt n$</span><span>，左端点移动次数在 </span><span class='math-in-toc'>$m\sqrt n$</span><span> 的级别控制内，均有不超过 </span><span class='math-in-toc'>$2$</span><span> 的理论常数（</span><del><span>像黑塔那样</span></del><span>左右乱滚）。于是总复杂度在 </span><span class='math-in-toc'>$O((n+m)\sqrt n)$</span><span>。</span></p><h3><a name="普通莫队" class="md-header-anchor"></a><span>普通莫队</span></h3><p><span>显然，上面的就是普通莫队。</span></p><p><span>以</span><a href='https://www.luogu.com.cn/problem/P1494'><span>袜子</span></a><span>为例，核心操作就是这样的：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">add</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ak</span> <span class="cm-operator">-=</span> <span class="cm-variable">get</span>(<span class="cm-variable">cnt</span>[<span class="cm-variable">a</span>[<span class="cm-variable">p</span>]]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cnt</span>[<span class="cm-variable">a</span>[<span class="cm-variable">p</span>]]<span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ak</span> <span class="cm-operator">+=</span> <span class="cm-variable">get</span>(<span class="cm-variable">cnt</span>[<span class="cm-variable">a</span>[<span class="cm-variable">p</span>]]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">del</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ak</span> <span class="cm-operator">-=</span> <span class="cm-variable">get</span>(<span class="cm-variable">cnt</span>[<span class="cm-variable">a</span>[<span class="cm-variable">p</span>]]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cnt</span>[<span class="cm-variable">a</span>[<span class="cm-variable">p</span>]]<span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ak</span> <span class="cm-operator">+=</span> <span class="cm-variable">get</span>(<span class="cm-variable">cnt</span>[<span class="cm-variable">a</span>[<span class="cm-variable">p</span>]]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span> (<span class="cm-variable">nr</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">r</span>) <span class="cm-variable">add</span>(<span class="cm-operator">++</span><span class="cm-variable">nr</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">nl</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">l</span>) <span class="cm-variable">add</span>(<span class="cm-operator">--</span><span class="cm-variable">nl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">nr</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">r</span>) <span class="cm-variable">del</span>(<span class="cm-variable">nr</span><span class="cm-operator">--</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">nl</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">l</span>) <span class="cm-variable">del</span>(<span class="cm-variable">nl</span><span class="cm-operator">++</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 322px;"></div><div class="CodeMirror-gutters" style="display: none; height: 322px;"></div></div></div></pre><p><span>特别注意，我们应尽量保证区间长度不为负，所以我们总是先扩展再收缩。</span></p><h3><a name="带修莫队" class="md-header-anchor"></a><span>带修莫队</span></h3><p><span>核心思路就是加上一维时间戳，因为 </span><span class='math-in-toc'>$l,r$</span><span> 同在 </span><span class='math-in-toc'>$[1,n]$</span><span> 的区间内，所以我们把 </span><span class='math-in-toc'>$l$</span><span> 的排序方式强加在 </span><span class='math-in-toc'>$r$</span><span> 上，然后 </span><span class='math-in-toc'>$t$</span><span> 按照原来 </span><span class='math-in-toc'>$r$</span><span> 的排序方式升序排序。当块长取 </span><span class='math-in-toc'>$\frac{n^{\frac{2}{3}}t^{\frac{1}{3}}}{m^{\frac{1}{3}}}$</span><span> 时时间复杂度为最优的 </span><span class='math-in-toc'>$O(n^{\frac{2}{3}}m^{\frac{2}{3}}t^{\frac{1}{3}})$</span><span>。但是一般情况下 </span><span class='math-in-toc'>$n,m,t$</span><span> 同阶，所以时间复杂度常被视为 </span><span class='math-in-toc'>$O(n^\frac{5}{3})$</span><span>。</span></p><p><span>带修莫队有他的局限性。只支持单点修改，时间复杂度也已经只比暴力优了 </span><span class='math-in-toc'>$n^\frac{1}{3}$</span><span>，可能要卡常。</span></p><h3><a name="回滚莫队" class="md-header-anchor"></a><span>回滚莫队</span></h3><p><span>回滚怎么滚？为什么要滚？问题很简单，有的信息在增加或删除的时候很难在一个能接受的时间复杂度内处理出来。于是，我们就只让他扩展。</span></p><p><span>具体的，我们暴力处理完块内的询问后，块间的我们让他的左端点固定在 </span><span class='math-in-toc'>$block_r+1$</span><span> 的位置，保持右端点单增，每到一个询问，记录当前的状态，让左端点扩展，到之后记录答案，然后快速滚回到 </span><span class='math-in-toc'>$block_r+1$</span><span>。</span></p><p><span>可以参见</span><a href='https://www.luogu.com.cn/problem/AT_joisc2014_c'><span>野史的研究</span></a><span>的代码。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">read</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-3">char</span> <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">getchar</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">c</span> <span class="cm-operator">&lt;</span> <span class="cm-string">'0'</span> <span class="cm-operator">||</span> <span class="cm-variable">c</span><span class="cm-operator">&gt;</span><span class="cm-string">'9'</span>) <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">getchar</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">c</span> <span class="cm-operator">&gt;=</span> <span class="cm-string">'0'</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">c</span> <span class="cm-operator">&lt;=</span> <span class="cm-string">'9'</span>) <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span> <span class="cm-operator">*</span> <span class="cm-number">10</span> <span class="cm-operator">+</span> (<span class="cm-variable">c</span> <span class="cm-variable">^</span> <span class="cm-number">48</span>), <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">getchar</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">write</span>(<span class="cm-variable-3">long</span> <span class="cm-variable-3">long</span> <span class="cm-variable">x</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">x</span> <span class="cm-operator">&gt;</span> <span class="cm-number">9</span>) <span class="cm-variable">write</span>(<span class="cm-variable">x</span> <span class="cm-operator">/</span> <span class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">putchar</span>(<span class="cm-variable">x</span> <span class="cm-operator">%</span> <span class="cm-number">10</span> <span class="cm-variable">^</span> <span class="cm-number">48</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">writi</span>(<span class="cm-variable-3">long</span> <span class="cm-variable-3">long</span> <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">write</span>(<span class="cm-variable">args</span>); <span class="cm-variable">putchar</span>(<span class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">node</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">q</span>[<span class="cm-number">100005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">v</span>[<span class="cm-number">100005</span>], <span class="cm-variable">sz</span>, <span class="cm-variable">tot</span>; <span class="cm-variable-3">long</span> <span class="cm-variable-3">long</span> <span class="cm-variable">ans</span>[<span class="cm-number">100005</span>], <span class="cm-variable">res</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">unordered_map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span>, <span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">tv</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">t</span>[<span class="cm-number">100005</span>], <span class="cm-variable">vlt</span>[<span class="cm-number">100005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define blk(x) (x/sz)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-def">cmp</span>(<span class="cm-keyword">const</span> <span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">l</span>, <span class="cm-keyword">const</span> <span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">blk</span>(<span class="cm-variable">l</span>.<span class="cm-variable">l</span>) <span class="cm-variable">^</span> <span class="cm-variable">blk</span>(<span class="cm-variable">r</span>.<span class="cm-variable">l</span>)) <span class="cm-keyword">return</span> <span class="cm-variable">blk</span>(<span class="cm-variable">l</span>.<span class="cm-variable">l</span>) <span class="cm-operator">&lt;</span> <span class="cm-variable">blk</span>(<span class="cm-variable">r</span>.<span class="cm-variable">l</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">l</span>.<span class="cm-variable">r</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">r</span>.<span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">add</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">t</span>[<span class="cm-variable">p</span>]<span class="cm-operator">++</span>; <span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>(<span class="cm-variable">res</span>, <span class="cm-variable">vlt</span>[<span class="cm-variable">p</span>] <span class="cm-operator">*</span> <span class="cm-number">1ll</span> <span class="cm-operator">*</span> <span class="cm-variable">t</span>[<span class="cm-variable">p</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">m</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(); <span class="cm-variable">sz</span> <span class="cm-operator">=</span> <span class="cm-variable">ceil</span>(<span class="cm-variable">sqrt</span>(<span class="cm-variable">m</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">read</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">tv</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tv</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]] <span class="cm-operator">=</span> <span class="cm-operator">++</span><span class="cm-variable">tot</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vlt</span>[<span class="cm-variable">tot</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">tv</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sort</span>(<span class="cm-variable">q</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">q</span> <span class="cm-operator">+</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">cmp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">k</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>;) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">pt</span> <span class="cm-operator">=</span> <span class="cm-variable">k</span>, <span class="cm-variable">rt</span>, <span class="cm-variable">lp</span>, <span class="cm-variable">rp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">pt</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">blk</span>(<span class="cm-variable">q</span>[<span class="cm-variable">pt</span>].<span class="cm-variable">l</span>) <span class="cm-operator">==</span> <span class="cm-variable">blk</span>(<span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">l</span>))<span class="cm-variable">pt</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rt</span> <span class="cm-operator">=</span> <span class="cm-variable">blk</span>(<span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">l</span>) <span class="cm-operator">*</span> <span class="cm-variable">sz</span> <span class="cm-operator">+</span> <span class="cm-variable">sz</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">k</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">pt</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">r</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">rt</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">id</span>, <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">l</span>, <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">l</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">r</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">add</span>(<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]); <span class="cm-variable">k</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ans</span>[<span class="cm-variable">id</span>] <span class="cm-operator">=</span> <span class="cm-variable">res</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">l</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">r</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)<span class="cm-variable">t</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]]<span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">rt</span>; <span class="cm-variable">rp</span> <span class="cm-operator">=</span> <span class="cm-variable">rt</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">k</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">pt</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">id</span>, <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">l</span>, <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">rp</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">r</span>) <span class="cm-variable">add</span>(<span class="cm-variable">v</span>[<span class="cm-operator">++</span><span class="cm-variable">rp</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">long</span> <span class="cm-variable-3">long</span> <span class="cm-variable">bak</span> <span class="cm-operator">=</span> <span class="cm-variable">res</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">lp</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">l</span>) <span class="cm-variable">add</span>(<span class="cm-variable">v</span>[<span class="cm-operator">--</span><span class="cm-variable">lp</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ans</span>[<span class="cm-variable">id</span>] <span class="cm-operator">=</span> <span class="cm-variable">res</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">lp</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">rt</span>) <span class="cm-variable">t</span>[<span class="cm-variable">v</span>[<span class="cm-variable">lp</span><span class="cm-operator">++</span>]]<span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-variable">bak</span>; <span class="cm-variable">k</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">t</span>, <span class="cm-number">0</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">t</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">writi</span>(<span class="cm-variable">ans</span>[<span class="cm-variable">i</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1518px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1518px;"></div></div></div></pre><h3><a name="树上莫队" class="md-header-anchor"></a><span>树上莫队</span></h3><p><span>经典的序列问题上树。处理方式无非就两种：把树拍成序列；重链剖分吃掉这棵树。很显然，对于莫对这种喜欢</span><del><span>像黑塔那样</span></del><span>左右乱滚的神奇算法来说，第一个方式会更友善一些。</span></p><p><span>最终，我们选择了欧拉序，即进子树记录一次，出子树记录一次。这样子，我们可以通过一个点在序列中出现的次数轻松的知道他到底在不在序列上。</span></p><p><span>一般的，我们会将其拆成 </span><span class='math-in-toc'>$[l,lca]$</span><span> 和 </span><span class='math-in-toc'>$[lca,r]$</span><span> 两条链来处理。由于欧拉序的特殊性，对于不满足一者在另一者的子树内时，我们需要记录 </span><span class='math-in-toc'>$lca$</span><span>。</span></p><p><span>然后就是类似于普通莫队的思路了。下面给一个</span><a href='https://www.luogu.com.cn/problem/SP10707'><span>树上莫队</span></a><span>的代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">namespace</span> <span class="cm-def">indata</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">v</span>[<span class="cm-number">100005</span>], <span class="cm-variable">tot</span>, <span class="cm-variable">l2g</span>[<span class="cm-number">40005</span>], <span class="cm-variable">ans</span>[<span class="cm-number">100005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">unordered_map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span>, <span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">um</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">lsh</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">um</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]]) <span class="cm-variable">um</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]] <span class="cm-operator">=</span> <span class="cm-operator">++</span><span class="cm-variable">tot</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">um</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">getlog2</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l2g</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">l2g</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">+</span> (<span class="cm-number">1</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">l2g</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">==</span> <span class="cm-variable">i</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-variable">indata::n</span>; <span class="cm-keyword">using</span> <span class="cm-variable">indata::m</span>; <span class="cm-keyword">using</span> <span class="cm-variable">indata::v</span>; <span class="cm-keyword">using</span> <span class="cm-variable">indata::l2g</span>; <span class="cm-keyword">using</span> <span class="cm-variable">indata::ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">namespace</span> <span class="cm-def">tree</span> { <span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">getlca</span>(<span class="cm-variable-3">int</span>, <span class="cm-variable-3">int</span>); };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">namespace</span> <span class="cm-def">mque</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">olq</span>[<span class="cm-number">80005</span>], <span class="cm-variable">tot</span>, <span class="cm-variable">fp</span>[<span class="cm-number">40005</span>], <span class="cm-variable">lp</span>[<span class="cm-number">40005</span>], <span class="cm-variable">sz</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">bool</span> <span class="cm-variable">st</span>[<span class="cm-number">40005</span>];;<span class="cm-variable-3">int</span> <span class="cm-variable">cnt</span>[<span class="cm-number">40005</span>], <span class="cm-variable">res</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">struct</span> <span class="cm-def">node</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">p</span>, <span class="cm-variable">id</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}<span class="cm-variable">q</span>[<span class="cm-number">100005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">inque</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">a</span>, <span class="cm-variable">b</span>, <span class="cm-variable">lcp</span>; <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">a</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">b</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">fp</span>[<span class="cm-variable">a</span>] <span class="cm-operator">&gt;</span> <span class="cm-variable">fp</span>[<span class="cm-variable">b</span>]) <span class="cm-variable">swap</span>(<span class="cm-variable">a</span>, <span class="cm-variable">b</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">lcp</span> <span class="cm-operator">=</span> <span class="cm-variable">tree::getlca</span>(<span class="cm-variable">a</span>, <span class="cm-variable">b</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">a</span> <span class="cm-operator">==</span> <span class="cm-variable">lcp</span>) <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">i</span>, <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">fp</span>[<span class="cm-variable">a</span>], <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">fp</span>[<span class="cm-variable">b</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">i</span>, <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span>[<span class="cm-variable">a</span>], <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">fp</span>[<span class="cm-variable">b</span>], <span class="cm-variable">q</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">lcp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//cerr &lt;&lt; i &lt;&lt; " query " &lt;&lt; q[i].l &lt;&lt; " to " &lt;&lt; q[i].r </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//<span class="cm-tab" role="presentation" cm-text="	">  </span>&lt;&lt; " special " &lt;&lt; q[i].p &lt;&lt; endl;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">blk</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">x</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">x</span> <span class="cm-operator">/</span> <span class="cm-variable">sz</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-def">cmp</span>(<span class="cm-keyword">const</span> <span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">l</span>, <span class="cm-keyword">const</span> <span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">blk</span>(<span class="cm-variable">l</span>.<span class="cm-variable">l</span>) <span class="cm-variable">^</span> <span class="cm-variable">blk</span>(<span class="cm-variable">r</span>.<span class="cm-variable">l</span>)) <span class="cm-keyword">return</span> <span class="cm-variable">blk</span>(<span class="cm-variable">l</span>.<span class="cm-variable">l</span>) <span class="cm-operator">&lt;</span> <span class="cm-variable">blk</span>(<span class="cm-variable">r</span>.<span class="cm-variable">l</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">l</span>.<span class="cm-variable">r</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">r</span>.<span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">add</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//cerr &lt;&lt; "add " &lt;&lt; p &lt;&lt; " val " &lt;&lt; v[p] &lt;&lt; endl;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">st</span>[<span class="cm-variable">p</span>] <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">st</span>[<span class="cm-variable">p</span>]) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cnt</span>[<span class="cm-variable">v</span>[<span class="cm-variable">p</span>]]<span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">cnt</span>[<span class="cm-variable">v</span>[<span class="cm-variable">p</span>]]) <span class="cm-variable">res</span><span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">cnt</span>[<span class="cm-variable">v</span>[<span class="cm-variable">p</span>]]) <span class="cm-variable">res</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cnt</span>[<span class="cm-variable">v</span>[<span class="cm-variable">p</span>]]<span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">solve</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">k</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">k</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">id</span>, <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">l</span>, <span class="cm-variable">rp</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">r</span>, <span class="cm-variable">np</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>[<span class="cm-variable">k</span>].<span class="cm-variable">p</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">r</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">rp</span>) <span class="cm-variable">add</span>(<span class="cm-variable">olq</span>[<span class="cm-operator">++</span><span class="cm-variable">r</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">r</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">rp</span>) <span class="cm-variable">add</span>(<span class="cm-variable">olq</span>[<span class="cm-variable">r</span><span class="cm-operator">--</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">l</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lp</span>) <span class="cm-variable">add</span>(<span class="cm-variable">olq</span>[<span class="cm-variable">l</span><span class="cm-operator">++</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">l</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">lp</span>) <span class="cm-variable">add</span>(<span class="cm-variable">olq</span>[<span class="cm-operator">--</span><span class="cm-variable">l</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">np</span>) <span class="cm-variable">add</span>(<span class="cm-variable">np</span>); <span class="cm-variable">ans</span>[<span class="cm-variable">id</span>] <span class="cm-operator">=</span> <span class="cm-variable">res</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">np</span>) <span class="cm-variable">add</span>(<span class="cm-variable">np</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-variable">mque::olq</span>; <span class="cm-keyword">using</span> <span class="cm-variable">mque::q</span>; <span class="cm-keyword">using</span> <span class="cm-variable">mque::lp</span>; <span class="cm-keyword">using</span> <span class="cm-variable">mque::fp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">namespace</span> <span class="cm-def">tree</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">son</span>[<span class="cm-number">40005</span>]; <span class="cm-variable-3">int</span> <span class="cm-variable">a</span>, <span class="cm-variable">b</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">dep</span>[<span class="cm-number">40005</span>], <span class="cm-variable">fa</span>[<span class="cm-number">40005</span>][<span class="cm-number">16</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">in_tree</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-variable">^</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">a</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">b</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">a</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">b</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">b</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">a</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">dfs</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">pos</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">fap</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fa</span>[<span class="cm-variable">pos</span>][<span class="cm-number">0</span>] <span class="cm-operator">=</span> <span class="cm-variable">fap</span>; <span class="cm-variable">dep</span>[<span class="cm-variable">pos</span>] <span class="cm-operator">=</span> <span class="cm-variable">dep</span>[<span class="cm-variable">fap</span>] <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">l2g</span>[<span class="cm-variable">dep</span>[<span class="cm-variable">pos</span>]]; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fa</span>[<span class="cm-variable">pos</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">fa</span>[<span class="cm-variable">pos</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">olq</span>[<span class="cm-operator">++</span><span class="cm-variable">mque::tot</span>] <span class="cm-operator">=</span> <span class="cm-variable">pos</span>; <span class="cm-variable">fp</span>[<span class="cm-variable">pos</span>] <span class="cm-operator">=</span> <span class="cm-variable">mque::tot</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">son</span>[<span class="cm-variable">pos</span>].<span class="cm-variable">size</span>(); <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">son</span>[<span class="cm-variable">pos</span>][<span class="cm-variable">i</span>] <span class="cm-operator">!=</span> <span class="cm-variable">fap</span>) <span class="cm-variable">dfs</span>(<span class="cm-variable">son</span>[<span class="cm-variable">pos</span>][<span class="cm-variable">i</span>], <span class="cm-variable">pos</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">olq</span>[<span class="cm-operator">++</span><span class="cm-variable">mque::tot</span>] <span class="cm-operator">=</span> <span class="cm-variable">pos</span>; <span class="cm-variable">lp</span>[<span class="cm-variable">pos</span>] <span class="cm-operator">=</span> <span class="cm-variable">mque::tot</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">getlca</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">lp</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">rp</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lp</span> <span class="cm-operator">==</span> <span class="cm-variable">rp</span>) <span class="cm-keyword">return</span> <span class="cm-variable">lp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">dep</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">dep</span>[<span class="cm-variable">rp</span>]) <span class="cm-variable">swap</span>(<span class="cm-variable">lp</span>, <span class="cm-variable">rp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">dep</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">&gt;</span> <span class="cm-variable">dep</span>[<span class="cm-variable">rp</span>]) <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">l2g</span>[<span class="cm-variable">dep</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">-</span> <span class="cm-variable">dep</span>[<span class="cm-variable">rp</span>]] <span class="cm-operator">-</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lp</span> <span class="cm-operator">==</span> <span class="cm-variable">rp</span>) <span class="cm-keyword">return</span> <span class="cm-variable">lp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-variable">l2g</span>[<span class="cm-variable">dep</span>[<span class="cm-variable">lp</span>]] <span class="cm-operator">-</span> <span class="cm-number">1</span>; <span class="cm-variable">k</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>; <span class="cm-variable">k</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">fa</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">k</span>] <span class="cm-operator">!=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">rp</span>][<span class="cm-variable">k</span>]) <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">lp</span>][<span class="cm-variable">k</span>], <span class="cm-variable">rp</span> <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">rp</span>][<span class="cm-variable">k</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">fa</span>[<span class="cm-variable">lp</span>][<span class="cm-number">0</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cin</span>.<span class="cm-variable">tie</span>(<span class="cm-number">0</span>); <span class="cm-variable">cout</span>.<span class="cm-variable">tie</span>(<span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">n</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">m</span>; <span class="cm-variable">indata::getlog2</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">indata::lsh</span>(); <span class="cm-variable">tree::in_tree</span>(); <span class="cm-variable">tree::dfs</span>(<span class="cm-number">1</span>, <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//for (int i = 1; i &lt;= mque::tot; ++i) cerr &lt;&lt; olq[i] &lt;&lt; " "; cerr &lt;&lt; endl;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">mque::inque</span>(); <span class="cm-variable">mque::sz</span> <span class="cm-operator">=</span> <span class="cm-variable">ceil</span>(<span class="cm-variable">sqrt</span>(<span class="cm-number">2</span> <span class="cm-operator">*</span> <span class="cm-variable">n</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sort</span>(<span class="cm-variable">q</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">q</span> <span class="cm-operator">+</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">mque::cmp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">mque::solve</span>(); <span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">ans</span>[<span class="cm-variable">i</span>] <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2461px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2461px;"></div></div></div></pre><h2><a name="笛卡尔树" class="md-header-anchor"></a><span>笛卡尔树</span></h2><p><span>笛卡尔树是一种二叉树，每一个节点由一个键值二元组 </span><span class='math-in-toc'>$(k,w)$</span><span> 构成。要求 </span><span class='math-in-toc'>$k$</span><span> 满足二叉搜索树的性质，而 </span><span class='math-in-toc'>$w$</span><span> 满足堆的性质。一般我们会需要构造一个笛卡尔树，编号为 </span><span class='math-in-toc'>$i$</span><span> 的点权值为 </span><span class='math-in-toc'>$(i,a_i)$</span><span>，</span><span class='math-in-toc'>$a_i$</span><span> 为给定的值。一般用栈解决。方法如下：</span></p><p><span>我们先按照下标顺序依次加入这棵树中，显然，为了维护二叉搜索树的性质，这个节点势必会在树的右链上。</span></p><p><span>这时候我们维护其堆的性质就行了。从下往上比较右链节点与当前节点 </span><span class='math-in-toc'>$u$</span><span> 的 </span><span class='math-in-toc'>$w$</span><span>，如果找到了一个右链上的节点 </span><span class='math-in-toc'>$x$</span><span> 满足 </span><span class='math-in-toc'>$w_x&lt;w_u$</span><span>，就把 </span><span class='math-in-toc'>$u$</span><span> 接到 </span><span class='math-in-toc'>$x$</span><span> 的右儿子上，而 </span><span class='math-in-toc'>$x$</span><span> 原本的右子树就变成 </span><span class='math-in-toc'>$u$</span><span> 的左子树。</span></p><p><span>复杂度线性。可能视情况会需要树上 </span><span class='math-in-toc'>$DP$</span><span>，四毛子等。</span></p><h2><a name="树套树" class="md-header-anchor"></a><span>树套树</span></h2><p><span>首先给出警告：树套树时空常数大，代码复杂，一定要静下来调，线段树中不要记录当前节点的区间端点，在函数中下传！</span></p><p><span>其实修正一个对树套树的认知错误：树套树实际上只有最内层在维护实际有效信息，外层只是为了减少内层维护次数，从而降低复杂度，而不做信息的合并。</span></p><p><span>在这基础之上，就不容易出错了。主要补充一些技巧。其中第二个板块有树套树的参考代码。</span></p><h3><a name="线段树二分树状数组倍增" class="md-header-anchor"></a><span>线段树二分/树状数组倍增</span></h3><p><span>前者就是线段树上二分。因为线段树是分治型结构，所以复杂度单 </span><span class='math-in-toc'>$\log$</span><span>。方法就是在每一个节点选择往左/右子树走。</span></p><p><span>后者如其名，因为树状数组是倍增型结构，所以复杂度单 </span><span class='math-in-toc'>$\log$</span><span>。方法就是跳 </span><span class='math-in-toc'>$2^n$</span><span> 个，</span><span class='math-in-toc'>$n$</span><span> 越来越小。这时候，前面的贡献不会被重复统计，达到效果。</span></p><h3><a name="多树二分" class="md-header-anchor"></a><span>多树二分</span></h3><p><span>不难注意到，在树套树</span><a href='https://www.luogu.com.cn/problem/P3380'><span>模板题</span></a><span>中，我给出了如下代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>; <span class="cm-keyword">using</span> <span class="cm-variable">cir</span> <span class="cm-operator">=</span> <span class="cm-keyword">const</span> <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">read</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-3">char</span> <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">getchar</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">c</span> <span class="cm-operator">&lt;</span> <span class="cm-string">'0'</span> <span class="cm-operator">||</span> <span class="cm-variable">c</span><span class="cm-operator">&gt;</span><span class="cm-string">'9'</span>) <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">getchar</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">c</span> <span class="cm-operator">&gt;=</span> <span class="cm-string">'0'</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">c</span> <span class="cm-operator">&lt;=</span> <span class="cm-string">'9'</span>) <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span> <span class="cm-operator">*</span> <span class="cm-number">10</span> <span class="cm-operator">+</span> (<span class="cm-variable">c</span> <span class="cm-variable">^</span> <span class="cm-number">48</span>), <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">getchar</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">write</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">x</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">x</span> <span class="cm-operator">&gt;</span> <span class="cm-number">9</span>) <span class="cm-variable">write</span>(<span class="cm-variable">x</span> <span class="cm-operator">/</span> <span class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">putchar</span>(<span class="cm-variable">x</span> <span class="cm-operator">%</span> <span class="cm-number">10</span> <span class="cm-variable">^</span> <span class="cm-number">48</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">writi</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">args</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) <span class="cm-variable">args</span> <span class="cm-operator">=</span> <span class="cm-variable">~args</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">putchar</span>(<span class="cm-string">'-'</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">write</span>(<span class="cm-variable">args</span>); <span class="cm-variable">putchar</span>(<span class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">v</span>[<span class="cm-number">50005</span>], <span class="cm-variable">o</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">bal_node</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">v</span>, <span class="cm-variable">sz</span>, <span class="cm-variable">rv</span>, <span class="cm-variable">lc</span>, <span class="cm-variable">rc</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">re</span>[<span class="cm-number">10000005</span>]; <span class="cm-variable-3">int</span> <span class="cm-variable">cnt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//inline int max(cir l, cir r) { return l &gt; r ? l : r; }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//inline int min(cir l, cir r) { return l &lt; r ? l : r; }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">bal_tree</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">rt</span>, <span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>, <span class="cm-variable">r3</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">pup</span>(<span class="cm-variable">cir</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">sz</span> <span class="cm-operator">=</span> <span class="cm-variable">re</span>[<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">lc</span>].<span class="cm-variable">sz</span> <span class="cm-operator">+</span> <span class="cm-variable">re</span>[<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">rc</span>].<span class="cm-variable">sz</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">blyat</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">v</span>, <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">p</span>) { <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-keyword">return</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">v</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">v</span>) <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">p</span>, <span class="cm-variable">blyat</span>(<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">lc</span>, <span class="cm-variable">v</span>, <span class="cm-variable">l</span>, <span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">lc</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">p</span>, <span class="cm-variable">blyat</span>(<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">rc</span>, <span class="cm-variable">v</span>, <span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">rc</span>, <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pup</span>(<span class="cm-variable">p</span>); <span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">merge</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">l</span> <span class="cm-operator">||</span> <span class="cm-operator">!</span><span class="cm-variable">r</span>) <span class="cm-keyword">return</span> <span class="cm-variable">l</span> <span class="cm-operator">|</span> <span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">re</span>[<span class="cm-variable">l</span>].<span class="cm-variable">rv</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">re</span>[<span class="cm-variable">r</span>].<span class="cm-variable">rv</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">re</span>[<span class="cm-variable">l</span>].<span class="cm-variable">rc</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">re</span>[<span class="cm-variable">l</span>].<span class="cm-variable">rc</span>, <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pup</span>(<span class="cm-variable">l</span>); <span class="cm-keyword">return</span> <span class="cm-variable">l</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">re</span>[<span class="cm-variable">r</span>].<span class="cm-variable">lc</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">l</span>, <span class="cm-variable">re</span>[<span class="cm-variable">r</span>].<span class="cm-variable">lc</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pup</span>(<span class="cm-variable">r</span>); <span class="cm-keyword">return</span> <span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">newn</span>(<span class="cm-variable">cir</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">++</span><span class="cm-variable">cnt</span>; <span class="cm-variable">re</span>[<span class="cm-variable">cnt</span>].<span class="cm-variable">rv</span> <span class="cm-operator">=</span> <span class="cm-variable">rand</span>(); <span class="cm-variable">re</span>[<span class="cm-variable">cnt</span>].<span class="cm-variable">sz</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">re</span>[<span class="cm-variable">cnt</span>].<span class="cm-variable">v</span> <span class="cm-operator">=</span> <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">cnt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">ins</span>(<span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">blyat</span>(<span class="cm-variable">rt</span>, <span class="cm-variable">vl</span>, <span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>); <span class="cm-variable">rt</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">r1</span>, <span class="cm-variable">merge</span>(<span class="cm-variable">newn</span>(<span class="cm-variable">vl</span>), <span class="cm-variable">r2</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">del</span>(<span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">blyat</span>(<span class="cm-variable">rt</span>, <span class="cm-variable">vl</span>, <span class="cm-variable">r1</span>, <span class="cm-variable">r3</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">blyat</span>(<span class="cm-variable">r1</span>, <span class="cm-variable">vl</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>, <span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">r2</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">re</span>[<span class="cm-variable">r2</span>].<span class="cm-variable">lc</span>, <span class="cm-variable">re</span>[<span class="cm-variable">r2</span>].<span class="cm-variable">rc</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rt</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">merge</span>(<span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>), <span class="cm-variable">r3</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">build</span>(<span class="cm-variable">cir</span> <span class="cm-variable">l</span>, <span class="cm-variable">cir</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">l</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">r</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">ins</span>(<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">getrk</span>(<span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">blyat</span>(<span class="cm-variable">rt</span>, <span class="cm-variable">vl</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>, <span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-variable">re</span>[<span class="cm-variable">r1</span>].<span class="cm-variable">sz</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rt</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">fndrk</span>(<span class="cm-variable">cir</span> <span class="cm-variable">p</span>, <span class="cm-variable">cir</span> <span class="cm-variable">rk</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rk</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">re</span>[<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">lc</span>].<span class="cm-variable">sz</span>) <span class="cm-keyword">return</span> <span class="cm-variable">fndrk</span>(<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">lc</span>, <span class="cm-variable">rk</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rk</span> <span class="cm-operator">==</span> <span class="cm-variable">re</span>[<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">lc</span>].<span class="cm-variable">sz</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>) <span class="cm-keyword">return</span> <span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">fndrk</span>(<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">rc</span>, <span class="cm-variable">rk</span> <span class="cm-operator">-</span> <span class="cm-variable">re</span>[<span class="cm-variable">re</span>[<span class="cm-variable">p</span>].<span class="cm-variable">lc</span>].<span class="cm-variable">sz</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">prev</span>(<span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">blyat</span>(<span class="cm-variable">rt</span>, <span class="cm-variable">vl</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>, <span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>); <span class="cm-variable-3">int</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">re</span>[<span class="cm-variable">r1</span>].<span class="cm-variable">sz</span>) <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-variable">fndrk</span>(<span class="cm-variable">r1</span>, <span class="cm-variable">re</span>[<span class="cm-variable">r1</span>].<span class="cm-variable">sz</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable">INT_MAX</span>; <span class="cm-variable">rt</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">next</span>(<span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">blyat</span>(<span class="cm-variable">rt</span>, <span class="cm-variable">vl</span>, <span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>); <span class="cm-variable-3">int</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">re</span>[<span class="cm-variable">r2</span>].<span class="cm-variable">sz</span>) <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-variable">fndrk</span>(<span class="cm-variable">r2</span>, <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-variable">INT_MAX</span>; <span class="cm-variable">rt</span> <span class="cm-operator">=</span> <span class="cm-variable">merge</span>(<span class="cm-variable">r1</span>, <span class="cm-variable">r2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">bt</span>[<span class="cm-number">50005</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">2</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define mid (l + r &gt;&gt; 1)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">bal_seg_tree</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">build</span>(<span class="cm-variable">cir</span> <span class="cm-variable">l</span>, <span class="cm-variable">cir</span> <span class="cm-variable">r</span>, <span class="cm-variable">cir</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">bt</span>[<span class="cm-variable">p</span>].<span class="cm-variable">build</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>); <span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">==</span> <span class="cm-variable">r</span>) <span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">build</span>(<span class="cm-variable">l</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>); <span class="cm-variable">build</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">getrk</span>(<span class="cm-variable">cir</span> <span class="cm-variable">l</span>, <span class="cm-variable">cir</span> <span class="cm-variable">r</span>, <span class="cm-variable">cir</span> <span class="cm-variable">p</span>, <span class="cm-variable">cir</span> <span class="cm-variable">sl</span>, <span class="cm-variable">cir</span> <span class="cm-variable">sr</span>, <span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sl</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">l</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">r</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">sr</span>) <span class="cm-keyword">return</span> <span class="cm-variable">bt</span>[<span class="cm-variable">p</span>].<span class="cm-variable">getrk</span>(<span class="cm-variable">vl</span>) <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sl</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">mid</span>) <span class="cm-variable">ret</span> <span class="cm-operator">+=</span> <span class="cm-variable">getrk</span>(<span class="cm-variable">l</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>, <span class="cm-variable">sl</span>, <span class="cm-variable">sr</span>, <span class="cm-variable">vl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sr</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">mid</span>) <span class="cm-variable">ret</span> <span class="cm-operator">+=</span> <span class="cm-variable">getrk</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>, <span class="cm-variable">sl</span>, <span class="cm-variable">sr</span>, <span class="cm-variable">vl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ret</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">fndrk</span>(<span class="cm-variable">cir</span> <span class="cm-variable">l</span>, <span class="cm-variable">cir</span> <span class="cm-variable">r</span>, <span class="cm-variable">cir</span> <span class="cm-variable">rk</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">rp</span> <span class="cm-operator">=</span> <span class="cm-number">1e8</span>, <span class="cm-variable">mv</span>, <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">lp</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">rp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">getrk</span>(<span class="cm-number">1</span>, <span class="cm-variable">n</span>, <span class="cm-number">1</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, (<span class="cm-variable">mv</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span> <span class="cm-operator">+</span> <span class="cm-variable">rp</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>)) <span class="cm-operator">&lt;</span> <span class="cm-variable">rk</span>) <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-variable">mv</span>, <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">mv</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">rp</span> <span class="cm-operator">=</span> <span class="cm-variable">mv</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">chg</span>(<span class="cm-variable">cir</span> <span class="cm-variable">l</span>, <span class="cm-variable">cir</span> <span class="cm-variable">r</span>, <span class="cm-variable">cir</span> <span class="cm-variable">p</span>, <span class="cm-variable">cir</span> <span class="cm-variable">cp</span>, <span class="cm-variable">cir</span> <span class="cm-variable">cv</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">bt</span>[<span class="cm-variable">p</span>].<span class="cm-variable">del</span>(<span class="cm-variable">v</span>[<span class="cm-variable">cp</span>]); <span class="cm-variable">bt</span>[<span class="cm-variable">p</span>].<span class="cm-variable">ins</span>(<span class="cm-variable">cv</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">!=</span> <span class="cm-variable">r</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">cp</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">mid</span>) <span class="cm-variable">chg</span>(<span class="cm-variable">l</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">cv</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">chg</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">cv</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">prev</span>(<span class="cm-variable">cir</span> <span class="cm-variable">l</span>, <span class="cm-variable">cir</span> <span class="cm-variable">r</span>, <span class="cm-variable">cir</span> <span class="cm-variable">p</span>, <span class="cm-variable">cir</span> <span class="cm-variable">sl</span>, <span class="cm-variable">cir</span> <span class="cm-variable">sr</span>, <span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">r</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">sl</span> <span class="cm-operator">||</span> <span class="cm-variable">sr</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">l</span>) <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-variable">INT_MAX</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sl</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">l</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">r</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">sr</span>) <span class="cm-keyword">return</span> <span class="cm-variable">bt</span>[<span class="cm-variable">p</span>].<span class="cm-variable">prev</span>(<span class="cm-variable">vl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">max</span>(<span class="cm-variable">prev</span>(<span class="cm-variable">l</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>, <span class="cm-variable">sl</span>, <span class="cm-variable">sr</span>, <span class="cm-variable">vl</span>), <span class="cm-variable">prev</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>, <span class="cm-variable">sl</span>, <span class="cm-variable">sr</span>, <span class="cm-variable">vl</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">next</span>(<span class="cm-variable">cir</span> <span class="cm-variable">l</span>, <span class="cm-variable">cir</span> <span class="cm-variable">r</span>, <span class="cm-variable">cir</span> <span class="cm-variable">p</span>, <span class="cm-variable">cir</span> <span class="cm-variable">sl</span>, <span class="cm-variable">cir</span> <span class="cm-variable">sr</span>, <span class="cm-variable">cir</span> <span class="cm-variable">vl</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">r</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">sl</span> <span class="cm-operator">||</span> <span class="cm-variable">sr</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">l</span>) <span class="cm-keyword">return</span> <span class="cm-variable">INT_MAX</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sl</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">l</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">r</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">sr</span>) <span class="cm-keyword">return</span> <span class="cm-variable">bt</span>[<span class="cm-variable">p</span>].<span class="cm-variable">next</span>(<span class="cm-variable">vl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">min</span>(<span class="cm-variable">next</span>(<span class="cm-variable">l</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>, <span class="cm-variable">sl</span>, <span class="cm-variable">sr</span>, <span class="cm-variable">vl</span>), <span class="cm-variable">next</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>, <span class="cm-variable">sl</span>, <span class="cm-variable">sr</span>, <span class="cm-variable">vl</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">bst</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">map</span><span class="cm-operator">&lt;</span><span class="cm-variable">tuple</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span>, <span class="cm-variable-3">int</span>, <span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span>, <span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">ans</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(); <span class="cm-variable">m</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(); <span class="cm-variable">srand</span>((<span class="cm-variable-3">unsigned</span>)<span class="cm-variable">time</span>(<span class="cm-number">0</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">read</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">bst</span>.<span class="cm-variable">build</span>(<span class="cm-number">1</span>, <span class="cm-variable">n</span>, <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">m</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">o</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">o</span> <span class="cm-operator">==</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">writi</span>(<span class="cm-variable">bst</span>.<span class="cm-variable">getrk</span>(<span class="cm-number">1</span>, <span class="cm-variable">n</span>, <span class="cm-number">1</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>) <span class="cm-operator">+</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">o</span> <span class="cm-operator">==</span> <span class="cm-number">2</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">ans</span>.<span class="cm-variable">count</span>(<span class="cm-variable">make_tuple</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">writi</span>(<span class="cm-variable">ans</span>[<span class="cm-variable">make_tuple</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>)]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">writi</span>(<span class="cm-variable">ans</span>[<span class="cm-variable">make_tuple</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>)] <span class="cm-operator">=</span> <span class="cm-variable">bst</span>.<span class="cm-variable">fndrk</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">o</span> <span class="cm-operator">==</span> <span class="cm-number">3</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">bst</span>.<span class="cm-variable">chg</span>(<span class="cm-number">1</span>, <span class="cm-variable">n</span>, <span class="cm-number">1</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">l</span>] <span class="cm-operator">=</span> <span class="cm-variable">r</span>, <span class="cm-variable">ans</span>.<span class="cm-variable">clear</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">o</span> <span class="cm-operator">==</span> <span class="cm-number">4</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">writi</span>(<span class="cm-variable">bst</span>.<span class="cm-variable">prev</span>(<span class="cm-number">1</span>, <span class="cm-variable">n</span>, <span class="cm-number">1</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(), <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">writi</span>(<span class="cm-variable">bst</span>.<span class="cm-variable">next</span>(<span class="cm-number">1</span>, <span class="cm-variable">n</span>, <span class="cm-number">1</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">k</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3473px;"></div><div class="CodeMirror-gutters" style="display: none; height: 3473px;"></div></div></div></pre><p><span>那么请看第 </span><span class='math-in-toc'>$135$</span><span> 到 </span><span class='math-in-toc'>$137$</span><span> 行，这一部分就是为了防被卡。仔细看会发现这个操作是 </span><span class='math-in-toc'>$O(\log^3n)$</span><span> 的。这时候就需要多树二分了。</span></p><p><span>多树二分，一句话说，就是将会涉及到的线段树树上的节点给全部放一起，然后一起二分。这时候，节点个数是 </span><span class='math-in-toc'>$\log$</span><span> 级别，二分是 </span><span class='math-in-toc'>$\log$</span><span> 的，整体双 </span><span class='math-in-toc'>$\log$</span><span>。以 lby 的代码作为实现思路：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">getkth</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">r</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">k</span>){</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">id</span>.<span class="cm-variable">clear</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">find</span>(<span class="cm-variable">l</span>,<span class="cm-variable">r</span>);<span class="cm-comment">//找到树 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">x</span><span class="cm-operator">=</span><span class="cm-number">0</span>,<span class="cm-variable">y</span><span class="cm-operator">=</span><span class="cm-number">1e8</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">node</span><span class="cm-operator">*&gt;</span><span class="cm-variable">pt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-variable">id</span>.<span class="cm-variable">size</span>();<span class="cm-variable">i</span><span class="cm-operator">++</span>) <span class="cm-variable">pt</span>.<span class="cm-variable">push_back</span>(<span class="cm-variable">t</span>[<span class="cm-variable">id</span>[<span class="cm-variable">i</span>]].<span class="cm-variable">root</span>);<span class="cm-comment">//提出树根 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">k</span><span class="cm-operator">==</span><span class="cm-number">0</span>) <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">2147483647</span>;<span class="cm-comment">//特判边界 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">r</span><span class="cm-operator">-</span><span class="cm-variable">l</span><span class="cm-operator">+</span><span class="cm-number">1</span><span class="cm-operator">&lt;</span><span class="cm-variable">k</span>) <span class="cm-keyword">return</span> <span class="cm-number">2147483647</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span>(<span class="cm-variable">x</span><span class="cm-operator">!=</span><span class="cm-variable">y</span>){<span class="cm-comment">//线段树二分 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">sum</span><span class="cm-operator">=</span><span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-variable">id</span>.<span class="cm-variable">size</span>();<span class="cm-variable">i</span><span class="cm-operator">++</span>) <span class="cm-variable">sum</span><span class="cm-operator">+=</span><span class="cm-variable">pt</span>[<span class="cm-variable">i</span>]<span class="cm-operator">-&gt;</span><span class="cm-variable">l</span><span class="cm-operator">-&gt;</span><span class="cm-variable">val</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">mid</span><span class="cm-operator">=</span><span class="cm-variable">x</span><span class="cm-operator">+</span><span class="cm-variable">y</span><span class="cm-operator">&gt;&gt;</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">k</span><span class="cm-operator">&gt;</span><span class="cm-variable">sum</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">k</span><span class="cm-operator">-=</span><span class="cm-variable">sum</span>,<span class="cm-variable">x</span><span class="cm-operator">=</span><span class="cm-variable">mid</span><span class="cm-operator">+</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-variable">id</span>.<span class="cm-variable">size</span>();<span class="cm-variable">i</span><span class="cm-operator">++</span>) <span class="cm-variable">pt</span>[<span class="cm-variable">i</span>]<span class="cm-operator">=</span><span class="cm-variable">pt</span>[<span class="cm-variable">i</span>]<span class="cm-operator">-&gt;</span><span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">y</span><span class="cm-operator">=</span><span class="cm-variable">mid</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-variable">id</span>.<span class="cm-variable">size</span>();<span class="cm-variable">i</span><span class="cm-operator">++</span>) <span class="cm-variable">pt</span>[<span class="cm-variable">i</span>]<span class="cm-operator">=</span><span class="cm-variable">pt</span>[<span class="cm-variable">i</span>]<span class="cm-operator">-&gt;</span><span class="cm-variable">l</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 529px;"></div><div class="CodeMirror-gutters" style="display: none; height: 529px;"></div></div></div></pre><h2><a name="严格次小生成树" class="md-header-anchor"></a><span>严格次小生成树</span></h2><p><span>还挺简单的，能直接口胡出思路来，就是建出最小生成树，然后在上面换边。只涉及到了倍增和最小生成树相关的。给出相对简短的实现：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define int long long</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">node</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">node</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">pi</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">vi</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>) :<span class="cm-variable">p</span>(<span class="cm-variable">pi</span>), <span class="cm-variable">v</span>(<span class="cm-variable">vi</span>) {};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}; <span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">node</span><span class="cm-operator">&gt;</span><span class="cm-variable">son</span>[<span class="cm-number">100005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">edge</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable">r</span>, <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">edge</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">li</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">ri</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">vi</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>) :</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span>(<span class="cm-variable">li</span>), <span class="cm-variable">r</span>(<span class="cm-variable">ri</span>), <span class="cm-variable">v</span>(<span class="cm-variable">vi</span>) {};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">friend</span> <span class="cm-variable-3">bool</span> <span class="cm-keyword">operator</span><span class="cm-operator">&lt;</span>(<span class="cm-keyword">const</span> <span class="cm-variable">edge</span><span class="cm-operator">&amp;</span> <span class="cm-variable">l</span>, <span class="cm-keyword">const</span> <span class="cm-variable">edge</span><span class="cm-operator">&amp;</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">l</span>.<span class="cm-variable">v</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">r</span>.<span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">et</span>; <span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">edge</span><span class="cm-operator">&gt;</span><span class="cm-variable">e</span>; <span class="cm-variable">bitset</span><span class="cm-operator">&lt;</span><span class="cm-number">300005</span><span class="cm-operator">&gt;</span><span class="cm-variable">vis</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">f</span>[<span class="cm-number">100005</span>], <span class="cm-variable">cn</span>, <span class="cm-variable">mav</span>[<span class="cm-number">100005</span>][<span class="cm-number">18</span>], <span class="cm-variable">nmv</span>[<span class="cm-number">100005</span>][<span class="cm-number">18</span>], <span class="cm-variable">dep</span>[<span class="cm-number">100005</span>], <span class="cm-variable">lg</span>[<span class="cm-number">100005</span>], <span class="cm-variable">fa</span>[<span class="cm-number">100005</span>][<span class="cm-number">18</span>], <span class="cm-variable">msz</span>, <span class="cm-variable">ap</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">find</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">f</span>[<span class="cm-variable">p</span>] <span class="cm-operator">!=</span> <span class="cm-variable">p</span> <span class="cm-operator">?</span> <span class="cm-variable">f</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">find</span>(<span class="cm-variable">f</span>[<span class="cm-variable">p</span>]) : <span class="cm-variable">p</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-def">merge</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">find</span>(<span class="cm-variable">l</span>), <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">find</span>(<span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">==</span> <span class="cm-variable">r</span>) <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">f</span>[<span class="cm-variable">l</span>] <span class="cm-operator">=</span> <span class="cm-variable">r</span>; <span class="cm-keyword">return</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">dfs</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">f</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">dep</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">dep</span>[<span class="cm-variable">f</span>] <span class="cm-operator">+</span> <span class="cm-number">1</span>; <span class="cm-variable">mav</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>; <span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>] <span class="cm-operator">=</span> <span class="cm-variable">f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">lg</span>[<span class="cm-variable">dep</span>[<span class="cm-variable">p</span>]]; <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">mav</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">max</span>(<span class="cm-variable">mav</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>], <span class="cm-variable">mav</span>[<span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">mav</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">==</span> <span class="cm-variable">mav</span>[<span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">nmv</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">max</span>(<span class="cm-variable">nmv</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>], <span class="cm-variable">nmv</span>[<span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">nmv</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">min</span>(<span class="cm-variable">mav</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>], <span class="cm-variable">mav</span>[<span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]][<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-keyword">const</span> <span class="cm-variable">node</span><span class="cm-operator">&amp;</span> <span class="cm-variable">sp</span> : <span class="cm-variable">son</span>[<span class="cm-variable">p</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sp</span>.<span class="cm-variable">p</span> <span class="cm-operator">!=</span> <span class="cm-variable">f</span>) <span class="cm-variable">dfs</span>(<span class="cm-variable">sp</span>.<span class="cm-variable">p</span>, <span class="cm-variable">p</span>, <span class="cm-variable">sp</span>.<span class="cm-variable">v</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">getlca</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">dep</span>[<span class="cm-variable">l</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">dep</span>[<span class="cm-variable">r</span>]) <span class="cm-variable">swap</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">17</span>; <span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">dep</span>[<span class="cm-variable">fa</span>[<span class="cm-variable">l</span>][<span class="cm-variable">i</span>]] <span class="cm-operator">&gt;=</span> <span class="cm-variable">dep</span>[<span class="cm-variable">r</span>]) <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">l</span>][<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">==</span> <span class="cm-variable">r</span>) <span class="cm-keyword">return</span> <span class="cm-variable">l</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">17</span>; <span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">fa</span>[<span class="cm-variable">l</span>][<span class="cm-variable">i</span>] <span class="cm-operator">!=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">r</span>][<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">l</span>][<span class="cm-variable">i</span>], <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">r</span>][<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">fa</span>[<span class="cm-variable">l</span>][<span class="cm-number">0</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">getmv</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">d</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">lim</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">mit</span>; <span class="cm-variable">mit</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1e9</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">17</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">d</span> <span class="cm-operator">&amp;</span> (<span class="cm-number">1ll</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">i</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">mav</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-operator">!=</span> <span class="cm-variable">lim</span>) <span class="cm-variable">mit</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>(<span class="cm-variable">mit</span>, <span class="cm-variable">mav</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">mit</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>(<span class="cm-variable">mit</span>, <span class="cm-variable">nmv</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>]); <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">fa</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">mit</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>); <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">n</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">m</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">a</span>, <span class="cm-variable">b</span>, <span class="cm-variable">c</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">a</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">b</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">c</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">e</span>.<span class="cm-variable">emplace_back</span>(<span class="cm-variable">edge</span>(<span class="cm-variable">a</span>, <span class="cm-variable">b</span>, <span class="cm-variable">c</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">f</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">i</span>, <span class="cm-variable">lg</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">lg</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">+</span> (<span class="cm-number">1ll</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">lg</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">==</span> <span class="cm-variable">i</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sort</span>(<span class="cm-variable">e</span>.<span class="cm-variable">begin</span>(), <span class="cm-variable">e</span>.<span class="cm-variable">end</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">e</span>.<span class="cm-variable">size</span>(); <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">cn</span> <span class="cm-operator">==</span> <span class="cm-variable">n</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>) <span class="cm-keyword">break</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">et</span> <span class="cm-operator">=</span> <span class="cm-variable">e</span>[<span class="cm-variable">i</span>], <span class="cm-variable">merge</span>(<span class="cm-variable">et</span>.<span class="cm-variable">l</span>, <span class="cm-variable">et</span>.<span class="cm-variable">r</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cn</span><span class="cm-operator">++</span>, <span class="cm-variable">msz</span> <span class="cm-operator">+=</span> <span class="cm-variable">et</span>.<span class="cm-variable">v</span>, <span class="cm-variable">vis</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">et</span>.<span class="cm-variable">l</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">node</span>(<span class="cm-variable">et</span>.<span class="cm-variable">r</span>, <span class="cm-variable">et</span>.<span class="cm-variable">v</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">son</span>[<span class="cm-variable">et</span>.<span class="cm-variable">r</span>].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">node</span>(<span class="cm-variable">et</span>.<span class="cm-variable">l</span>, <span class="cm-variable">et</span>.<span class="cm-variable">v</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">nmv</span>, <span class="cm-number">0xcf</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">nmv</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">dfs</span>(<span class="cm-number">1</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>); <span class="cm-variable">ap</span> <span class="cm-operator">=</span> <span class="cm-number">0x3f3f3f3f3f3f3f3f</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">e</span>.<span class="cm-variable">size</span>(); <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">vis</span>[<span class="cm-variable">i</span>]) <span class="cm-keyword">continue</span>; <span class="cm-variable">et</span> <span class="cm-operator">=</span> <span class="cm-variable">e</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">et</span>.<span class="cm-variable">l</span> <span class="cm-operator">==</span> <span class="cm-variable">et</span>.<span class="cm-variable">r</span>) <span class="cm-keyword">continue</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">getlca</span>(<span class="cm-variable">et</span>.<span class="cm-variable">l</span>, <span class="cm-variable">et</span>.<span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>(<span class="cm-variable">getmv</span>(<span class="cm-variable">et</span>.<span class="cm-variable">l</span>, <span class="cm-variable">dep</span>[<span class="cm-variable">et</span>.<span class="cm-variable">l</span>] <span class="cm-operator">-</span> <span class="cm-variable">dep</span>[<span class="cm-variable">lp</span>], <span class="cm-variable">et</span>.<span class="cm-variable">v</span>), <span class="cm-variable">getmv</span>(<span class="cm-variable">et</span>.<span class="cm-variable">r</span>, <span class="cm-variable">dep</span>[<span class="cm-variable">et</span>.<span class="cm-variable">r</span>] <span class="cm-operator">-</span> <span class="cm-variable">dep</span>[<span class="cm-variable">lp</span>], <span class="cm-variable">et</span>.<span class="cm-variable">v</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">val</span> <span class="cm-operator">&gt;</span> <span class="cm-operator">-</span><span class="cm-number">1e9</span>) <span class="cm-variable">ap</span> <span class="cm-operator">=</span> <span class="cm-variable">min</span>(<span class="cm-variable">ap</span>, <span class="cm-variable">et</span>.<span class="cm-variable">v</span> <span class="cm-operator">-</span> <span class="cm-variable">val</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">msz</span> <span class="cm-operator">+</span> <span class="cm-variable">ap</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1863px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1863px;"></div></div></div></pre><h2><a name="整体二分" class="md-header-anchor"></a><span>整体二分</span></h2><p><span>正如其名字，我们将所有的询问放到一起来二分，这样可以节省中间重复的判断的时间。思路很简单，结合题目去想一下能不能高效维护就是了。</span></p><p><a href='https://www.luogu.com.cn/problem/P3527'><span>例题</span></a><span>核心代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">solve</span>(<span class="cm-keyword">const</span> <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">la</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">ra</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">lq</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">rq</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">la</span> <span class="cm-operator">==</span> <span class="cm-variable">ra</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">lq</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">rq</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">ans</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">la</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">mid</span> <span class="cm-operator">=</span> <span class="cm-variable">la</span> <span class="cm-operator">+</span> <span class="cm-variable">ra</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>, <span class="cm-variable">c1</span>(<span class="cm-number">0</span>), <span class="cm-variable">c2</span>(<span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">la</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">mid</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ta</span>.<span class="cm-variable">add</span>(<span class="cm-variable">l</span>[<span class="cm-variable">i</span>], <span class="cm-variable">c</span>[<span class="cm-variable">i</span>]), <span class="cm-variable">ta</span>.<span class="cm-variable">add</span>(<span class="cm-variable">r</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-variable">c</span>[<span class="cm-variable">i</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">lq</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">rq</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">tv</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">sp</span> : <span class="cm-variable">son</span>[<span class="cm-variable">v</span>[<span class="cm-variable">i</span>].<span class="cm-variable">p</span>]) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tv</span> <span class="cm-operator">+=</span> <span class="cm-variable">ta</span>.<span class="cm-variable">que</span>(<span class="cm-variable">sp</span>) <span class="cm-operator">+</span> <span class="cm-variable">ta</span>.<span class="cm-variable">que</span>(<span class="cm-variable">sp</span> <span class="cm-operator">+</span> <span class="cm-variable">m</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">tv</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>].<span class="cm-variable">v</span>) <span class="cm-keyword">break</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">tv</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>].<span class="cm-variable">v</span>) <span class="cm-variable">ql</span>[<span class="cm-operator">++</span><span class="cm-variable">c1</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>].<span class="cm-variable">v</span> <span class="cm-operator">-=</span> <span class="cm-variable">tv</span>, <span class="cm-variable">qr</span>[<span class="cm-operator">++</span><span class="cm-variable">c2</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">la</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">mid</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ta</span>.<span class="cm-variable">add</span>(<span class="cm-variable">l</span>[<span class="cm-variable">i</span>], <span class="cm-operator">-</span><span class="cm-variable">c</span>[<span class="cm-variable">i</span>]), <span class="cm-variable">ta</span>.<span class="cm-variable">add</span>(<span class="cm-variable">r</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">c</span>[<span class="cm-variable">i</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">c1</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">v</span>[<span class="cm-variable">lq</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-variable">ql</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">c2</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">v</span>[<span class="cm-variable">lq</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span> <span class="cm-operator">+</span> <span class="cm-variable">c1</span>] <span class="cm-operator">=</span> <span class="cm-variable">qr</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">solve</span>(<span class="cm-variable">la</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">lq</span>, <span class="cm-variable">lq</span> <span class="cm-operator">+</span> <span class="cm-variable">c1</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">solve</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">ra</span>, <span class="cm-variable">lq</span> <span class="cm-operator">+</span> <span class="cm-variable">c1</span>, <span class="cm-variable">rq</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 552px;"></div><div class="CodeMirror-gutters" style="display: none; height: 552px;"></div></div></div></pre><p><span>只是题必须满足以下性质：</span></p><ol start='' ><li><span>询问的答案具有可二分性</span></li><li><span>修改对判定答案的贡献互相独立，修改之间互不影响效果</span></li><li><span>修改如果对判定答案有贡献，则贡献为一确定的与判定标准无关的值</span></li><li><span>贡献满足交换律，结合律，具有可加性</span></li><li><span>题目允许使用离线算法</span></li></ol><h2><a name="cdq分治" class="md-header-anchor"></a><span>CDQ分治</span></h2><p><span>CDQ 分治其实更像是一种思想。CDQ本身处理的是三维偏序问题，即满足 </span><span class='math-in-toc'>$a_i&lt;a_j,b_i&lt;b_j,c_i&lt;c_j$</span><span> 的整数对 </span><span class='math-in-toc'>$(i,j)$</span><span> 的个数。</span></p><p><span>这个东西，一看就可以 KDTree（大雾）。</span></p><p><span>显然不优，CDQ 可以做到 </span><span class='math-in-toc'>$O(n\log^2n)$</span><span>。</span></p><p><span>核心思路就是先按照第一维排序，随后归并排第二维的序列。归并的时候，左部点仍然满足 </span><span class='math-in-toc'>$a$</span><span> 比右部点小。此时我们依次归并 </span><span class='math-in-toc'>$b$</span><span>，当 </span><span class='math-in-toc'>$b$</span><span> 来自右部点是计算比该点 </span><span class='math-in-toc'>$c$</span><span> 值更小的已归并的数量之和，这可以用树状数组快速维护。</span></p><p><span>求解完成。</span><a href='https://www.luogu.com.cn/problem/P3810'><span>模板题</span></a><span>核心代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">solve</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">lp</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">rp</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lp</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">rp</span>) <span class="cm-keyword">return</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">mid</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span> <span class="cm-operator">+</span> <span class="cm-variable">rp</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">solve</span>(<span class="cm-variable">lp</span>, <span class="cm-variable">mid</span>); <span class="cm-variable">solve</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">rp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">lt</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span>, <span class="cm-variable">rt</span> <span class="cm-operator">=</span> <span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">ip</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span>; <span class="cm-variable">ip</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">rp</span>; <span class="cm-operator">++</span><span class="cm-variable">ip</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rt</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">rp</span> <span class="cm-operator">||</span> <span class="cm-variable">lt</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">mid</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">v</span>[<span class="cm-variable">lt</span>].<span class="cm-variable">b</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">v</span>[<span class="cm-variable">rt</span>].<span class="cm-variable">b</span>) <span class="cm-variable">ta</span>.<span class="cm-variable">ins</span>(<span class="cm-variable">v</span>[<span class="cm-variable">lt</span>].<span class="cm-variable">c</span>, <span class="cm-variable">v</span>[<span class="cm-variable">lt</span>].<span class="cm-variable">cnt</span>), <span class="cm-variable">tmp</span>[<span class="cm-variable">ip</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">lt</span><span class="cm-operator">++</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">v</span>[<span class="cm-variable">rt</span>].<span class="cm-variable">ret</span> <span class="cm-operator">+=</span> <span class="cm-variable">ta</span>.<span class="cm-variable">que</span>(<span class="cm-variable">v</span>[<span class="cm-variable">rt</span>].<span class="cm-variable">c</span>), <span class="cm-variable">tmp</span>[<span class="cm-variable">ip</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">rt</span><span class="cm-operator">++</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">mid</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">ta</span>.<span class="cm-variable">ins</span>(<span class="cm-variable">v</span>[<span class="cm-variable">i</span>].<span class="cm-variable">c</span>, <span class="cm-operator">-</span><span class="cm-variable">v</span>[<span class="cm-variable">i</span>].<span class="cm-variable">cnt</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">rp</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">tmp</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><span>可以求解类似</span><a href='https://www.luogu.com.cn/problem/P3157'><span>动态逆序对</span></a><span>，</span><a href='https://www.luogu.com.cn/problem/P2163'><span>二维数点</span></a><span>等的部分问题。</span></p><h2><a name="zkw线段树" class="md-header-anchor"></a><span>ZKW线段树</span></h2><p><span>很神奇的卡常用的线段树，但是支持面远远比不上普通线段树。</span></p><p><span>思路就是更改递归为循环。我们可以注意到，在线段树中，</span><span class='math-in-toc'>$fa_i=\lfloor\frac{i}{2}\rfloor$</span><span>，因此，我们维护一个数组，使其也满足这样的性质，每次循环向上更新信息，就完成了。</span></p><p><span>查询的时候我们从区间的左右部分的端点外的一点开始操作。对于一个端点，当我们向内跳的时候，统计右儿子的贡献，当向外跳的时候，不统计贡献，直到两端点重合。</span></p><p><span>但是区间修改使用标记永久化，无法维护标记有顺序要求的情况。</span></p><p><span>参考代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define lc(i) (i &lt;&lt; 1)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define rc(i) (i &lt;&lt; 1 | 1)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">a</span>[<span class="cm-number">2000005</span>], <span class="cm-variable">s</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">ins</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">do</span> <span class="cm-variable">a</span>[<span class="cm-variable">p</span>] <span class="cm-operator">+=</span> <span class="cm-variable">v</span>; <span class="cm-keyword">while</span> (<span class="cm-variable">p</span> <span class="cm-operator">&gt;&gt;=</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">que</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">v</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-keyword">do</span> <span class="cm-variable">v</span> <span class="cm-operator">+=</span> (<span class="cm-variable">~l</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span> <span class="cm-operator">?</span> <span class="cm-variable">a</span>[<span class="cm-variable">l</span> <span class="cm-variable">^</span> <span class="cm-number">1</span>] : <span class="cm-number">0</span>) <span class="cm-operator">+</span> (<span class="cm-variable">r</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span> <span class="cm-operator">?</span> <span class="cm-variable">a</span>[<span class="cm-variable">r</span> <span class="cm-variable">^</span> <span class="cm-number">1</span>] : <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> ((<span class="cm-variable">l</span> <span class="cm-operator">&gt;&gt;=</span> <span class="cm-number">1</span>) <span class="cm-variable">^</span> (<span class="cm-variable">r</span> <span class="cm-operator">&gt;&gt;=</span> <span class="cm-number">1</span>) <span class="cm-variable">^</span> <span class="cm-number">1</span>); <span class="cm-keyword">return</span> <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>); <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">n</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">m</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable">s</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">s</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;<span class="cm-variable">s</span> <span class="cm-operator">&lt;&lt;=</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">a</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-variable">s</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">s</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">--</span>) <span class="cm-variable">a</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">a</span>[<span class="cm-variable">lc</span>(<span class="cm-variable">i</span>)] <span class="cm-operator">+</span> <span class="cm-variable">a</span>[<span class="cm-variable">rc</span>(<span class="cm-variable">i</span>)];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">o</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">o</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">l</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">r</span>, <span class="cm-variable">o</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>) <span class="cm-variable">ins</span>(<span class="cm-variable">l</span> <span class="cm-operator">+</span> <span class="cm-variable">s</span>, <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">que</span>(<span class="cm-variable">l</span> <span class="cm-operator">+</span> <span class="cm-variable">s</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>, <span class="cm-variable">r</span> <span class="cm-operator">+</span> <span class="cm-variable">s</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>) <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 483px;"></div><div class="CodeMirror-gutters" style="display: none; height: 483px;"></div></div></div></pre><h2><a name="李超线段树lichaotree" class="md-header-anchor"></a><span>李超线段树(</span><span class='math-in-toc'>$L_iC_{hao}T_{ree}$</span><span>)</span></h2><p><span>要求在平面直角坐标系下维护两个操作：</span></p><ol start='' ><li><span>在平面上加入一条线段。记第 </span><span class='math-in-toc'>$i$</span><span> 条被插入的线段的标号为 </span><span class='math-in-toc'>$i$</span><span>。</span></li><li><span>给定一个数 </span><span class='math-in-toc'>$k$</span><span>，询问与直线 </span><span class='math-in-toc'>$x=k$</span><span> 相交的线段中，交点纵坐标最大的线段的编号。</span></li></ol><p><span>我们发现，传统的线段树无法很好地维护这样的信息。这种情况下，</span><strong><span>李超线段树</span></strong><span>便应运而生。</span></p><p><span>区间修改，最常见的办法就是给每个节点一个懒标记。对于每个区间，维护在 </span><span class='math-in-toc'>$m=\frac{l+r}{2}$</span><span> 处取值最大的直线的信息。</span></p><p><span>现在我们需要插入一条线段 </span><span class='math-in-toc'>$f$</span><span>，在这条线段完整覆盖的线段树节点代表的区间中，某些区间的最优线段可能发生改变。</span></p><p><span>考虑某个被新线段 </span><span class='math-in-toc'>$f$</span><span> 完整覆盖的区间，若该区间无最优线段，则该线段可以直接成为最优线段。</span></p><p><span>否则，设该区间的中点为 </span><span class='math-in-toc'>$m$</span><span>，我们拿新线段 </span><span class='math-in-toc'>$f$</span><span> 在中点处的值与原最优线段 </span><span class='math-in-toc'>$g$</span><span> 在中点处的值作比较。</span></p><p><span>如果新线段 </span><span class='math-in-toc'>$f$</span><span> 更优，则将 </span><span class='math-in-toc'>$f$</span><span> 和 </span><span class='math-in-toc'>$g$</span><span> 交换。那么现在考虑在中点处 </span><span class='math-in-toc'>$f$</span><span> 不如 </span><span class='math-in-toc'>$g$</span><span> 优的情况：</span></p><ol start='' ><li><span>若在左端点处 </span><span class='math-in-toc'>$f$</span><span> 更优，那么 </span><span class='math-in-toc'>$f$</span><span> 和 </span><span class='math-in-toc'>$g$</span><span> 必然在左半区间中产生了交点，递归到左儿子中进行插入；</span></li><li><span>若在右端点处 </span><span class='math-in-toc'>$f$</span><span> 更优，那么 </span><span class='math-in-toc'>$f$</span><span> 和 </span><span class='math-in-toc'>$g$</span><span> 必然在右半区间中产生了交点，递归到右儿子中进行插入。</span></li><li><span>若在左右端点处 </span><span class='math-in-toc'>$g$</span><span> 都更优，那么 </span><span class='math-in-toc'>$f$</span><span> 不可能成为答案，不需要继续下传。</span></li></ol><p><span>由于仅有一个交点，所以两边子区间最多会递归一个。复杂度 </span><span class='math-in-toc'>$O(\log n)$</span><span>。但是需要注意，因为每一次我们都需要对全覆盖的区间都进行修改，而这样的区间是 </span><span class='math-in-toc'>$\log$</span><span> 级别的，因此单次修改的复杂度为 </span><span class='math-in-toc'>$O(\log^2n)$</span><span>。</span></p><p><span>查询 </span><span class='math-in-toc'>$x=k$</span><span> 答案时，从根走到 </span><span class='math-in-toc'>$[x,x]$</span><span> 节点记录的所有最优直线在 </span><span class='math-in-toc'>$x=k$</span><span> 时取值的答案极值即为所求。这里是运用了</span><strong><span>标记永久化</span></strong><span>的思想。查询的复杂度就为 </span><span class='math-in-toc'>$O(\log n)$</span><span>。</span></p><p><span>特别需要注意，对于不优的三种情况的讨论中，如果二者在端点同样优，那么一定要视为 </span><span class='math-in-toc'>$g$</span><span> 更优。这样才能保证对于两个重复的线段不会一直走 </span><span class='math-in-toc'>$3$</span><span> 操作，从而导致时复错误。</span></p><p><span>核心代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">constexpr</span> <span class="cm-variable-3">double</span> <span class="cm-variable">eps</span> <span class="cm-operator">=</span> <span class="cm-number">1e</span><span class="cm-operator">-</span><span class="cm-number">9</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-def">cmp</span>(<span class="cm-variable-3">double</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">double</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">l</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">r</span> <span class="cm-operator">+</span> <span class="cm-variable">eps</span>) <span class="cm-keyword">return</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">r</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">l</span> <span class="cm-operator">+</span> <span class="cm-variable">eps</span>) <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">double</span> <span class="cm-def">quep</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">id</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">x</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">l</span>[<span class="cm-variable">id</span>].<span class="cm-variable">b</span> <span class="cm-operator">+</span> <span class="cm-variable">l</span>[<span class="cm-variable">id</span>].<span class="cm-variable">k</span> <span class="cm-operator">*</span> <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">chg_intv</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">nl</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">nr</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">cp</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-variable">ans</span>[<span class="cm-variable">p</span>], <span class="cm-variable">mid</span> <span class="cm-operator">=</span> <span class="cm-variable">nl</span> <span class="cm-operator">+</span> <span class="cm-variable">nr</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">ty</span> <span class="cm-operator">=</span> <span class="cm-variable">cmp</span>(<span class="cm-variable">quep</span>(<span class="cm-variable">cp</span>, <span class="cm-variable">mid</span>), <span class="cm-variable">quep</span>(<span class="cm-variable">lp</span>, <span class="cm-variable">mid</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">ty</span> <span class="cm-operator">==</span> <span class="cm-number">1</span> <span class="cm-operator">||</span> <span class="cm-operator">!</span><span class="cm-variable">ty</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">cp</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lp</span>) <span class="cm-variable">swap</span>(<span class="cm-variable">cp</span>, <span class="cm-variable">lp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">lcn</span> <span class="cm-operator">=</span> <span class="cm-variable">cmp</span>(<span class="cm-variable">quep</span>(<span class="cm-variable">cp</span>, <span class="cm-variable">nl</span>), <span class="cm-variable">quep</span>(<span class="cm-variable">lp</span>, <span class="cm-variable">nl</span>)), <span class="cm-variable">rcn</span> <span class="cm-operator">=</span> <span class="cm-variable">cmp</span>(<span class="cm-variable">quep</span>(<span class="cm-variable">cp</span>, <span class="cm-variable">nr</span>), <span class="cm-variable">quep</span>(<span class="cm-variable">lp</span>, <span class="cm-variable">nr</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lcn</span> <span class="cm-operator">==</span> <span class="cm-number">1</span> <span class="cm-operator">||</span> <span class="cm-operator">!</span><span class="cm-variable">lcn</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">cp</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lp</span>) <span class="cm-variable">chg_intv</span>(<span class="cm-variable">nl</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rcn</span> <span class="cm-operator">==</span> <span class="cm-number">1</span> <span class="cm-operator">||</span> <span class="cm-operator">!</span><span class="cm-variable">rcn</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">cp</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lp</span>) <span class="cm-variable">chg_intv</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">nr</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">fnd_intv</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">nl</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">nr</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">cl</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">cr</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">cp</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">nl</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">cl</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">nr</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">cr</span>) <span class="cm-keyword">return</span> <span class="cm-variable">chg_intv</span>(<span class="cm-variable">nl</span>, <span class="cm-variable">nr</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">mid</span> <span class="cm-operator">=</span> <span class="cm-variable">nl</span> <span class="cm-operator">+</span> <span class="cm-variable">nr</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">cl</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">mid</span>) <span class="cm-variable">fnd_intv</span>(<span class="cm-variable">nl</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">cl</span>, <span class="cm-variable">cr</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">cr</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">mid</span>) <span class="cm-variable">fnd_intv</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">nr</span>, <span class="cm-variable">cl</span>, <span class="cm-variable">cr</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable">pode</span> <span class="cm-def">que</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">nl</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">nr</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">cp</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">nr</span><span class="cm-operator">&lt;</span><span class="cm-variable">cp</span> <span class="cm-operator">||</span> <span class="cm-variable">nl</span><span class="cm-operator">&gt;</span><span class="cm-variable">cp</span>) <span class="cm-keyword">return</span> <span class="cm-variable">pode</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">mid</span> <span class="cm-operator">=</span> <span class="cm-variable">nl</span> <span class="cm-operator">+</span> <span class="cm-variable">nr</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>; <span class="cm-variable-3">double</span> <span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-variable">quep</span>(<span class="cm-variable">ans</span>[<span class="cm-variable">p</span>], <span class="cm-variable">cp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">nl</span> <span class="cm-operator">==</span> <span class="cm-variable">nr</span>) <span class="cm-keyword">return</span> <span class="cm-variable">pode</span>(<span class="cm-variable">val</span>, <span class="cm-variable">ans</span>[<span class="cm-variable">p</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">max</span>(<span class="cm-variable">pode</span>(<span class="cm-variable">val</span>, <span class="cm-variable">ans</span>[<span class="cm-variable">p</span>]),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">que</span>(<span class="cm-variable">nl</span>, <span class="cm-variable">mid</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">que</span>(<span class="cm-variable">mid</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">nr</span>, <span class="cm-variable">cp</span>, <span class="cm-variable">p</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span> <span class="cm-operator">|</span> <span class="cm-number">1</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 736px;"></div><div class="CodeMirror-gutters" style="display: none; height: 736px;"></div></div></div></pre><p><span>Q1:为什么一定要在路径上取 </span><span class='math-in-toc'>$\max$</span><span> 而不是一直走到底，返回最底部的状态？</span></p><p><span>标记永久化。</span></p><p><span>实际上，对于一条线段，他在中点最优常常意味着他在全局都是比较优的。尤其是对于第一次存入的区间。</span></p><p><span>也就是说，对于相当大的一部分线段，他其实是整个区间的子区间的最优解。但是如果真的更改整个子树，其复杂度退化为 </span><span class='math-in-toc'>$O(n)$</span><span>。</span></p><p><span>所以说，与其更改整个子树，不如直接标记永久化，最后再在这些</span><strong><span>可能的最大值</span></strong><span>中刨出真正的最大值。</span></p><p><span>Q2:李超线段树合并细节？</span></p><p><span>其实不难想象，对于李超线段树这种有永久化标记的树，其合并方式不太一样。</span></p><p><span>不过，对于同一层，其实我们只需要将其中一个的最优线段合并到另一个当中，然后递归合并就行了。</span></p><p><span>特别需要注意一点，对于</span><a href='https://www.luogu.com.cn/problem/CF932F'><span>【模板】李超树合并</span></a><span>，其时间复杂度实际上是 </span><span class='math-in-toc'>$O(n\log n)$</span><span> 的。这一点可用势能分析得出。参见第一篇题解，非常玄妙。连</span><a href='https://codeforces.com/blog/entry/57796'><span>官方题解</span></a><span>都分析错了。</span></p><p><span>典型应用：</span></p><ol start='' ><li><span>优化 DP，也就是动态维护斜率优化 DP 的凸包，支持任意地方插入。</span></li><li><span>李超线段树合并，主要也是优化 DP，主要是在对于整个子树的最优信息的合并。</span></li></ol><p><span>例题：</span><a href='https://www.luogu.com.cn/problem/P4097'><span>T0:P4097,省选/NOI-,模板题</span></a><span>；</span><a href='https://www.luogu.com.cn/problem/P4254'><span>T1:P4254,省选/NOI-,模板题</span></a><span>；</span><a href='https://www.luogu.com.cn/problem/P4655'><span>T2:P4655,省选/NOI-</span></a><span>；</span><a href='https://www.luogu.com.cn/problem/CF932F'><span>T3:CF932F,省选/NOI-</span></a><span>；</span><a href='https://www.luogu.com.cn/problem/P4069'><span>T4:P4069,省选/NOI-</span></a><span>。</span></p><h2><a name="动态树linkcattree" class="md-header-anchor"></a><span>动态树(</span><span class='math-in-toc'>$L_{ink}C_{at}T_{ree}$</span><span>)</span></h2><p><span>动态树，顾名思义，这种树是动态的，可能删边或加边。</span><span class='math-in-toc'>$\text{LCT}$</span><span> 可以动态维护其中的路径信息，以</span><a href='https://www.luogu.com.cn/problem/P3690'><span>模板题</span></a><span>为例。</span></p><p><span>首先，你需要学会：文艺 </span><span class='math-in-toc'>$\text{splay}$</span><span> 树，实链剖分。</span></p><p><span>实链剖分？没见过。但是，我们可以管他叫乱链剖分，因为他确实是随便选一个儿子当成实儿子，其余的当成虚儿子。</span></p><p><span>这有什么用呢？他非常的灵活。不像重链或者长链一样改一个上面全得改。</span></p><p><span>剖分完了，然后呢？然后，我们将被一堆实边连到一起的树甩到文艺 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 里面，构成一颗树。</span></p><p><span>那虚边怎么办？我们采用一种神奇的方法：认父不认子！我们正好满足了高效维护虚边和只向上移动的需求。</span></p><p><span>又因为我们有一堆的 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 树，构成了一个森林，我们管这个森林叫做辅助树。一个辅助树对应原森林中的一棵树。</span></p><p><span>那辅助树需要满足什么性质呢？每一个 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 的中序遍历满足按照深度排序。这样，我们就完成了原森林到辅助森林的转化。</span></p><p><span>接下来，</span><span class='math-in-toc'>$\text{Splay}$</span><span>树中都有哪些函数和变量呢？</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">splaytree</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">sn</span>[<span class="cm-variable">sz</span>][<span class="cm-number">2</span>], <span class="cm-variable">f</span>[<span class="cm-variable">sz</span>], <span class="cm-variable">v</span>[<span class="cm-variable">sz</span>], <span class="cm-variable">r</span>[<span class="cm-variable">sz</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">//sn(子节点),f(父节点),v(子树异或值),r(反转标记)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">bs</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">pup</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">nor</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">swn</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">pud</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">ron</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">rot</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">splay</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">access</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">mkrt</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">fnrt</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">tlnk</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">link</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">val</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">chg</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">v</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">re</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 460px;"></div><div class="CodeMirror-gutters" style="display: none; height: 460px;"></div></div></div></pre><p><span>首先说最基础的 </span><code>pup</code><span>，</span><code>pud</code><span>，</span><code>rot</code><span> 和 </span><code>splay</code><span>。</span></p><p><code>pup</code><span> 即 </span><code>pushup</code><span>，将子节点的信息上传上来。这里，我们需要维护每一个节点在 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 中的子树中的所有结点的异或值。</span></p><p><code>pud</code><span> 即 </span><code>pushdown</code><span>，将旋转标记下传，毕竟是文艺 </span><span class='math-in-toc'>$\text{Splay}$</span><span>嘛。</span></p><p><code>rot</code><span> 即 </span><code>rotate</code><span>，将一个节点向上旋转，</span><span class='math-in-toc'>$\text{Splay}$</span><span> 的基础操作。但是要做一定的修改。</span></p><p><span>首先，一定要严格判断父节点是不是当前 </span><span class='math-in-toc'>$\text{Splay}$</span><span>树的树根。如果不是，一定不要让祖父认这个儿子，因为认父不认子只出现在虚边，而一颗 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 维护的是实边树。</span></p><p><span>其次，一定要严格判断子节点是否存在，不要让 </span><span class='math-in-toc'>$0$</span><span> 有了父节点。</span></p><p><span>别的大致没有什么好说的，注意先 </span><code>pup(fp)</code><span> 再 </span><code>pup(p)</code><span>，因为这时候 </span><span class='math-in-toc'>$fp$</span><span> 已经成为 </span><span class='math-in-toc'>$p$</span><span> 的子节点了。</span></p><p><code>splay</code><span> 就是你想的那个函数，但是因为在 </span><span class='math-in-toc'>$\text{LCT}$</span><span> 中只涉及到了将一个点转到当前  </span><span class='math-in-toc'>$\text{Splay}$</span><span> 树的根节点这一种操作，所以省略掉了第二个参数。</span></p><p><span>然后说一下 </span><span class='math-in-toc'>$\text{LCT}$</span><span> 特有的函数。</span></p><p><code>nor</code><span> 即 </span><code>not_root</code><span>，判断一个节点是不是当前 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 的根节点。判断方式很简单，看他是不是父亲的儿子，因为认父不认子。</span></p><p><code>access</code><span> 是 </span><span class='math-in-toc'>$\text{LCT}$</span><span> 的核心操作，它会将 </span><span class='math-in-toc'>$p$</span><span> 在原树中到根节点的链变为实链。可是我们不是不维护原树吗？</span></p><p><span>其实我们仔细想一下，因为他们在同一个实链当中，所以他们在 </span><code>access</code><span> 完了之后只会在同一颗 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 中。所以我们只需要将路径上的 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 间的边设为实边就行了。</span></p><p><span>具体的，我们不停地将当前节点旋到树根，让父亲认这个儿子（原先的儿子因为认父不认子而自动降为了虚儿子）为右儿子（中序遍历满足深度递增），再将节点跳到父亲上就完了。</span></p><p><code>swn</code><span> 即 </span><code>swap_node</code><span>，即将这个节点区间反转。</span></p><p><code>ron</code><span> 即 </span><code>rotate_node</code><span>，将这个点到根节点的区间反转标记下传。</span></p><p><code>mkrt</code><span> 即 </span><code>make_root</code><span>，将这个节点设为原树的根。也很简单，打通他和根节点之间的路径（</span><code>access</code><span>），旋到树根，区间反转。</span></p><p><span>为什么区间反转呢？中序遍历按深度递增。反转之前他只会是整个 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 中最下的节点，旋到树根后所有节点都在他的左子树，区间反转一下它就成为最低的节点，也就是根节点了。</span></p><p><code>fnrt</code><span> 即 </span><code>find_root</code><span>，找他在原树中的根。我们只需要 </span><code>access</code><span>，</span><code>splay</code><span>，然后边下传标记边向左子树走，最靠边的就是根节点。</span></p><p><code>tlnk</code><span> 即 </span><code>to_link</code><span>，就是用一颗 </span><span class='math-in-toc'>$\text{Splay}$</span><span> 树专门来维护 </span><span class='math-in-toc'>$l,r$</span><span> 之间的链。显然我们只需要 </span><code>mkrt(l)</code><span>，</span><code>access(r)</code><span> 之后 </span><code>splay(r)</code><span> 就行了。</span></p><p><code>link</code><span> 就是 </span><span class='math-in-toc'>$\text{LCT}$</span><span> 中 </span><span class='math-in-toc'>$L$</span><span> 对应的操作。他就是连接一条 </span><span class='math-in-toc'>$l,r$</span><span> 的边。我们只需要让 </span><span class='math-in-toc'>$l$</span><span> 成为原树树根，然后 </span><span class='math-in-toc'>$fa[l]=r$</span><span> 就行了。</span></p><p><code>cut</code><span> 就是 </span><span class='math-in-toc'>$\text{LCT}$</span><span> 中 </span><span class='math-in-toc'>$C$</span><span> 对应的操作。他就是断开 </span><span class='math-in-toc'>$l,r$</span><span> 的边。我们只需要让 </span><span class='math-in-toc'>$l$</span><span> 成为原树的根，将 </span><span class='math-in-toc'>$r$</span><span> 转到 </span><span class='math-in-toc'>$l$</span><span> 边上，不认父不认子就完了。</span></p><p><span>剩下的两个就是对题的函数了，不用管他。</span></p><p><span>代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">constexpr</span> <span class="cm-variable-3">int</span> <span class="cm-variable">sz</span> <span class="cm-operator">=</span> <span class="cm-number">1e5</span> <span class="cm-operator">+</span> <span class="cm-number">5</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">t</span>[<span class="cm-variable">sz</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">tree</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//变量：sn(子节点),f(父节点),v(子树异或值),r(反转标记)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">sn</span>[<span class="cm-variable">sz</span>][<span class="cm-number">2</span>], <span class="cm-variable">f</span>[<span class="cm-variable">sz</span>], <span class="cm-variable">v</span>[<span class="cm-variable">sz</span>], <span class="cm-variable">r</span>[<span class="cm-variable">sz</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//是不是右儿子</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">bs</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) { <span class="cm-keyword">return</span> <span class="cm-variable">sn</span>[<span class="cm-variable">f</span>[<span class="cm-variable">p</span>]][<span class="cm-number">1</span>] <span class="cm-operator">==</span> <span class="cm-variable">p</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//更新答案(v)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">pup</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) { <span class="cm-variable">v</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">1</span>]] <span class="cm-variable">^</span> <span class="cm-variable">v</span>[<span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>]] <span class="cm-variable">^</span> <span class="cm-variable">t</span>[<span class="cm-variable">p</span>]; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//not - root = nor</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">nor</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) { <span class="cm-keyword">return</span> <span class="cm-variable">sn</span>[<span class="cm-variable">f</span>[<span class="cm-variable">p</span>]][<span class="cm-number">0</span>] <span class="cm-operator">==</span> <span class="cm-variable">p</span> <span class="cm-operator">||</span> <span class="cm-variable">sn</span>[<span class="cm-variable">f</span>[<span class="cm-variable">p</span>]][<span class="cm-number">1</span>] <span class="cm-operator">==</span> <span class="cm-variable">p</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//swn：swap - node = swn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">swn</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) { <span class="cm-variable">swap</span>(<span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>], <span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">1</span>]), <span class="cm-variable">r</span>[<span class="cm-variable">p</span>] <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-number">1</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//pud：下传反转标记</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">pud</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">r</span>[<span class="cm-variable">p</span>]) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>]) <span class="cm-variable">swn</span>(<span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">1</span>]) <span class="cm-variable">swn</span>(<span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">1</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">r</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//ron：rotate - node(实际上是下传了到链顶的标记)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">ron</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">nor</span>(<span class="cm-variable">p</span>)) <span class="cm-variable">ron</span>(<span class="cm-variable">f</span>[<span class="cm-variable">p</span>]); <span class="cm-variable">pud</span>(<span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">rot：最根本的旋转操作，但是和普通的 splay 有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">1. 要判断 f[p] 是不是当前 splay 的根，不是才能更新 f[f[p]] 的子节点信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">2. 要判断 sn[p][...] 的存在性，存在才更新 f[sn[p][...]]，否则 f[0] 会被改</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">rot</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">fp</span> <span class="cm-operator">=</span> <span class="cm-variable">f</span>[<span class="cm-variable">p</span>], <span class="cm-variable">pp</span> <span class="cm-operator">=</span> <span class="cm-variable">f</span>[<span class="cm-variable">fp</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">bool</span> <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-variable">bs</span>(<span class="cm-variable">p</span>); <span class="cm-variable-3">int</span> <span class="cm-variable">sp</span> <span class="cm-operator">=</span> <span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-operator">!</span><span class="cm-variable">t</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">nor</span>(<span class="cm-variable">fp</span>)) <span class="cm-variable">sn</span>[<span class="cm-variable">pp</span>][<span class="cm-variable">bs</span>(<span class="cm-variable">fp</span>)] <span class="cm-operator">=</span> <span class="cm-variable">p</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-operator">!</span><span class="cm-variable">t</span>] <span class="cm-operator">=</span> <span class="cm-variable">fp</span>; <span class="cm-variable">sn</span>[<span class="cm-variable">fp</span>][<span class="cm-variable">t</span>] <span class="cm-operator">=</span> <span class="cm-variable">sp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sp</span>) <span class="cm-variable">f</span>[<span class="cm-variable">sp</span>] <span class="cm-operator">=</span> <span class="cm-variable">fp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">f</span>[<span class="cm-variable">fp</span>] <span class="cm-operator">=</span> <span class="cm-variable">p</span>; <span class="cm-variable">f</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">pp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pup</span>(<span class="cm-variable">fp</span>); <span class="cm-variable">pup</span>(<span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">splay：最基本的操作，但是也有不同，更像文艺 splay</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">要下传从 splay 树的树根开始的反转懒标记，但是只反转这条链的。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">splay</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ron</span>(<span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">nor</span>(<span class="cm-variable">p</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">fp</span> <span class="cm-operator">=</span> <span class="cm-variable">f</span>[<span class="cm-variable">p</span>], <span class="cm-variable">pp</span> <span class="cm-operator">=</span> <span class="cm-variable">f</span>[<span class="cm-variable">fp</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">nor</span>(<span class="cm-variable">fp</span>)) <span class="cm-variable">rot</span>((<span class="cm-variable">sn</span>[<span class="cm-variable">fp</span>][<span class="cm-number">0</span>] <span class="cm-operator">==</span> <span class="cm-variable">p</span>) <span class="cm-variable">^</span> (<span class="cm-variable">sn</span>[<span class="cm-variable">pp</span>][<span class="cm-number">0</span>] <span class="cm-operator">==</span> <span class="cm-variable">fp</span>) <span class="cm-operator">?</span> <span class="cm-variable">p</span> : <span class="cm-variable">fp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rot</span>(<span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">access：LCT 的根本操作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">作用：在原树中将 p 到“树根”的边置为实边</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">方式：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">1. 将 p 转到当前 splay 树的根</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">2. p 作为父亲认前一个节点 ap 互认父子</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">3. 更新 p 点答案，p 跃到其父节点上。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">4. 循环直至 p 变为 0 (虚无令使)。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">解释：如果 2 中 p 有右节点，那么置右节点只会将原有的一条实边变为虚边。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">这时候，因为认父不认子，修边完成。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">access</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">ap</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">p</span>; <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">f</span>[<span class="cm-variable">ap</span> <span class="cm-operator">=</span> <span class="cm-variable">p</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">splay</span>(<span class="cm-variable">p</span>), <span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-variable">ap</span>, <span class="cm-variable">pup</span>(<span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">mkrt：make_root</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">作用：将 p 变为原树的根节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">方式：打通路径，旋至顶点，交换儿子</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">交换儿子干了什么呢？</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">access 会使他成为 splay 树中最深的节点。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">上去了之后他会成为中序最后，但是交换完左右就成为中序最前了。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">根据其特殊性质，他变相地成为了原树的根节点。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">mkrt</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) { <span class="cm-variable">access</span>(<span class="cm-variable">p</span>); <span class="cm-variable">splay</span>(<span class="cm-variable">p</span>); <span class="cm-variable">swn</span>(<span class="cm-variable">p</span>); }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">fnrt：find_root</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">作用：找这个原树的根节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">方式：打通路径，旋至顶点，走左子树，重新旋顶，返回答案。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">fnrt</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">access</span>(<span class="cm-variable">p</span>); <span class="cm-variable">splay</span>(<span class="cm-variable">p</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">pud</span>(<span class="cm-variable">p</span>), <span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>]) <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-number">0</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">splay</span>(<span class="cm-variable">p</span>); <span class="cm-keyword">return</span> <span class="cm-variable">p</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">tlnk：to_link</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">作用：将两个点的路径提取为一个 splay</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">方式：提为树根，打通路径，旋至树顶</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">access 链底，mkrt 必为链顶。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">tlnk</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) { <span class="cm-variable">mkrt</span>(<span class="cm-variable">l</span>); <span class="cm-variable">access</span>(<span class="cm-variable">r</span>); <span class="cm-variable">splay</span>(<span class="cm-variable">r</span>); }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//连接边：先作为根，判断不同树后单向认父（虚边）即可。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">link</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">mkrt</span>(<span class="cm-variable">l</span>), <span class="cm-variable">fnrt</span>(<span class="cm-variable">r</span>) <span class="cm-operator">!=</span> <span class="cm-variable">l</span>) <span class="cm-variable">f</span>[<span class="cm-variable">l</span>] <span class="cm-operator">=</span> <span class="cm-variable">r</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//断开边：先作为根，判断有边后双向断边即可。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">cut</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">mkrt</span>(<span class="cm-variable">l</span>), <span class="cm-variable">fnrt</span>(<span class="cm-variable">r</span>) <span class="cm-operator">==</span> <span class="cm-variable">l</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">f</span>[<span class="cm-variable">r</span>] <span class="cm-operator">==</span> <span class="cm-variable">l</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">sn</span>[<span class="cm-variable">r</span>][<span class="cm-number">0</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">f</span>[<span class="cm-variable">r</span>] <span class="cm-operator">=</span> <span class="cm-variable">sn</span>[<span class="cm-variable">l</span>][<span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">pup</span>(<span class="cm-variable">l</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//其余针对题目的支持函数：查询路径&amp;&amp;修改点权</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">val</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">r</span>) { <span class="cm-keyword">return</span> <span class="cm-variable">tlnk</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>), <span class="cm-variable">v</span>[<span class="cm-variable">r</span>]; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">chg</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">v</span>) { <span class="cm-variable">splay</span>(<span class="cm-variable">p</span>); <span class="cm-variable">t</span>[<span class="cm-variable">p</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>; <span class="cm-variable">pup</span>(<span class="cm-variable">p</span>); }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">re</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>); <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">n</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">m</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">t</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">o</span>, <span class="cm-variable">l</span>, <span class="cm-variable">r</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">o</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">l</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">r</span>, <span class="cm-operator">!</span><span class="cm-variable">o</span>) <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">re</span>.<span class="cm-variable">val</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>) <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">o</span> <span class="cm-operator">==</span> <span class="cm-number">1</span>) <span class="cm-variable">re</span>.<span class="cm-variable">link</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">o</span> <span class="cm-operator">==</span> <span class="cm-number">2</span>) <span class="cm-variable">re</span>.<span class="cm-variable">cut</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">re</span>.<span class="cm-variable">chg</span>(<span class="cm-variable">l</span>, <span class="cm-variable">r</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//私は猫です</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3059px;"></div><div class="CodeMirror-gutters" style="display: none; height: 3059px;"></div></div></div></pre><h2><a name="快速傅里叶变换fft" class="md-header-anchor"></a><span>快速傅里叶变换(</span><span class='math-in-toc'>$FFT$</span><span>)</span></h2><p><span>快速傅里叶变换还是太超模了。FFT 可以在 </span><span class='math-in-toc'>$O(n\log n)$</span><span> 的时间复杂度内解决两个次数不高于 </span><span class='math-in-toc'>$n$</span><span> 次的多项式的卷积。</span></p><p><span>首先，多项式最直观的表示方式是系数表示，但是 FFT 转而使用点值表示。对于一个 </span><span class='math-in-toc'>$n$</span><span> 次多项式，可由 </span><span class='math-in-toc'>$n+1$</span><span> 或更多个不同点的位置确定。这一点在此不作证明。</span></p><p><span>接下来，我们假定我们有两个 </span><span class='math-in-toc'>$n$</span><span> 次的多项式 </span><span class='math-in-toc'>$f_1(x)$</span><span> 和 </span><span class='math-in-toc'>$f_2(x),g(x)=f_1(x)\times f_2(x)$</span><span>，那么假设我们算出了 </span><span class='math-in-toc'>$2\times n+1$</span><span> 个点的值，分别为 </span><span class='math-in-toc'>$(x_0,f_1(x_0)),(x_1,f_1(x_1)),\dots,(x_{2\times n},f_1(x_{2\times n}))$</span><span> 和 </span><span class='math-in-toc'>$(x_0,f_2(x_0)),(x_1,f_2(x_1)),\dots,(x_{2\times n},f_2(x_{2\times n}))$</span><span>，那么 </span><span class='math-in-toc'>$g(x)$</span><span> 必过 </span><span class='math-in-toc'>$(x_0,f_1(x_0)\times f_2(x_0)),(x_1,f_1(x_1)\times f_2(x_1)),\dots,(x_{2\times n},f_1(x_{2\times n})\times f_2(x_{2\times n}))$</span><span>。</span></p><p><span>就是这么一坨东西。显然，我们如果能够快速的在点值和多项式之间转化，那么我们就能够快速的求出两个多项式的卷积。问题就在于我们如何在二者之间快速转化。</span></p><p><span>神奇的地方就在于此。让我们做一个小小的变化。假设 </span><span class='math-in-toc'>$F_o(x)$</span><span> 表示 </span><span class='math-in-toc'>$F$</span><span> 中 </span><span class='math-in-toc'>$x$</span><span> 的偶数次方项之和，</span><span class='math-in-toc'>$F_e(x)$</span><span> 表示 </span><span class='math-in-toc'>$F$</span><span> 中 </span><span class='math-in-toc'>$x$</span><span> 的奇数次方项提出 </span><span class='math-in-toc'>$x$</span><span> 的公因数之后的式子，那么不难发现，</span><span class='math-in-toc'>$F_o,F_e$</span><span> 都只剩偶数次方项了。</span></p><p><span>这有什么呢？不难注意到，</span><span class='math-in-toc'>$F(x)=F_o(x)+xF_e(x),F(-x)=F_o(x)-xF_e(x)$</span><span>。初现端倪，我们递归此过程的话，是不是就可以做到 </span><span class='math-in-toc'>$O(n\log n)$</span><span> 了呢？</span></p><p><span>似乎并没有，接下来你在求 </span><span class='math-in-toc'>$F_o(x)$</span><span> 的时候，你无法再使用正负点对来加速了，毕竟 </span><span class='math-in-toc'>$x$</span><span> 的平方一定是恒正的......吗？</span></p><p><span>不一定是啊！你回忆了一下你不知道学没学过的复数，想到单位根正好满足这个要求。</span></p><p><span>最底层的时候我们求最底下的那个多项式（其实已经只剩单项式了）在 </span><span class='math-in-toc'>$x=\omega_x=\cos\frac{2\pi\times x}{n+1}+i\sin\frac{2\pi\times x}{n+1}$</span><span>，其中 </span><span class='math-in-toc'>$x$</span><span> 取值范围为 </span><span class='math-in-toc'>$[0,n]$</span><span>。</span></p><p><span>那么你再观察一下，当 </span><span class='math-in-toc'>$x^\prime=x^2$</span><span> 的时候，</span><span class='math-in-toc'>$\omega_x^2=\omega_{x+\frac{n+1}{2}}^2$</span><span>。也就是说，只要我们能让 </span><span class='math-in-toc'>$n$</span><span> 是一个形如 </span><span class='math-in-toc'>$2^k-1$</span><span> 的数，我们就能一直将这个过程进行下去。</span></p><p><span>那很显然，不足的位我们直接补 </span><span class='math-in-toc'>$0$</span><span> 就完事了。</span></p><p><span>于是我们成功地将多项式在 </span><span class='math-in-toc'>$n\log n$</span><span> 的复杂度内变为了点值表示。</span></p><p><span>那么，怎么从点值变回多项式呢？</span></p><p><span>我们这样来看：FFT 实际上是快速的求出了 </span><span class='math-in-toc'>$b_x=\sum_{i=0}^na_i\times \omega_{ix}$</span><span>。那么经过一些神奇的推导，我们很难发现：</span><span class='math-in-toc'>$a_x=\frac{1}{n+1}\sum_{i=0}^nb_i\omega_{-ix}$</span><span>。这一点可以通过直接的数论推导或者 FFT 中各步骤对应的矩阵乘法形式通过逆矩阵证得。</span></p><p><span>此时你又定睛一看，发现如果你令 </span><span class='math-in-toc'>$\omega^\prime_{x}=\frac{\omega_{-x}}{n+1}$</span><span>，那么 </span><span class='math-in-toc'>$a_x=\sum_{i=0}^nb_i\times \omega^\prime_{ix}$</span><span>，FFT 不就能求了吗？</span></p><p><span>因此，我们求出了两个多项式的卷积，复杂度 </span><span class='math-in-toc'>$O(n\log n)$</span><span>。</span></p><p><span>更多优化与应用在 NTT 讲。</span></p><h2><a name="快速数论变换ntt" class="md-header-anchor"></a><span>快速数论变换(</span><span class='math-in-toc'>$NTT$</span><span>)</span></h2><p><span>也算是为数不多的几个完全不需要掌握其所以然的算法了。可以从 FFT 那里变过来。</span></p><p><span>NTT 本质上就干了一件事：把复数映射到了整数集上，然后接着干。</span></p><p><span>怎么映射呢？原根。对于质数 </span><span class='math-in-toc'>$p=qn+1$</span><span>，且 </span><span class='math-in-toc'>$n=2^m$</span><span>，那么原根 </span><span class='math-in-toc'>$g$</span><span> 满足 </span><span class='math-in-toc'>$g^{qn}\equiv1\pmod p$</span><span>。此时我们可以将 </span><span class='math-in-toc'>$g_n=g^q\pmod p$</span><span> 看作 </span><span class='math-in-toc'>$\omega_n$</span><span> 的等价。</span></p><p><span>说白了，在模 </span><span class='math-in-toc'>$p$</span><span> 意义下可以认为 </span><span class='math-in-toc'>$g\equiv e^{\frac{2\pi}{q}}$</span><span>。常见的 </span><span class='math-in-toc'>$(p,g)$</span><span> 有 </span><span class='math-in-toc'>$(167772161,3),(998244353,3),(1004535809,3)$</span><span>。</span></p><p><span>所以你只需要把代码中对应的那些位置替换一下就行了。</span></p><h3><a name="若干优化" class="md-header-anchor"></a><span>若干优化</span></h3><p><span>逐步看。这是 FFT 比较劣的一个版本，模板题要跑 2.77s。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-variable">cpx</span> <span class="cm-operator">=</span> <span class="cm-variable">complex</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">double</span><span class="cm-operator">&gt;</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">lim</span>, <span class="cm-variable">rev</span>; <span class="cm-keyword">const</span> <span class="cm-variable-3">double</span> <span class="cm-variable">pi2</span> <span class="cm-operator">=</span> <span class="cm-variable">acos</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>) <span class="cm-operator">*</span> <span class="cm-number">2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">fft</span>(<span class="cm-keyword">const</span> <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">lim</span>, <span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">cpx</span><span class="cm-operator">&gt;&amp;</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lim</span> <span class="cm-operator">==</span> <span class="cm-number">1</span>) <span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">cpx</span><span class="cm-operator">&gt;</span><span class="cm-variable">vl</span>(<span class="cm-variable">lim</span> <span class="cm-operator">+</span> <span class="cm-number">4</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>), <span class="cm-variable">vr</span>(<span class="cm-variable">lim</span> <span class="cm-operator">+</span> <span class="cm-number">4</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">lim</span>; <span class="cm-variable">i</span> <span class="cm-operator">+=</span> <span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vl</span>[<span class="cm-variable">i</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>], <span class="cm-variable">vr</span>[<span class="cm-variable">i</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fft</span>(<span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>, <span class="cm-variable">vl</span>); <span class="cm-variable">fft</span>(<span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>, <span class="cm-variable">vr</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cpx</span> <span class="cm-variable">tm</span>(<span class="cm-variable">cos</span>(<span class="cm-variable">pi2</span> <span class="cm-operator">/</span> <span class="cm-variable">lim</span>), <span class="cm-variable">sin</span>(<span class="cm-variable">pi2</span> <span class="cm-operator">/</span> <span class="cm-variable">lim</span>) <span class="cm-operator">*</span> <span class="cm-variable">rev</span>), <span class="cm-variable">tv</span>(<span class="cm-number">1</span>, <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>, <span class="cm-variable">tv</span> <span class="cm-operator">*=</span> <span class="cm-variable">tm</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">vl</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-variable">tv</span> <span class="cm-operator">*</span> <span class="cm-variable">vr</span>[<span class="cm-variable">i</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> (<span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>)] <span class="cm-operator">=</span> <span class="cm-variable">vl</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-variable">tv</span> <span class="cm-operator">*</span> <span class="cm-variable">vr</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 299px;"></div><div class="CodeMirror-gutters" style="display: none; height: 299px;"></div></div></div></pre><p><span>我们知道，复数的运算其实很耗时间，所以能少计算一次，尤其是乘法，会有一定的优化。所以我们将 </span><code>tv * vr[i]</code><span> 的结果存下来。这样就能优化到 2.65s。代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-variable">cpx</span> <span class="cm-operator">=</span> <span class="cm-variable">complex</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">double</span><span class="cm-operator">&gt;</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>, <span class="cm-variable">lim</span>, <span class="cm-variable">rev</span>; <span class="cm-keyword">const</span> <span class="cm-variable-3">double</span> <span class="cm-variable">pi2</span> <span class="cm-operator">=</span> <span class="cm-variable">acos</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>) <span class="cm-operator">*</span> <span class="cm-number">2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">fft</span>(<span class="cm-keyword">const</span> <span class="cm-variable-3">int</span><span class="cm-operator">&amp;</span> <span class="cm-variable">lim</span>, <span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">cpx</span><span class="cm-operator">&gt;&amp;</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">lim</span> <span class="cm-operator">==</span> <span class="cm-number">1</span>) <span class="cm-keyword">return</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">cpx</span><span class="cm-operator">&gt;</span><span class="cm-variable">vl</span>(<span class="cm-variable">lim</span> <span class="cm-operator">+</span> <span class="cm-number">4</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>), <span class="cm-variable">vr</span>(<span class="cm-variable">lim</span> <span class="cm-operator">+</span> <span class="cm-number">4</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">lim</span>; <span class="cm-variable">i</span> <span class="cm-operator">+=</span> <span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vl</span>[<span class="cm-variable">i</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>], <span class="cm-variable">vr</span>[<span class="cm-variable">i</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fft</span>(<span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>, <span class="cm-variable">vl</span>); <span class="cm-variable">fft</span>(<span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>, <span class="cm-variable">vr</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cpx</span> <span class="cm-variable">tm</span>(<span class="cm-variable">cos</span>(<span class="cm-variable">pi2</span> <span class="cm-operator">/</span> <span class="cm-variable">lim</span>), <span class="cm-variable">sin</span>(<span class="cm-variable">pi2</span> <span class="cm-operator">/</span> <span class="cm-variable">lim</span>) <span class="cm-operator">*</span> <span class="cm-variable">rev</span>), <span class="cm-variable">tv</span>(<span class="cm-number">1</span>, <span class="cm-number">0</span>), <span class="cm-variable">tmp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">!=</span> <span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>, <span class="cm-variable">tv</span> <span class="cm-operator">*=</span> <span class="cm-variable">tm</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tmp</span> <span class="cm-operator">=</span> <span class="cm-variable">tv</span> <span class="cm-operator">*</span> <span class="cm-variable">vr</span>[<span class="cm-variable">i</span>], <span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">vl</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-variable">tmp</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> (<span class="cm-variable">lim</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>)] <span class="cm-operator">=</span> <span class="cm-variable">vl</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-variable">tmp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 299px;"></div><div class="CodeMirror-gutters" style="display: none; height: 299px;"></div></div></div></pre><p><span>这不是重点，接下来要介绍一下非递归版的 FFT。</span></p><p><span>我们在运行的时候会不停的涉及到交换位置，导致最后算出来的东西出现乱序，根本用不了。但是如果我们预先将这些位置预先换了，是不是就没有那么多问题了？</span></p><p><span>确实。不过一个悲催的问题是我没有搞懂他为什么是代码中的那个位置。所以死记吧。这样能直接优化到 1.65s。代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">fft</span>(<span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">cpx</span><span class="cm-operator">&gt;&amp;</span> <span class="cm-variable">v</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">sp</span>[<span class="cm-variable">i</span>]) <span class="cm-variable">swap</span>(<span class="cm-variable">v</span>[<span class="cm-variable">i</span>], <span class="cm-variable">v</span>[<span class="cm-variable">sp</span>[<span class="cm-variable">i</span>]]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">ml</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">ml</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>; <span class="cm-variable">ml</span> <span class="cm-operator">&lt;&lt;=</span> <span class="cm-number">1</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tv</span> <span class="cm-operator">=</span> <span class="cm-variable">cpx</span>(<span class="cm-variable">cos</span>(<span class="cm-variable">pi</span> <span class="cm-operator">/</span> <span class="cm-variable">ml</span>), <span class="cm-variable">sin</span>(<span class="cm-variable">pi</span> <span class="cm-operator">/</span> <span class="cm-variable">ml</span>) <span class="cm-operator">*</span> <span class="cm-variable">rev</span>);<span class="cm-comment">//因为是枚举一半的长度，所以不需要pi*2了。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">p</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>; <span class="cm-variable">p</span> <span class="cm-operator">+=</span> <span class="cm-variable">ml</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vl</span> <span class="cm-operator">=</span> <span class="cm-variable">cpx</span>(<span class="cm-number">1</span>, <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">ml</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>, <span class="cm-variable">vl</span> <span class="cm-operator">*=</span> <span class="cm-variable">tv</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tmp</span> <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-variable">ml</span>] <span class="cm-operator">*</span> <span class="cm-variable">vl</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-variable">ml</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-variable">tmp</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span>] <span class="cm-operator">+=</span> <span class="cm-variable">tmp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>(); <span class="cm-variable">m</span> <span class="cm-operator">=</span> <span class="cm-variable">read</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable">cpx</span><span class="cm-operator">&gt;</span><span class="cm-variable">f</span>(<span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>), <span class="cm-variable">g</span>(<span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-variable">m</span> <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">f</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">cpx</span>(<span class="cm-variable">read</span>(), <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">g</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">cpx</span>(<span class="cm-variable">read</span>(), <span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">lim</span> <span class="cm-operator">=</span> <span class="cm-variable">rev</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-keyword">while</span> (<span class="cm-variable">lim</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-variable">m</span>) <span class="cm-variable">lim</span> <span class="cm-operator">&lt;&lt;=</span> <span class="cm-number">1</span>, <span class="cm-variable">tl</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sp</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> (<span class="cm-variable">sp</span>[<span class="cm-variable">i</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>] <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>) <span class="cm-operator">|</span> ((<span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>) <span class="cm-operator">&lt;&lt;</span> (<span class="cm-variable">tl</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fft</span>(<span class="cm-variable">f</span>); <span class="cm-variable">fft</span>(<span class="cm-variable">g</span>); <span class="cm-variable">rev</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">lim</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">f</span>[<span class="cm-variable">i</span>] <span class="cm-operator">*=</span> <span class="cm-variable">g</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">fft</span>(<span class="cm-variable">f</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span> <span class="cm-operator">+</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">writi</span>(<span class="cm-variable">f</span>[<span class="cm-variable">i</span>].<span class="cm-variable">real</span>() <span class="cm-operator">/</span> <span class="cm-variable">lim</span> <span class="cm-operator">+</span> <span class="cm-number">0.5</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 667px;"></div><div class="CodeMirror-gutters" style="display: none; height: 667px;"></div></div></div></pre><h3><a name="应用" class="md-header-anchor"></a><span>应用</span></h3><p><span>重要的是卷积形式。这又是什么呢？就是形如 </span><span class='math-in-toc'>$A(x)=\sum_{i=0}^xF(i)G(x-i)$</span><span> 的式子，其中 </span><span class='math-in-toc'>$F,G$</span><span> 均不与 </span><span class='math-in-toc'>$x$</span><span> 相关。显然从卷积的暴力计算方式来看，就不难发现 </span><span class='math-in-toc'>$F*G$</span><span> </span><span class='math-in-toc'>$x^n$</span><span> 对应的系数就是要求的 </span><span class='math-in-toc'>$A(n)$</span><span>。</span></p><p><span>于是，只要你能化出卷积形式，就可以用 FFT/NTT 做掉了。典型例题有</span><a href='https://www.luogu.com.cn/problem/P5395'><span>第二STL行</span></a><span>。EG：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n3605" cid="n3605" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><script type="math/tex; mode=display">\begin{aligned}
& \{_m^n\}\\
=&\frac{1}{m!}\sum_{i=1}^m(_i^m)(-1)^{m-i}i^n\\
=&\sum_{i=1}^m\frac{(_i^m)(-1)^{m-i}i^n}{m!}\\
=&\sum_{i=0}^m\frac{i^n}{i!}\times\frac{(-1)^{m-i}}{(m-i)!}
\end{aligned}</script></div></div><p><span>所以就能得出核心代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">prev_stl</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">arr</span> <span class="cm-variable">cp</span>, <span class="cm-variable">a</span>, <span class="cm-variable">b</span>, <span class="cm-variable">ny</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">jc</span>, <span class="cm-variable">lim</span>, <span class="cm-variable">tl</span>, <span class="cm-variable">rev</span>, <span class="cm-variable">tv</span>, <span class="cm-variable">tmp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">ntt</span>(<span class="cm-variable-3">int*</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">cp</span>[<span class="cm-variable">i</span>]) <span class="cm-variable">swap</span>(<span class="cm-variable">v</span>[<span class="cm-variable">i</span>], <span class="cm-variable">v</span>[<span class="cm-variable">cp</span>[<span class="cm-variable">i</span>]]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">ml</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">ml</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>; <span class="cm-variable">ml</span> <span class="cm-operator">&lt;&lt;=</span> <span class="cm-number">1</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tv</span> <span class="cm-operator">=</span> <span class="cm-variable">qpow</span>(<span class="cm-variable">rev</span> <span class="cm-operator">?</span> <span class="cm-number">3</span> : <span class="cm-variable">siv3</span>, (<span class="cm-variable">mstl</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>) <span class="cm-operator">/</span> <span class="cm-variable">ml</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>, <span class="cm-variable">mstl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">p</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>; <span class="cm-variable">p</span> <span class="cm-operator">+=</span> <span class="cm-variable">ml</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">vl</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">ml</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>, <span class="cm-variable">vl</span> <span class="cm-operator">=</span> <span class="cm-variable">vl</span> <span class="cm-operator">*</span> <span class="cm-variable">tv</span> <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tmp</span> <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-variable">ml</span>] <span class="cm-operator">*</span> <span class="cm-variable">vl</span> <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-variable">ml</span>] <span class="cm-operator">=</span> (<span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-variable">tmp</span> <span class="cm-operator">+</span> <span class="cm-variable">mstl</span>) <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span>] <span class="cm-operator">=</span> (<span class="cm-variable">v</span>[<span class="cm-variable">p</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-variable">tmp</span>) <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">rev</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">inv</span> <span class="cm-operator">=</span> <span class="cm-variable">qpow</span>(<span class="cm-variable">lim</span>, <span class="cm-variable">mstl</span> <span class="cm-operator">-</span> <span class="cm-number">2</span>, <span class="cm-variable">mstl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">*</span> <span class="cm-variable">inv</span> <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">init</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">jc</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">k</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">jc</span> <span class="cm-operator">=</span> <span class="cm-variable">jc</span> <span class="cm-operator">*</span> <span class="cm-variable">i</span> <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ny</span>[<span class="cm-variable">k</span>] <span class="cm-operator">=</span> <span class="cm-variable">qpow</span>(<span class="cm-variable">jc</span>, <span class="cm-variable">mstl</span> <span class="cm-operator">-</span> <span class="cm-number">2</span>, <span class="cm-variable">mstl</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">k</span>;<span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span><span class="cm-operator">--</span>) <span class="cm-variable">ny</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-variable">ny</span>[<span class="cm-variable">i</span>] <span class="cm-operator">*</span> <span class="cm-variable">i</span> <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">k</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">a</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> (<span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>) <span class="cm-operator">?</span> <span class="cm-variable">mstl</span> <span class="cm-operator">-</span> <span class="cm-variable">ny</span>[<span class="cm-variable">i</span>] : <span class="cm-variable">ny</span>[<span class="cm-variable">i</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">b</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">qpow</span>(<span class="cm-variable">i</span>, <span class="cm-variable">k</span>, <span class="cm-variable">mstl</span>) <span class="cm-operator">*</span> <span class="cm-variable">ny</span>[<span class="cm-variable">i</span>] <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">lim</span> <span class="cm-operator">=</span> <span class="cm-variable">rev</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-keyword">while</span> (<span class="cm-variable">lim</span> <span class="cm-operator">&lt;=</span> (<span class="cm-variable">k</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>)) <span class="cm-variable">lim</span> <span class="cm-operator">&lt;&lt;=</span> <span class="cm-number">1</span>, <span class="cm-variable">tl</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cp</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> (<span class="cm-variable">cp</span>[<span class="cm-variable">i</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>] <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>) <span class="cm-operator">|</span> ((<span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>) <span class="cm-operator">&lt;&lt;</span> (<span class="cm-variable">tl</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ntt</span>(<span class="cm-variable">a</span>); <span class="cm-variable">ntt</span>(<span class="cm-variable">b</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">a</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">a</span>[<span class="cm-variable">i</span>] <span class="cm-operator">*</span> <span class="cm-variable">b</span>[<span class="cm-variable">i</span>] <span class="cm-operator">%</span> <span class="cm-variable">mstl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rev</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">ntt</span>(<span class="cm-variable">a</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">k</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">lim</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">a</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">solve</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">v</span>) { <span class="cm-keyword">return</span> <span class="cm-variable">a</span>[<span class="cm-variable">v</span>]; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">prs</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 828px;"></div><div class="CodeMirror-gutters" style="display: none; height: 828px;"></div></div></div></pre><h2><a name="prufer序列" class="md-header-anchor"></a><span>prufer序列</span></h2><p><span>这个也是相当的重要的。Prufer 序列可以实现无根树和值域为 </span><span class='math-in-toc'>$[1,n]$</span><span> 的长度为 </span><span class='math-in-toc'>$n-2$</span><span> 的整数序列之间的转化。</span></p><p><span>那么怎么转化的呢？先看第一种：树转 prufer。</span></p><p><span>每一次我都选择当前编号最小的叶子节点，将它的父节点的编号存到序列中，然后删掉这个节点，直到只剩下两个节点。</span></p><p><span>显然，用堆可以 </span><span class='math-in-toc'>$O(n\log n)$</span><span> 做。但是如果你仔细想一下就会发现，每删一个点最多再加上一个点。因此我可以顺序枚举点，如果能删就一直删，直到非叶子节点或者编号比初始位置大。时复 </span><span class='math-in-toc'>$O(n)$</span><span>。</span></p><p><span>再看第二种：prufer 转树。</span></p><p><span>首先由于 prufer 序列的一个非常显然的性质：每个节点在序列中出现的次数就是其度数减一。所以我们每一次选择编号最小的度数为 </span><span class='math-in-toc'>$1$</span><span> 的节点与当前枚举到的 prufer 序列中的点连接起来，将二者的“剩余度数”减一。当 prufer 序列枚举完后就剩下了两个点，连起来就行。</span></p><p><span>但是由于和树转 prufer 类似的构造方式，显然仍然可以用类似的方式来线性构造。</span></p><p><span>有什么用呢？首先他明显证明了 Cayley 定理：</span><span class='math-in-toc'>$n$</span><span> 个节点的带标号的形态不同的无根树有 </span><span class='math-in-toc'>$n^{n−2}$</span><span> 个。</span></p><p><span>其次，按照 LZJ 所说，会有一些题要用这个序列和一些数据结构搓一下，但是似乎到现在为止他也没有给出相关例题，就先放着吧。</span></p><h1><a name="数学" class="md-header-anchor"></a><span>数学</span></h1><h2><a name="卡特兰数" class="md-header-anchor"></a><span>卡特兰数</span></h2><p><span>卡特兰数非常常见，可应用于以下问题：</span></p><ol start='' ><li><span>有 </span><span class='math-in-toc'>$2n$</span><span> 个人排成一行进入剧院，入场费 </span><span class='math-in-toc'>$50$</span><span> 元。其中 </span><span class='math-in-toc'>$n$</span><span> 人只有一张 </span><span class='math-in-toc'>$50$</span><span> 元的钞票，</span><span class='math-in-toc'>$n$</span><span> 人只有一张 </span><span class='math-in-toc'>$100$</span><span> 元的钞票。请问有多少种方案使得剧院总有 </span><span class='math-in-toc'>$50$</span><span> 元钞票来找零。</span></li><li><span>有一个大小为 </span><span class='math-in-toc'>$n\times n$</span><span> 的方格图。左下角为 </span><span class='math-in-toc'>$(0,0)$</span><span>，右上角为 </span><span class='math-in-toc'>$(n,n)$</span><span>，每次只能向左或向上走且必须满足所有经过的位置 </span><span class='math-in-toc'>$(x,y)$</span><span> 满足 </span><span class='math-in-toc'>$x\ge y$</span><span>。</span></li><li><span>在圆上选择 </span><span class='math-in-toc'>$2n$</span><span> 个点，将这些点成对连接起来使得所得到的 </span><span class='math-in-toc'>$n$</span><span> 条线段不相交的方法数。</span></li><li><span>对角线不相交的情况下，将一个凸多边形区域分成三角形区域的方法数。</span></li><li><span>一个栈中顺序放入 </span><span class='math-in-toc'>$1,2,\dots,n$</span><span> 的不同的合法出栈顺序数。</span></li><li><span class='math-in-toc'>$n$</span><span> 个节点可以构造多少个不同的二叉树。</span></li><li><span class='math-in-toc'>$n$</span><span> 个 </span><span class='math-in-toc'>$1$</span><span> 与 </span><span class='math-in-toc'>$n$</span><span> 个 </span><span class='math-in-toc'>$-1$</span><span> 排列成数列 </span><span class='math-in-toc'>$a_i,i\in[1,2n]$</span><span>，求满足 </span><span class='math-in-toc'>$\forall k\in[1,2n],\sum_{i=1}^ka_i\ge0$</span><span> 的 </span><span class='math-in-toc'>$a$</span><span> 的个数。</span></li></ol><p><span>不难发现，</span><span class='math-in-toc'>$1,2,5,7$</span><span> 是完全等价的，</span><span class='math-in-toc'>$3,4$</span><span> 是完全等价的。实际上，</span><span class='math-in-toc'>$3,4,6$</span><span> 的递推式是完全一样的。我们可以得出若干不同的式子：</span></p><p><span class='math-in-toc'>$H_n=\frac{C_{2n}^n}{n+1}=C_{2n}^n-C_{2n}^{n-1}$</span><span>。</span></p><p><span class='math-in-toc'>$H_n=\frac{(4n-2)H_{n-1}}{n+1}=\sum_{i=1}^nH_{i-1}H_{n-i}$</span><span>。</span></p><p><span>一般可以认为边界条件为 </span><span class='math-in-toc'>$H_0=H_1=1$</span><span>。</span></p><p><span>为什么是这样的呢？先看第二个式子。显然，</span><span class='math-in-toc'>$C_{2n}^n$</span><span> 就是不考虑 </span><span class='math-in-toc'>$x\ge y$</span><span> 的从 </span><span class='math-in-toc'>$(0,0)$</span><span> 到 </span><span class='math-in-toc'>$(n,n)$</span><span> 的方案数，而 </span><span class='math-in-toc'>$C_{2n}^{n-1}$</span><span> 就是不考虑 </span><span class='math-in-toc'>$x\ge y$</span><span> 的从 </span><span class='math-in-toc'>$(0,0)$</span><span> 到 </span><span class='math-in-toc'>$(n-1,n+1)$</span><span> 的方案数。这俩有什么联系吗？</span></p><p><span>我们想一下，如果一个路径不合法，那么他一定会在某一步走到 </span><span class='math-in-toc'>$(x,x+1)$</span><span>。这时候，我们将他在 </span><span class='math-in-toc'>$(x,x+1)$</span><span> 到 </span><span class='math-in-toc'>$(n,n)$</span><span> 的路径反转一下，就像这个样子：</span></p><p><img src="https://www.helloimg.com/i/2025/03/22/67de34a84797e.png" referrerpolicy="no-referrer"></p><p><span>神奇的事情发生了：一个到 </span><span class='math-in-toc'>$(n,n)$</span><span> 的不合法路径被映射到了一个到 </span><span class='math-in-toc'>$(n-1,n+1)$</span><span> 的路径。随后，不难证明，每一个不合法路径都会唯一对应一个到 </span><span class='math-in-toc'>$(n-1,n+1)$</span><span> 的路径。那每一个到 </span><span class='math-in-toc'>$(n-1,n+1)$</span><span> 的路径都唯一对应一个到 </span><span class='math-in-toc'>$(n,n)$</span><span> 的不合法路径吗？</span></p><p><span>是的。我们直接让他在第一次越过 </span><span class='math-in-toc'>$x=y$</span><span> 线的时候就翻折，显然一一对应。证毕，解决 </span><span class='math-in-toc'>$1,2,5,7$</span><span>。</span></p><p><span>第二个式子显然能够推到第一个式子，不用多说了。也可以证明出来第三个式子。那第四个呢？</span></p><p><span>从 </span><span class='math-in-toc'>$4$</span><span> 或 </span><span class='math-in-toc'>$6$</span><span> 都能够推出这个式子。</span><span class='math-in-toc'>$4$</span><span> 从分治的角度去想，</span><span class='math-in-toc'>$6$</span><span> 从树形 DP 的角度去想都能得到这个式子。证毕，解决 </span><span class='math-in-toc'>$3,4,6$</span><span>。</span></p><p><span>那怎么证明这两个式子是恒相等的呢？数学归纳法是一个比较容易想到的方法。读者自证不难？</span></p><p><span>典型例题：</span><a href='https://www.luogu.com.cn/problem/T147065'><span>卡常难数</span></a><span>。</span></p><p><span>裸题</span><a href='https://www.luogu.com.cn/problem/P1722'><span>1</span></a><a href='https://www.luogu.com.cn/problem/P1044'><span>2</span></a><a href='https://www.luogu.com.cn/problem/P1754'><span>3</span></a><a href='https://www.luogu.com.cn/problem/P1976'><span>4</span></a><a href='https://www.luogu.com.cn/problem/P1375'><span>5</span></a><a href='https://www.luogu.com.cn/problem/T147065'><span>6</span></a><span>。</span></p><p><span>应用</span><a href='https://atcoder.jp/contests/arc145/tasks/arc145_c'><span>1</span></a><a href='https://www.luogu.com.cn/problem/P2532'><span>2</span></a><span>。</span></p><p><span>拓展</span><a href='https://www.luogu.com.cn/problem/P1641'><span>1</span></a><a href='https://www.luogu.com.cn/problem/AT_abc205_e'><span>2</span></a><span>。</span></p><h2><a name="威尔逊定理" class="md-header-anchor"></a><span>威尔逊定理</span></h2><p><span class='math-in-toc'>$(p-1)!\equiv-1\pmod p$</span><span>(</span><span class='math-in-toc'>$p$</span><span> 为质数)。可以用逆元两两配对证。</span></p><p><span>一般情况下不考，要考则考的足够板。主要的作用可能就是优化对这类数的快速幂操作的一个 </span><span class='math-in-toc'>$\log$</span><span>，或者</span><a href='https://www.luogu.com.cn/problem/SP16211'><span>这道题</span></a><span>的用途。主要是第二个。</span></p><h2><a name="错排列" class="md-header-anchor"></a><span>错排列</span></h2><p><span>简述思路：枚举每个数位置合不合法，</span><span class='math-in-toc'>$2^n$</span><span> 容斥，进一步发现数量相同贡献相同，压缩贡献计算得到 </span><span class='math-in-toc'>$\Sigma_{i=0}^n(-1)^iC_n^i(n-i)!$</span><span>，进一步化简为 </span><span class='math-in-toc'>$\Sigma_{i=0}^n(-1)^i\frac{n!}{i!}=\frac{n!}{0!}-\frac{n!}{1!}+\frac{n!}{2!}-\frac{n!}{3!}+\dots$</span><span>。</span></p><p><span>记个结论就完了，这东西不太能考的不板。</span></p><h2><a name="圆排列" class="md-header-anchor"></a><span>圆排列</span></h2><p><span class='math-in-toc'>$\frac{A_n^m}{m}$</span><span>，主要是记住他的最后除掉多统计部分的思想，解决其他类似问题。</span></p><h2><a name="多重集排列组合" class="md-header-anchor"></a><span>多重集排列组合</span></h2><p><span>以下按照这样的方式记录一个多重集 </span><span class='math-in-toc'>$A$</span><span>。</span><span class='math-in-toc'>$A$</span><span> 中共有 </span><span class='math-in-toc'>$[A]$</span><span> 种不同元素 </span><span class='math-in-toc'>$A_{v_i}(i\in[1,[A]])$</span><span>，其中第 </span><span class='math-in-toc'>$i$</span><span> 种有 </span><span class='math-in-toc'>$A_{c_i}$</span><span> 个。该集大小为 </span><span class='math-in-toc'>$|A|=\Sigma_{i=1}^{[A]}A_{c_i}$</span><span>。</span></p><p><span>用到最后除掉多统计部分的思想。全排列大小为 </span><span class='math-in-toc'>$\frac{|A|!}{\prod_{i=1}^{[A]}A_{c_i}!}$</span><span>。</span></p><p><span>如果是普通的排列组合，则需要用到容斥的思想，如下：</span></p><p><span>对于其组合，先考虑这么一个问题：有 </span><span class='math-in-toc'>$n=[A]$</span><span> 个篮子，把 </span><span class='math-in-toc'>$m=|A|$</span><span> 个元素扔进去的方案数。这种问题常见的处理方法就是隔板法。显然答案就是 </span><span class='math-in-toc'>$C_{n+m-1}^{n-1}$</span><span>。</span></p><p><span>接下来，我们考虑对于一般的情况。一般的情况其实和上面的问题的本质区别就在于上面的相当于每种元素无限取，而实际上每种元素是有限制的。最多就是其个数。</span></p><p><span>那么我们其实真的很容易就可以想到容斥。枚举每一种元素超没有，如果第 </span><span class='math-in-toc'>$i$</span><span> 种元素超了就预先分配 </span><span class='math-in-toc'>$A_{c_i}+1$</span><span> 个给他，然后奇偶加减类容斥就完了。一般的排列也有类似的方法，这里不做赘述。</span></p><h2><a name="bsgs大步小步-与-exbsgs" class="md-header-anchor"></a><span>BSGS(大步小步) 与 EXBSGS</span></h2><p><span class='math-in-toc'>$\texttt{BS(Baby step) leads to GS(Giant staep).}$</span></p><p><span>BSGS 可以在 </span><span class='math-in-toc'>$O(\sqrt p)$</span><span> 的时间内求解出 </span><span class='math-in-toc'>$a^x\equiv b\pmod p$</span><span> 的最小解，满足 </span><span class='math-in-toc'>$p$</span><span> 是质数。思路如下：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n3670" cid="n3670" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><script type="math/tex; mode=display">\texttt{let }m=\lceil\sqrt p\rceil \\
\texttt{let }x=i\times m-j (i\in[1,m],j\in[0,m-1])\\
\therefore a^{i\times m-j}\equiv b\pmod p \\
\therefore (a^m)^i\equiv b\times a^j\pmod p</script></div></div><p><span>因此我们枚举 </span><span class='math-in-toc'>$j$</span><span>，将 </span><span class='math-in-toc'>$b\times a^j$</span><span> 最后一次出现的位置的 </span><span class='math-in-toc'>$j$</span><span> 存到 </span><span class='math-in-toc'>$b\times a^j$</span><span> 对应的位置（一般用 </span><code>unordered_map</code><span>），直接覆盖原有数据就行。</span></p><p><span>接下来，我们顺序枚举 </span><span class='math-in-toc'>$i$</span><span>，一旦发现在 </span><code>unordered_map</code><span> 中存在 </span><span class='math-in-toc'>$(a^m)^i$</span><span>，就直接返回 </span><span class='math-in-toc'>$i\times m-val\_position[(a^m)^i]$</span><span>。如果 </span><span class='math-in-toc'>$i$</span><span> 枚举完了还没有返回就只能是无解了。</span></p><p><span>不难注意到 </span><span class='math-in-toc'>$x\in[1,m^2]$</span><span>，无法枚举到 </span><span class='math-in-toc'>$0$</span><span>，因此需要特判这种情况。</span></p><p><span>在 </span><span class='math-in-toc'>$i$</span><span> 较小的情况下 </span><span class='math-in-toc'>$j$</span><span> 越大 </span><span class='math-in-toc'>$x$</span><span> 越小。正确性比较显然，时间复杂度也必然正确。</span></p><p><span>哈哈，数论题的拓展最喜欢的就是去除各种互质/是质数一类的限制了！他也跑不掉。思路如下：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n3676" cid="n3676" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><script type="math/tex; mode=display">\because a^x\equiv b \pmod p \\
\therefore a^x + py = b \\
\texttt{let }d_1 = \gcd(a,p) \\
\therefore a^{x-1}\times\frac{a}{d_1}+\frac{p}{d_1}y=\frac{b}{d_1} \\
\texttt{if }\frac{b}{d_1}\notin\mathbb{N}: \texttt{no solution}\\
\texttt{let }d_2=\gcd(a,\frac{p}{d_1}) \\
\therefore a^{x-2}\times(a/d_1)\times(a/d_2)+\frac{p}{d_1d_2}y=\frac{b}{d_1d_2} \\
\texttt{if }\frac{b}{d_1d_2}\notin\mathbb{N}: \texttt{no solution}\\
......(until) \\
d_{k+1}=\gcd(a,\frac{p}{\prod_{i=1}^k d_i}) = 1 \\
\texttt{let }D = \prod_{i=1}^k d_i \\
\therefore a^{x-k}\times\frac{a^k}{D}+\frac{p}{D}y=\frac{b}{D} \\
\therefore a^{x-k}\times\frac{a^k}{D}\equiv\frac{b}{D} \pmod{\frac{p}{D}} \\
\texttt{let }z = x - k \\
\therefore a^z \equiv \frac{b}{D}*(\frac{a^k}{D})^{-1} \pmod{\frac{p}{D}} \\
ans = z + k</script></div></div><p><span>于是问题被转化为普通的 BSGS。注意上面 </span><span class='math-in-toc'>$\frac{p}{D}$</span><span> 不一定是质数，因此 </span><span class='math-in-toc'>$(\frac{a^k}{D})$</span><span> 的逆元要使用 EXGCD 求解。</span></p><h2><a name="生成函数" class="md-header-anchor"></a><span>生成函数</span></h2><p><span>一些前置概念，在后面多个板块会用到。</span></p><p><span>积性函数：满足 </span><span class='math-in-toc'>$f(ab)=f(a)\times f(b)(\gcd(a,b)=1)$</span><span>。</span></p><p><span>那么，知道因式分解时有：</span></p><p><span class='math-in-toc'>$f(p_1^{c_1}\times p_2^{c_2}\times\dots)=f(p_1^{c_1})\times f(p_2^{c_2})\times\dots$</span><span>。</span></p><p><span>常见积性函数：</span></p><p><span class='math-in-toc'>$\sigma_n$</span><span>：</span><span class='math-in-toc'>$n$</span><span> 的因子数。</span></p><p><span class='math-in-toc'>$\mu_n$</span><span>：莫比乌斯函数。</span></p><p><span class='math-in-toc'>$\varphi_n$</span><span>：欧拉函数</span></p><p><span class='math-in-toc'>$d_n$</span><span>：</span><span class='math-in-toc'>$n$</span><span> 的约数个数。</span></p><p><span class='math-in-toc'>$e_n$</span><span>：</span><span class='math-in-toc'>$[n=1]$</span><span>。</span></p><p><span class='math-in-toc'>$I_n=1$</span><span>。（常见写为 </span><span class='math-in-toc'>$1_n$</span><span>）。</span></p><p><span class='math-in-toc'>$id_n=n$</span><span>。（常见写为 </span><span class='math-in-toc'>$I,Id$</span><span>）。</span></p><h3><a name="普通生成函数" class="md-header-anchor"></a><span>普通生成函数</span></h3><p><span>对于数列 </span><span class='math-in-toc'>$A_i(i\in[0,n])$</span><span>，其 OGF 为 </span><span class='math-in-toc'>$A(x)=\Sigma_{i=0}^nA_ix^i$</span><span>。</span></p><p><span>看起来不知道有什么用，给个例题：有三种物品，每种物品分别有 </span><span class='math-in-toc'>$3,2,3$</span><span> 个，问从这三种物品里面拿出 </span><span class='math-in-toc'>$4$</span><span> 个的方案数有多少种？</span></p><p><span>假设 </span><span class='math-in-toc'>$f(i,j)$</span><span>：转移到物品 </span><span class='math-in-toc'>$i$</span><span>，已经选了 </span><span class='math-in-toc'>$j$</span><span> 个。</span></p><p><span>能不能更方便一些？</span></p><p><span>对每一个数生成出其生成函数(</span><span class='math-in-toc'>$A1_i=A3_i=1,i\in[0,3],A2_i=1,i\in[0,2]$</span><span>)，即 </span><span class='math-in-toc'>$A1(x)=A3(x)=1+x+x^2+x^3$</span><span>，</span><span class='math-in-toc'>$A2(x)=1+x+x^2$</span><span>。令 </span><span class='math-in-toc'>$F(x)=A1(x)A2(x)A3(x)$</span><span>，则答案为 </span><span class='math-in-toc'>$[x^4]F(x)$</span><span>，即 </span><span class='math-in-toc'>$x^4$</span><span> 的系数。</span></p><p><span>其实生成函数的系数之间的乘法对应了你手数时每一项选择的过程。</span></p><p><span>需要注意的是，这些生成函数往往可能会涉及到无穷的累加。请别忘了我们还有展开式，无穷序列加起来可能会变成之前的分式。</span></p><p><span>典型手算例题有</span><a href='https://www.luogu.com.cn/problem/P10780'><span>《干饭》</span></a><span>和</span><a href='https://www.luogu.com.cn/problem/P2000'><span>《末日时在干什么》</span></a><span>。（不正经.jbg）</span></p><p><span>其实我们不难看出，绝大多数的情况下，</span><span class='math-in-toc'>$A$</span><span> 数组都只会涉及到 </span><span class='math-in-toc'>$0,1$</span><span> 两种值，来表示可不可取。拆解的时候多使用换元法，因式分解法，往往会有奇效。</span></p><p><span>补充一个公式：</span><span class='math-in-toc'>$\Sigma_{i=0}^kx^i=\frac{1-x^{k+1}}{1-x}$</span><span>。</span></p><h3><a name="指数生成函数" class="md-header-anchor"></a><span>指数生成函数</span></h3><p><span>对于数列 </span><span class='math-in-toc'>$A_i(i\in[0,n])$</span><span>，其 EGF 为 </span><span class='math-in-toc'>$A(x)=\Sigma_{i=0}^nA_i\frac{x^i}{i!}$</span><span>。</span></p><p><span>对于大部分带标号的问题，可能会有类似的形式：</span><span class='math-in-toc'>$f(i)f(j)(_i^{i+j})=f(i+j)$</span><span>。一个典型的例子就是多重集的排列。</span></p><p><span>有 </span><span class='math-in-toc'>$f(i)f(j)\frac{(i+j)!}{i!j!}=f(i+j)$</span><span>，即 </span><span class='math-in-toc'>$\frac{f(i)}{i!}\times\frac{f(j)}{j!}=\frac{f(i+j)}{(i+j)!}$</span><span>。</span></p><p><span>因此这么定义。这里较为常用的公式是关于 </span><span class='math-in-toc'>$e$</span><span> 的泰勒展开。</span></p><p><span>有一个公式需要记一下：</span></p><p><span class='math-in-toc'>$\Sigma_{i=0}^{ \inf}\frac{x^{2i}}{(2i)!}=\frac{e^x+e^{-x}}{2}$</span><span>。证明显然，展开后就是了。</span></p><p><span>一个典型的应用就是求可重集的排列数。</span><a href='https://vjudge.net/problem/HDU-1521'><span>如题</span></a><span>，代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;iostream&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">m</span>; <span class="cm-variable-3">long</span> <span class="cm-variable-3">double</span> <span class="cm-variable">v</span>[<span class="cm-number">15</span>][<span class="cm-number">205</span>], <span class="cm-variable">vt</span>[<span class="cm-number">205</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">vset</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">a</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">a</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>, <span class="cm-variable">j</span> <span class="cm-operator">*=</span> <span class="cm-variable">i</span>) <span class="cm-variable">v</span>[<span class="cm-variable">p</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-number">1.0</span> <span class="cm-operator">/</span> <span class="cm-variable">j</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">tim</span>(<span class="cm-variable-3">long</span> <span class="cm-variable-3">double*</span> <span class="cm-variable">l</span>, <span class="cm-variable-3">long</span> <span class="cm-variable-3">double*</span> <span class="cm-variable">r</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">100</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">j</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">100</span>; <span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">vt</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-variable">j</span>] <span class="cm-operator">+=</span> <span class="cm-variable">l</span>[<span class="cm-variable">i</span>] <span class="cm-operator">*</span> <span class="cm-variable">r</span>[<span class="cm-variable">j</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">200</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">l</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">vt</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">vt</span>, <span class="cm-number">0</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">vt</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">n</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">m</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">v</span>, <span class="cm-number">0</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">v</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">a</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">a</span>, <span class="cm-variable">vset</span>(<span class="cm-variable">i</span>, <span class="cm-variable">a</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">tim</span>(<span class="cm-variable">v</span>[<span class="cm-number">1</span>], <span class="cm-variable">v</span>[<span class="cm-variable">i</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">m</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">v</span>[<span class="cm-number">1</span>][<span class="cm-variable">m</span>] <span class="cm-operator">*=</span> <span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">printf</span>(<span class="cm-string">"%.0Lf"</span>, <span class="cm-variable">v</span>[<span class="cm-number">1</span>][<span class="cm-variable">m</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 529px;"></div><div class="CodeMirror-gutters" style="display: none; height: 529px;"></div></div></div></pre><h3><a name="狄利克雷生成函数" class="md-header-anchor"></a><span>狄利克雷生成函数</span></h3><p><span>对于</span><strong><span>无穷</span></strong><span>数列 </span><span class='math-in-toc'>$A_i(i\in[1,\infin))$</span><span>，其 DGF 为 </span><span class='math-in-toc'>$A(x)=\Sigma_{i=1}^n\frac{A_i}{i^x}$</span><span>。</span></p><p><span>如果 </span><span class='math-in-toc'>$A$</span><span> 满足积性，那么其 DGF 也可以由质数幂处的取值表示为 </span><span class='math-in-toc'>$A(x)=\prod_{p\in \mathbb{P}}(1+\frac{f_p}{p^x}+\frac{f_{p^2}}{p^{2x}}+\frac{f_{p^3}}{p^{3x}}+\dots)$</span><span>。</span></p><p><span>有一些常见的 DGF，可以记一下。</span></p><p><span>黎曼函数 </span><span class='math-in-toc'>$\zeta$</span><span> 可用序列定义为 </span><span class='math-in-toc'>$[1,1,1,1,\dots]$</span><span>，另一种形式为 </span><span class='math-in-toc'>$\zeta(x)=\prod_{p\in \mathbb{P}}\frac{1}{1-p^{-x}}$</span><span>。</span></p><p><span>莫比乌斯函数的 DGF 定义为 </span><span class='math-in-toc'>$\tilde{M}(x)=\prod_{p\in \mathbb{P}}(1-p^{-x})$</span><span>。也就是说，</span><span class='math-in-toc'>$\zeta(x)\tilde{M}(x)=1$</span><span>。</span></p><p><span>欧拉函数的 DGF 定义为 </span><span class='math-in-toc'>$\tilde{\Phi}(x)=\prod_{p\in \mathbb{P}}\frac{1-p^{-x}}{1-p^{1-x}}$</span><span>。也就是说 </span><span class='math-in-toc'>$\tilde{\Phi}(x)\zeta(x)=\zeta(x-1)$</span><span>。</span></p><h2><a name="狄利克雷卷积" class="md-header-anchor"></a><span>狄利克雷卷积</span></h2><p><span>若 </span><span class='math-in-toc'>$f=h\times g$</span><span>，则令 </span><span class='math-in-toc'>$f(x)=\Sigma_{d|x}h(d)\times g(x/d)$</span><span>。</span></p><p><span class='math-in-toc'>$f,g$</span><span> 积性，则 </span><span class='math-in-toc'>$f\times g$</span><span> 积性。</span></p><p><span class='math-in-toc'>$f\times e=f$</span></p><p><span class='math-in-toc'>$\varphi\times I=id$</span></p><p><span class='math-in-toc'>$\mu\times I=e$</span></p><p><span>若 </span><span class='math-in-toc'>$f\times g=e$</span><span>，则称 </span><span class='math-in-toc'>$f,g$</span><span> 互逆。</span></p><p><span>可以做到 </span><span class='math-in-toc'>$O(n\log\log n)$</span><span> 求 </span><span class='math-in-toc'>$g=f\times I$</span><span> 或 </span><span class='math-in-toc'>$g=f\times\mu$</span><span>。</span></p><p><span>对于其余的卷积，其复杂度一般为 </span><span class='math-in-toc'>$O(n\ln n)$</span><span>，调和级数。</span></p><h2><a name="莫比乌斯反演" class="md-header-anchor"></a><span>莫比乌斯反演</span></h2><p><span>本质：</span><span class='math-in-toc'>$\mu\times I=e$</span><span>。</span></p><p><span>证明：</span><span class='math-in-toc'>$\Sigma_{d|n}\mu_d=\Sigma_iC_{\omega_n}^i(-1)^i=(1-1)^{\omega_n}=[n=1]$</span><span>。</span></p><p><span>其中的 </span><span class='math-in-toc'>$\omega_n$</span><span> 指 </span><span class='math-in-toc'>$n$</span><span> 的质因子个数。</span></p><p><span class='math-in-toc'>$f=g\times I$</span><span>，</span><span class='math-in-toc'>$f(n)=\Sigma_{d|n}g(d)$</span><span>。</span></p><p><span>则有 </span><span class='math-in-toc'>$g=f\times\mu$</span><span>，</span><span class='math-in-toc'>$g(n)=\Sigma_{d|n}f(d)\mu(n/d)$</span><span>。显然，函数的逆放到这里一定成立。</span></p><p><span>主要应用就是拆 </span><span class='math-in-toc'>$\gcd$</span><span>。套路就是去枚举 </span><span class='math-in-toc'>$\gcd$</span><span> 的值，然后对取等条件作卷积。</span></p><p><span>最常用的场景就是 </span><span class='math-in-toc'>$[p=1]=\Sigma_{d|p}\mu(d)$</span><span>，尤其是 </span><span class='math-in-toc'>$[\gcd(a,b)=1]$</span><span> 的形式。</span></p><p><span>一种较为常见的形式是求 </span><span class='math-in-toc'>$\sum_{i=1}^n\sum_{j=1}^m f(\gcd(i,j))$</span><span>。这时候我们构造函数 </span><span class='math-in-toc'>$g$</span><span>，满足 </span><span class='math-in-toc'>$f(x)=g*I=\sum_{d|x}g(d)$</span><span>。原式转化为 </span><span class='math-in-toc'>$\sum_{i=1}^n\sum_{j=1}^m\sum_{d|gcd(i,j)}g(d)=\sum_{d=1}g(d)\lfloor\frac{n}{d}\rfloor\lfloor\frac{m}{d}\rfloor$</span><span>。</span></p><p><span>典型例题就是</span><a href='https://www.luogu.com.cn/problem/P3455'><span>这道题</span></a><span>。</span></p><h2><a name="杜教筛" class="md-header-anchor"></a><span>杜教筛</span></h2><p><span>杜教筛是个神奇的东西，对于 </span><span class='math-in-toc'>$\forall \gcd(i,j)=1$</span><span>，满足 </span><span class='math-in-toc'>$f(i)\times f(j)=f(ij)$</span><span> 的函数，也就是积性函数，它可以在 </span><span class='math-in-toc'>$O(n^{\frac{3}{4}})$</span><span> 的时间复杂度内求出 </span><span class='math-in-toc'>$\sum_{i=1}^n f(i)$</span><span>。通过合适的预处理可以降到 </span><span class='math-in-toc'>$O(n^{\frac{2}{3}})$</span><span>。</span></p><p><span>具体的，对于一个积性函数 </span><span class='math-in-toc'>$f(x),F(x)=\sum_{i=1}^xf(x)$</span><span> 的话，我们可以知道 </span><span class='math-in-toc'>$g(1)F(x)=\sum_{i=1}^n(f*g)(i)-\sum_{i=2}^ng(i)F(\lfloor\frac{n}{i}\rfloor)$</span><span>。</span></p><p><span>其中 </span><span class='math-in-toc'>$*$</span><span> 表示的是迪利克雷卷积。</span></p><p><span>于是，我们可以使用记忆化与整除分块来做上述操作。时间复杂度证明略。注意当且仅当处理到了 </span><span class='math-in-toc'>$n^\frac{2}{3}$</span><span> 的时候才有 </span><span class='math-in-toc'>$O(n^\frac{2}{3})$</span><span> 的求解复杂度。递归求解即可。</span></p><p><span>模板题</span><a href='https://www.luogu.com.cn/problem/P4213'><span>在这里</span></a><span>。</span></p><h2><a name="第一类斯特林数" class="md-header-anchor"></a><span>第一类斯特林数</span></h2><p><span>第一类斯特林数有通用标记：</span><span class='math-in-toc'>$[_m^n]$</span><span>。他表示的组合意义是将 </span><span class='math-in-toc'>$n$</span><span> 个人分配到 </span><span class='math-in-toc'>$m$</span><span> 个</span><strong><span>非空</span></strong><span>环上的本质不同的方案数。其中环不作标号区分，人做区分。</span></p><p><span>那么它怎么求呢？显然我们可以整出来一些递推式。我们怎么从 </span><span class='math-in-toc'>$[_?^{n-1}]$</span><span> 推到 </span><span class='math-in-toc'>$[_?^n]$</span><span> 呢？也就是多了一个人会多产生哪些情况呢？</span></p><p><span>首先，它可以新开一桌，从 </span><span class='math-in-toc'>$[_{m-1}^{n-1}]$</span><span> 推到 </span><span class='math-in-toc'>$[_m^n]$</span><span>，系数为 </span><span class='math-in-toc'>$1$</span><span>。</span></p><p><span>其次，他可以加入原有的位置。显然，因为是圆桌，</span><span class='math-in-toc'>$n-1$</span><span> 个人就会有 </span><span class='math-in-toc'>$n-1$</span><span> 个本质不同的空隙。因此可以从 </span><span class='math-in-toc'>$[_m^{n-1}]$</span><span> 推到 </span><span class='math-in-toc'>$[_m^n]$</span><span>，系数为 </span><span class='math-in-toc'>$(n-1)$</span><span>。</span></p><p><span>从而，</span><span class='math-in-toc'>$[_m^n]=[_{m-1}^{n-1}]+(n-1)\times[_m^{n-1}]$</span><span>。边界条件为 </span><span class='math-in-toc'>$[_0^0]=[_1^1]=1,[_1^x]=[_x^1]=0(x\neq1)$</span><span>。</span></p><p><span>通过其组合意义，我们可以推知如下式子：</span></p><ol start='' ><li><span class='math-in-toc'>$[_1^n]=(n-1)! $</span></li><li><span class='math-in-toc'>$[_{n-1}^n]=(_2^n)$</span></li><li><span class='math-in-toc'>$[_2^n]=(n-1)!\sum_{i=1}^{n-1}\frac{1}{i}$</span></li><li><span class='math-in-toc'>$[_{n-2}^n]=2\times(_3^n)+3\times(_4^n)$</span></li></ol><p><span>比如有这么一个</span><a href='https://www.luogu.com.cn/problem/P4609'><span>例题</span></a><span>。思路就是将能看到的和被他挡住的视为一个环进行求解。</span></p><h2><a name="第二类斯特林数" class="md-header-anchor"></a><span>第二类斯特林数</span></h2><p><span>第二类斯特林数也有通用标记：</span><span class='math-in-toc'>$\{_m^n\}$</span><span>。他表示的组合意义是将 </span><span class='math-in-toc'>$n$</span><span> 个人分配到 </span><span class='math-in-toc'>$m$</span><span> 个</span><strong><span>非空</span></strong><span>无序集上的本质不同的方案数。其中环不作标号区分，人做区分。</span></p><p><span>那么它怎么求呢？显然我们可以整出来一些递推式。我们怎么从 </span><span class='math-in-toc'>$\{_?^{n-1}\}$</span><span> 推到 </span><span class='math-in-toc'>$\{_?^n\}$</span><span> 呢？也就是多了一个人会多产生哪些情况呢？</span></p><p><span>首先，它可以新开一个集合，从 </span><span class='math-in-toc'>$\{_{m-1}^{n-1}\}$</span><span> 推到 </span><span class='math-in-toc'>$\{_m^n\}$</span><span>，系数为 </span><span class='math-in-toc'>$1$</span><span>。</span></p><p><span>其次，他可以加入原有的位置。显然，本质不同的就是 </span><span class='math-in-toc'>$m$</span><span> 个集合。因此可以从 </span><span class='math-in-toc'>$\{_m^{n-1}\}$</span><span> 推到 </span><span class='math-in-toc'>$\{_m^n\}$</span><span>，系数为 </span><span class='math-in-toc'>$m$</span><span>。</span></p><p><span>从而，</span><span class='math-in-toc'>$\{_m^n\}=\{_{m-1}^{n-1}\}+m\times\{_m^{n-1}\}$</span><span>。边界条件为 </span><span class='math-in-toc'>$\{_0^0\}=1$</span><span>。</span></p><p><span>通过其组合意义，我们可以推知如下式子：</span></p><ol start='' ><li><span class='math-in-toc'>$\{_1^n\}=1$</span></li><li><span class='math-in-toc'>$\{_2^n\}=2^{n-1}-1$</span></li><li><span class='math-in-toc'>$\{_3^n\}=\frac{1}{2}(3^{n-1}+1)-2^{n-1}$</span></li><li><span class='math-in-toc'>$\{_{n-1}^n\}=(_2^n)$</span></li><li><span class='math-in-toc'>$\{_{n-2}^n\}=(_3^n)+3\times(_4^n)$</span></li><li><span class='math-in-toc'>$\{_{n-3}^n\}=(_4^n)+10\times(_5^n)+15\times(_6^n)$</span></li><li><span class='math-in-toc'>$\{_m^n\}=\frac{1}{m!}\sum_{i=1}^m(-1)^{m-i}\times i^n\times(_i^m)$</span></li></ol><p><a href='https://vjudge.net/problem/HDU-4045'><span>这个</span></a><span>例题就行，一眼差不多能出思路，而且不太板。</span></p><h2><a name="斯特林反演" class="md-header-anchor"></a><span>斯特林反演</span></h2><p><span>按照之前的整理，其本体其实长这样：</span></p><p><span>若</span><span class='math-in-toc'>$f_n=\Sigma_{i=0}^n\{_i^n\}g_i$</span><span>，则 </span><span class='math-in-toc'>$g_n=\Sigma_{i=0}^n(-1)^{n-i}[_i^n]f_i$</span><span>。</span></p><p><span>若</span><span class='math-in-toc'>$f_n=\Sigma_{k=n}^{ \inf}\{_n^k\}g_k$</span><span>，则 </span><span class='math-in-toc'>$g_n=\Sigma_{k=n}^{ \inf}(-1)^{k-n}[_n^k]f_k$</span><span>。</span></p><p><span>不过，这次我们着重讲的是 </span><span class='math-in-toc'>$n^m$</span><span> 和 </span><span class='math-in-toc'>$n^{\underline{m}}$</span><span> 之间的转化。</span></p><p><span>所以，要下降幂干什么呢？下降幂有如下两种美丽的变化：</span></p><p><span class='math-in-toc'>$n^{\underline{m}}=\prod_{i=0}^{m-1}(n-i)=\frac{n!}{(n-m)!}=(_m^n)\times m!$</span><span>。这两个看起来就挺有用的。</span></p><p><span>所以，怎么变呢？</span></p><p><span class='math-in-toc'>$x^{\underline{n}}=\sum_{k=0}^n[_k^n](-1)^{n-k}x^k$</span><span>。</span></p><p><span class='math-in-toc'>$x^n=\sum_{i=0}^n{_i^n}n^{\underline{i}}$</span><span>。</span></p><p><span>可以通过组合意义较容易地证明出下面的那个式子。或者数学归纳法也是可以的。如图：</span></p><p><img src="https://www.helloimg.com/i/2025/03/14/67d42b265a637.png" referrerpolicy="no-referrer"></p><p><span>变换完之后可能可以和前面的一些项合并，换位等，得到一个好处理的式子。</span></p><p><span>这两天没有自己手推出来的比较好的式子，放一个</span><a href='https://www.luogu.com.cn/article/6ht5dwbw'><span>题解</span></a><span>做样例吧，对应</span><a href='https://www.luogu.com.cn/problem/CF1278F'><span>这道题</span></a><span>。</span></p><h2><a name="二项式反演" class="md-header-anchor"></a><span>二项式反演</span></h2><p><a href='https://www.cnblogs.com/GDOI2018/p/14491894.html'><span>flag</span></a><span>。</span></p><p><span>若 </span><span class='math-in-toc'>$g_n=\Sigma_{i=0}^nC_n^if_i$</span><span>，则 </span><span class='math-in-toc'>$f_n=\Sigma_{i=0}^nC_n^i(-1)^{n-i}g_i$</span><span>。</span></p><p><span>证明：错排问题。</span></p><p><span>我们让 </span><span class='math-in-toc'>$g_n$</span><span> 表示 </span><span class='math-in-toc'>$n$</span><span> 个人随便站的方案数，</span><span class='math-in-toc'>$f_n$</span><span> 表示恰好 </span><span class='math-in-toc'>$n$</span><span> 个人站错的方案数，显然满足了第一个式子，而对于第二个式子而言也是适用的。</span></p><p><span>二项式反演可以实现“至多”/“至少”和恰好之间的转化。</span></p><p><span>同理也有：若 </span><span class='math-in-toc'>$g_k=\Sigma_{i=k}^nC_i^kf_i$</span><span>，则 </span><span class='math-in-toc'>$f_k=\Sigma_{i=k}^nC_i^k(-1)^{i-k}g_i$</span><span>。</span></p><p><span>上述的两个式子是比较常用的两个。从本质思想来讲呢，这两个式子都是类似于容斥的形式推出来的。</span></p><p><span>也就是说，如果我能够构造出来一对合理的 </span><span class='math-in-toc'>$f,g$</span><span>，那他一定对应着一种组合意义下的容斥方式。</span></p><p><span>所以，二项式反演提供了一种更加快速的找容斥关系的方式，而容斥因其逻辑更加底层，反而能解决更多的题。</span></p><p><span>当然这么说有点绝对。既然是一个反演，那他一般有超出其根源的用途。在解决一些计数问题的过程中，二项式反演公式对简化问题有着重要的作用。只是例题目前不太有体现。</span></p><h2><a name="burnside定理" class="md-header-anchor"></a><span>Burnside定理</span></h2><p><span>Burnside定理：</span><span class='math-in-toc'>$L=\frac{1}{|G|}\sum_{g\in G}f(g)$</span><span>。其中 </span><span class='math-in-toc'>$G$</span><span> 是所有置换所构成的集合，</span><span class='math-in-toc'>$f(g)$</span><span> 是置换 </span><span class='math-in-toc'>$g$</span><span> 对应的本质不同的集合的个数。</span></p><p><span>怎么理解呢？例题：有 </span><span class='math-in-toc'>$2$</span><span> 种颜色的珠子，你要用他们来构成一个有 </span><span class='math-in-toc'>$4$</span><span> 个珠子的手环，问有多少种本质不同的手环。这里本质不同定义为旋转或翻转后二者仍不同。</span></p><p><span>那么，其置换包括旋转 </span><span class='math-in-toc'>$0/90/180/270$</span><span> 度，沿对角线/对边线翻转，共 </span><span class='math-in-toc'>$8$</span><span> 种。</span><span class='math-in-toc'>$f(g)$</span><span> 是指的置换 </span><span class='math-in-toc'>$g$</span><span> 对应的本质不同的集合的个数。也就是求经过置换 </span><span class='math-in-toc'>$g$</span><span> 后仍一样的方案数。</span></p><p><span>例如：</span></p><p><img src="https://www.helloimg.com/i/2025/03/19/67da6f0c95a79.png" referrerpolicy="no-referrer"></p><p><span>对角线上的分别属于两组，因此总共有 </span><span class='math-in-toc'>$2^2=4$</span><span> 种本质不同的手环。</span></p><p><img src="https://www.helloimg.com/i/2025/03/19/67da6f054a141.png" referrerpolicy="no-referrer"></p><p><span>总共有三组，因此共有 </span><span class='math-in-toc'>$2^3=8$</span><span> 种本质不同的手环。</span></p><p><span>因此，最终的答案为 </span><span class='math-in-toc'>$\frac{2^4+2^1+2^2+2^1+2^2+2^2+2^3+2^3}{8}=6$</span><span> 种。分子上的每一项依次对应转 </span><span class='math-in-toc'>$0/90/180/270$</span><span> 度，两种沿着对边翻，两种沿着对角翻。</span></p><p><span>往往需要静下心来推一下 </span><span class='math-in-toc'>$f(g)$</span><span>，给一道</span><a href='https://vjudge.net/problem/HDU-3547'><span>例题</span></a><span>。</span></p><h2><a name="polya定理" class="md-header-anchor"></a><span>Polya定理</span></h2><p><span>Polya 定理可以视为是 Burnside定理在较简单的问题上的特例化。其式子如下：</span></p><p><span class='math-in-toc'>$L=\frac{1}{|G|}\sum_{g\in G}m^{c(g)}$</span><span>。</span></p><p><span>肉眼可见的，这里我们认为 </span><span class='math-in-toc'>$f(g)=m^{c(g)}$</span><span>。而如果我告诉你 </span><span class='math-in-toc'>$c(g)$</span><span> 表示的是置换 </span><span class='math-in-toc'>$g$</span><span> 的循环节数，这里的循环节是指的有向移动形成的环，那么这个公式的意义就更加明了，甚至不证自白了。</span></p><p><span>另给一道</span><a href='https://www.luogu.com.cn/problem/U548811'><span>例题</span></a><span>。</span></p><h2><a name="博弈论" class="md-header-anchor"></a><span>博弈论</span></h2><p><span>博弈论主要研究具有竞争或对抗性质的对象，在一定规则下产生的各种行为。博弈论考虑游戏中的个体的预测行为和实际行为，并研究它们的优化策略。</span></p><p><span>通俗地讲，博弈论主要研究的是：在一个游戏中，进行游戏的多位玩家的策略。</span></p><p><span>在 OI 中，我们也有时会遇到这些题。其中最常遇到的是公平组合游戏。参考这篇</span><a href='https://www.cnblogs.com/bloodstalk/p/17432761.html'><span>博客</span></a><span>。</span></p><p><span>首先，在 OI 当中，我们常研究的是平等博弈，也就是说，可允许的操作只和当前局面的状态而和操作的玩家无关。</span></p><h3><a name="公平组合游戏" class="md-header-anchor"></a><span>公平组合游戏</span></h3><p><span>若一个游戏满足：</span></p><ol start='' ><li><span>有两名玩家交替行动；</span></li><li><span>在游戏进程的任意时刻，可以执行的合法行动与轮到哪名玩家无关；</span>
<span>3.不能行动的玩家判负。</span></li></ol><p><span>则称该游戏为一个公平组合游戏。</span></p><p><span>这时候有一些比较重要的概念：有向图游戏，必胜态和必败态。</span></p><p><span>给定一个有向无环图，图中有一个唯一的起点，在起点上放有一枚棋子。两名玩家交替地把这枚棋子沿着有向边进行移动，每次可以移动一步，无法移动者判负。该游戏被称为有向图游戏。</span></p><p><span>那么不难发现，任何一个公平组合游戏都可以转化为有向图游戏。游戏状态为点，状态转移为边。</span></p><p><span>必胜态：存在一种策略，可以让剩余的状态变成必败态留给对手的局面。</span></p><p><span>必败态：不管采取什么策略，这一步行动后对手都处于必胜态的局面。</span></p><p><span>简化一下，就是三个定理，这也是博弈论的核心：</span></p><ul><li><span>没有后继状态的状态是必败态。</span></li><li><span>可以移动到必败态的是必胜态。</span></li><li><span>只能移动到必胜态的是必败态。</span></li></ul><p><span>这里举出若干公平组合游戏的例子。</span></p><p><span>Nim 游戏：</span></p><p><span>地上有 </span><span class='math-in-toc'>$n$</span><span> 堆石子，其中第 </span><span class='math-in-toc'>$i$</span><span> 堆有 </span><span class='math-in-toc'>$a_i$</span><span> 颗石子。每人每次可从任意一堆石子里取出任意多枚石子扔掉，可以取完，不能不取。每次只能从一堆里取。最后没石子可取的人就输了。问是否有先手必胜策略。</span></p><p><span>这时候，我们似乎无从下手，那让我们从有向图游戏的角度去下手，考虑图上的必胜态，必败态。</span></p><p><span>首先，有一个必败态是剩余石子全为 </span><span class='math-in-toc'>$0$</span><span>。不难发现他们全部异或起来为 </span><span class='math-in-toc'>$0$</span><span>。</span></p><p><span>随后我们发现了一个不得了的可能正确的结论：当且仅当 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i=0$</span><span> 时先手必败。</span></p><p><span>先证一个引理：当 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i\neq0$</span><span> 时，必定存在方案，将其中一个数变小之后满足 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i=0$</span><span>。</span></p><p><span>因为异或是二进制下的不进位加法，也就意味着异或值的最高位一定有至少一个数是 </span><span class='math-in-toc'>$1$</span><span>。这时候我们取其中任意一个数异或上现在这个值，他的值一定变小了，而且现在异或起来的值显然为 </span><span class='math-in-toc'>$0$</span><span>。</span></p><p><span>首先，充分性很容易证明。当先手拿掉一些石子，使其异或值变化时，我们一定存在一些方案使得其异或值变为 </span><span class='math-in-toc'>$0$</span><span>，也就是我们的引理。</span></p><p><span>必要性呢？当 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i\neq0$</span><span> 的时候我们可以构造使得 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i=0$</span><span>。而 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i=0$</span><span> 是必败态，从而 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i\neq0$</span><span> 是必胜态，也就是说必败态只可能 </span><span class='math-in-toc'>$\bigoplus_{i=1}^na_i=0$</span><span>。</span></p><p><span>证毕。</span><a href='https://www.luogu.com.cn/problem/P2197'><span>题目</span></a><span>。</span></p><p><span>台阶 Nim 游戏：</span></p><p><span>有 </span><span class='math-in-toc'>$n$</span><span> 级台阶，第 </span><span class='math-in-toc'>$i$</span><span> 级上有 </span><span class='math-in-toc'>$a_i$</span><span> 颗石子。每人每次可从任意一堆石子里取出任意多枚石子放到下一级台阶上，可以取完，不能不取。每次只能从一堆里取。最后没石子可取的人就输了。问是否有先手必胜策略。</span></p><p><span>首先，我们可以认为偶数级台阶上的是无效的。因为先手将若干颗移动到下一及后，后手可以再将这些石子移动到下一级从而将这堆石子再次移动到偶数级，最终移到 </span><span class='math-in-toc'>$0$</span><span>。</span></p><p><span>于是我们发现，将石子从奇数阶移动到偶数阶就是丢弃，将石子从偶数阶移动到奇数阶如果不能使奇数阶上的石子数异或值为 </span><span class='math-in-toc'>$0$</span><span> 就是白给。</span></p><p><span>而我们只通过将石子移下奇数阶就可以做到使奇数阶上的石子数异或值为 </span><span class='math-in-toc'>$0$</span><span>。</span></p><p><span>从而得出结论：</span><span class='math-in-toc'>$\bigoplus_{i=0}^{\lceil\frac{n-1}{2}\rceil}a_{i\times2+1}\neq0$</span><span> 时先手必胜。</span></p><p><span>证毕。</span><a href='https://www.luogu.com.cn/problem/T407141'><span>题目</span></a><span>。</span></p><p><span>Moore&#39;s Nimk：</span></p><p><span>两个人玩取石子游戏，共有 </span><span class='math-in-toc'>$n$</span><span> 堆石子，每个人每次可以从不超过 </span><span class='math-in-toc'>$k$</span><span> 堆石子里面取任意多个石子（不能不取），不能取的人输。问先手必胜条件。</span></p><p><span>给出结论了就可以用类似于上面的方法整出来了：将每一个数写成二进制形式，则如果每一位上 </span><span class='math-in-toc'>$1$</span><span> 的个数都是 </span><span class='math-in-toc'>$k+1$</span><span> 的倍数，则先手必败，否则先手必胜。</span></p><p><span>这个有前面的铺垫，读者自证不难？就不赘述了。</span></p><p><span>还有两个可能见到的，记一下结论就行了，因为证明有点怪怪的，有点脱离了我们之前所构建的体系，所以不详讲。</span></p><p><span>Wythoff 博弈：</span></p><p><span>有两堆石子，石子数可以不同。两人轮流取石子，每次可以在一堆中取，或者从两堆中取走相同个数的石子，数量不限，取走最后一个石头的人获胜。判定先手是否必胜。</span></p><p><span>先手必败当且仅当 </span><span class='math-in-toc'>$(b-a)\times\frac{\sqrt5+1}{2}=a$</span><span>，非严格判等，整数部分一样即可。</span></p><p><a href='https://blog.csdn.net/qq_41311604/article/details/79980882'><span>证明</span></a><span>。</span><a href='https://vjudge.net/problem/HDU-1527'><span>例题-1</span></a><span>，</span><a href='https://www.luogu.com.cn/problem/P2252'><span>例题-2</span></a><span>。</span></p><p><span>Fibonacci 博弈：</span></p><p><span>一堆个数为 </span><span class='math-in-toc'>$n$</span><span> 的石子，有两条规则：</span></p><ol start='' ><li><span>先手不能在第一次把所有的石子取完，至少取 </span><span class='math-in-toc'>$1$</span><span> 颗</span></li><li><span>之后每次可以取的石子数至少为 </span><span class='math-in-toc'>$1$</span><span>，至多为对手刚取的石子数的</span><span class='math-in-toc'>$2$</span><span>倍。</span></li></ol><p><span>约定取走最后一个石子的人是赢家，求先手必胜态。</span></p><p><span>先手必败当且仅当石子数为斐波那契数。</span><a href='https://vjudge.net/problem/51Nod-1070'><span>题目</span></a><span>。</span></p><h3><a name="sg-函数" class="md-header-anchor"></a><span>SG 函数</span></h3><p><span>这个也是相当的重要的。</span></p><p><span>首先有一个函数 </span><span class='math-in-toc'>$\operatorname{mex}(S)=min{x}(x\notin S,x\in \mathbb{N})$</span><span>。</span></p><p><span>假如说状态 </span><span class='math-in-toc'>$x$</span><span> 有 </span><span class='math-in-toc'>$k$</span><span> 个后继状态 </span><span class='math-in-toc'>$y_i$</span><span>，那么 </span><span class='math-in-toc'>$SG(x)=\operatorname{mex}({SG(y_1),SG(y_2),\dots,SG(y_k)})$</span><span>。</span></p><p><span>由于一般情况下没有后继状态的可以视为必败态，因此 </span><span class='math-in-toc'>$SG(x)=0$</span><span> 必败，反之必胜。因为 </span><span class='math-in-toc'>$SG$</span><span> 与必败必胜态极好的对应关系，其正确性不证自明。</span></p><p><span>最直接的应用就是 Bash 博弈和其拓展：集合型 Nim 游戏。</span></p><p><span>Bash 博弈：</span></p><p><span>总共有 </span><span class='math-in-toc'>$n$</span><span> 个石子，每次每人可以取 </span><span class='math-in-toc'>$[1,k]$</span><span> 个石子，问先手必胜状态。</span></p><p><span>先手必败当且仅当 </span><span class='math-in-toc'>$n\equiv0\pmod{k+1}$</span><span>。非常裸的 SG 函数，</span><span class='math-in-toc'>$SG(x)=x\mod(k+1)$</span><span>。递推可证。</span><a href='https://vjudge.net/problem/51Nod-1066'><span>题目</span></a><span>。</span></p><p><span>集合型 Nim 游戏：</span></p><p><span>给定 </span><span class='math-in-toc'>$m$</span><span> 个整数组成的集合 </span><span class='math-in-toc'>$a_i$</span><span>, 给定 </span><span class='math-in-toc'>$n$</span><span> 堆石子的数量 </span><span class='math-in-toc'>$b_i$</span><span>, 两位玩家轮流操作，每次操作可以从任意一堆石子中拿取石子，每次拿取的石子数量必须是集合 </span><span class='math-in-toc'>$a$</span><span> 中的整数，最后无法操作的人失败。判定先手是否必胜。</span></p><p><span>直接暴力推 SG 函数值就行了。</span><a href='https://www.luogu.com.cn/problem/T407132'><span>题目</span></a><span>。</span></p><p><span>移棋子游戏：</span></p><p><span>给定一个有 </span><span class='math-in-toc'>$n$</span><span> 个节点的有向无环图，图中某个节点上有棋子，两名玩家交替移动棋子。对于给定的图和棋子初始位置，双方都会采取最优的行动，询问先手必胜还是先手必败。</span></p><p><span>这样的话仍旧是非常裸的 SG，那我问你，如果图上有多个棋子呢？</span></p><p><span>答案很眼熟：当且仅当每个棋子的 SG 值异或起来为 </span><span class='math-in-toc'>$0$</span><span> 时先手必败证明：</span></p><p><span>不难发现这个问题和丢石子的那个问题是很像的。当你在某个非零状态下时你可以丢掉任意颗。虽然即使你一颗都不剩，你也可能可以做到增加，毕竟求的是 </span><span class='math-in-toc'>$\operatorname{mex}$</span><span>，但是这也意味着对手恒存在一些方法能给你变回来。当你不存在增加的变换的时候你的旅途也就到此为止了，只能老老实实地减。</span></p><p><span>而又因为你在某个非零状态下时你可以丢掉任意颗，所以你总能维护异或值为 </span><span class='math-in-toc'>$0$</span><span>。</span></p><p><span>证毕。</span><a href='https://www.luogu.com.cn/problem/T407130'><span>题目</span></a><span>。</span></p><p><span>相关的有许多变种，比如 Anti-SG，Multi-SG，Every-SG，可以自行参阅开头的博客。</span></p><p><span>随便给几道例题：</span><a href='https://vjudge.net/problem/51Nod-1067'><span>1</span></a><span>，</span><a href='https://vjudge.net/problem/51Nod-1068'><span>2</span></a><span>，</span><a href='https://www.luogu.com.cn/problem/T234805'><span>3</span></a><span>。</span></p><h2><a name="二次剩余" class="md-header-anchor"></a><span>二次剩余</span></h2><p><span>求解同余方程 </span><span class='math-in-toc'>$x^2\equiv n\pmod p$</span><span>。你可以假定 </span><span class='math-in-toc'>$x$</span><span> 有解且 </span><span class='math-in-toc'>$p$</span><span> 为奇素数。</span></p><p><span>若方程 </span><span class='math-in-toc'>$x^2 \equiv n \pmod p$</span><span> 有整数解，则称 </span><span class='math-in-toc'>$n$</span><span> 为模 </span><span class='math-in-toc'>$p$</span><span> 的二次剩余，否则称 </span><span class='math-in-toc'>$n$</span><span> 为模 </span><span class='math-in-toc'>$p$</span><span> 的二次非剩余。</span></p><p><span>先给出结论：寻找一个整数 </span><span class='math-in-toc'>$a$</span><span> 满足 </span><span class='math-in-toc'>$q=a^2-n$</span><span> 为模 </span><span class='math-in-toc'>$p$</span><span> 的非二次剩余，并定义 </span><span class='math-in-toc'>$i^2\equiv q\pmod p$</span><span>。答案就是 </span><span class='math-in-toc'>$(a+i)^{\frac{p+1}{2}}$</span><span>。</span></p><p><span>额，后面会证明出来 </span><span class='math-in-toc'>$(a+i)^{\frac{p+1}{2}}$</span><span> 没有“虚部”。</span></p><h3><a name="二次剩余判定定理" class="md-header-anchor"></a><span>二次剩余判定定理</span></h3><p><span class='math-in-toc'>$a^{\frac{p-1}{2}} \equiv 1 \pmod p$</span><span> 是 </span><span class='math-in-toc'>$a$</span><span> 为模 </span><span class='math-in-toc'>$p$</span><span> 的二次剩余的充要条件。</span></p><p><span>必要性显然，充分性：</span></p><p><span>令 </span><span class='math-in-toc'>$a=g^k$</span><span> ，其中 </span><span class='math-in-toc'>$g$</span><span> 为模 </span><span class='math-in-toc'>$p$</span><span> 意义下的原根。</span></p><p><span>将 </span><span class='math-in-toc'>$a=g^k$</span><span> 带入，得 </span><span class='math-in-toc'>$g^{\frac{k(p-1)}{2}} \equiv 1 \pmod p$</span><span>，所以 </span><span class='math-in-toc'>$\varphi(p) \mid \frac{k(p-1)}{2}$</span><span>，所以 </span><span class='math-in-toc'>$1|\frac{k}{2}$</span><span>，即 </span><span class='math-in-toc'>$k$</span><span> 是偶数。</span></p><p><span>所以，</span><span class='math-in-toc'>$g^{\frac{k}{2}}$</span><span> 为原方程的解，即 </span><span class='math-in-toc'>$a$</span><span> 为模 </span><span class='math-in-toc'>$p$</span><span> 的二次剩余。证毕。</span></p><p><span>同时我们也可以发现，因为 </span><span class='math-in-toc'>$a^{p-1}\equiv1\pmod p$</span><span>，所以 </span><span class='math-in-toc'>$a^{\frac{p-1}{2}}\equiv\pm1\pmod p$</span><span>，也就是说，</span><span class='math-in-toc'>$a^{\frac{p-1}{2}}\equiv-1\pmod p$</span><span> 是 </span><span class='math-in-toc'>$a$</span><span> 为模 </span><span class='math-in-toc'>$p$</span><span> 的二次非剩余的充要条件。</span></p><h3><a name="他至多有-2-个不同的解" class="md-header-anchor"></a><span>他至多有 </span><span class='math-in-toc'>$2$</span><span> 个不同的解</span></h3><p><span>假定 </span><span class='math-in-toc'>$x_1,x_2$</span><span> 是其中任意两个解，则 </span><span class='math-in-toc'>$x_1^2-x_2^2\equiv 0\pmod p$</span><span>，则 </span><span class='math-in-toc'>$(x_1+x_2)(x_1-x_2)\equiv 0\pmod p$</span><span>。因此 </span><span class='math-in-toc'>$x_1=x_2$</span><span> 或者 </span><span class='math-in-toc'>$x_1+x_2=p$</span><span>。因此最多只有两个不同的解。</span></p><p><span>以上两个定理保证了可解性。</span></p><p><span>接下来，我们推 </span><span class='math-in-toc'>$(a+i)^{p+1}$</span><span>，看看是什么东西。</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n3923" cid="n3923" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><script type="math/tex; mode=display">\begin{aligned}
&(a+i)^{p+1}\\
\equiv&(a+i)^p\times(a+i)\\
\equiv&(a^p+i^p)\times(a+i)+(\sum_{j=1}^{p-1}a^ji^{(p-j)}C_p^j)\\
\equiv&(a^p+i^p)\times(a+i)+(\sum_{j=1}^{p-1}a^ji^{(p-j)}\frac{p!}{j!(p-j)!})\\
\equiv&(a^p+i^p)\times(a+i)+p\times(\sum_{j=1}^{p-1}a^ji^{(p-j)}\frac{(p-1)!}{j!(p-j)!})\\
\equiv&(a^p+i^p)\times(a+i)\\
\equiv&(a+i^{p-1}\times i)\times(a+i)\\
\equiv&(a+q^\frac{p-1}{2}\times i)\times(a+i)\\
\equiv&(a-i)\times(a+i)\\
\equiv&a^2-i^2\\
\equiv&n\pmod p
\end{aligned}</script></div></div><p><span>又因为存在性定理，显然当存在解时会分别得出两个根，或者干脆就是 </span><span class='math-in-toc'>$0$</span><span>。因此 </span><span class='math-in-toc'>$(a+i)^{\frac{p+1}{2}}$</span><span> 没有“虚部”。</span></p><p><span>你问我怎么找合适的 </span><span class='math-in-toc'>$i$</span><span> 的话，其实不难发现二次剩余和二次非剩余正好一半一半，随机化的话期望 </span><span class='math-in-toc'>$2$</span><span> 次就能找到。相信自己的运气不会差到抽中 </span><span class='math-in-toc'>$\frac{1}{2^{(10^8)}}$</span><span>。</span></p><h2><a name="线性基" class="md-header-anchor"></a><span>线性基</span></h2><p><span>线性基，其概念可以视为向量的基底。</span></p><p><span>也就是说，假设给定元素集 </span><span class='math-in-toc'>$P$</span><span>，你可以构造出来另一个集合 </span><span class='math-in-toc'>$S$</span><span>，使得 </span><span class='math-in-toc'>$P$</span><span> 中所有元素都可以用 </span><span class='math-in-toc'>$S$</span><span> 中的元素表示，而 </span><span class='math-in-toc'>$S$</span><span> 中任意一个元素都没法只使用 </span><span class='math-in-toc'>$S$</span><span> 的其他元素表示出来。</span></p><p><span>不管怎么说，由于任何意义下的向量的美妙的性质，我们一定要保证 </span><span class='math-in-toc'>$S$</span><span> 中的每一个元素的第一个非零位置不重。</span></p><p><span>而这个东西在信息中，应该能感觉到是生来就有用的。毕竟他给出了一大坨信息的一种高效压缩方式。</span></p><p><span>事实上的确如此。在信息中，我们更多研究的是异或线性基。也就是说，我们只用 </span><span class='math-in-toc'>$S$</span><span> 中元素进行异或操作。</span></p><p><a href='https://www.cnblogs.com/bianchengmao/p/16713133.html'><span>这个博客</span></a><span>就挺好。另外，由于贪心能支持的面超过了高斯消元，且可以在 </span><span class='math-in-toc'>$\log^2V$</span><span> 的复杂度内转化，所以不整理高斯消元。</span></p><h3><a name="异或线性基" class="md-header-anchor"></a><span>异或线性基</span></h3><p><span>贪心怎么贪呢？首先从高位向低位扫，当这个数这一位是一时，如果线性基中没有元素最高位是当前位，那就把它放到线性基中，否则把他异或上线性基中的那个元素，继续进行。</span></p><p><span>接下来，我们可以应用一下，比如我们现在要求出来一堆数的最大异或值。</span></p><p><span>显然，我们从大到小去枚举，如果当前这一位为 </span><span class='math-in-toc'>$0$</span><span> 并且这一位有线性基，那就异或一下，否则不动。代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">liner_base</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">v</span>[<span class="cm-number">52</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">insert</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">a</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>;<span class="cm-variable">a</span>;<span class="cm-variable">i</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">a</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]) <span class="cm-variable">a</span> <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-keyword">return</span> <span class="cm-variable-3">void</span>(<span class="cm-variable">v</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">a</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">solve</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>;<span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span>(<span class="cm-variable">ret</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ret</span> <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ret</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">lb</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 391px;"></div><div class="CodeMirror-gutters" style="display: none; height: 391px;"></div></div></div></pre><p><span>但是这样还没完。如果很不巧他让你求 </span><span class='math-in-toc'>$k$</span><span> 小异或值，那你线性基不就炸了吗？</span></p><p><span>不好意思，没炸。仔细想一下，会导致大量策略出问题的地方就在于判断这一位为 </span><span class='math-in-toc'>$0$</span><span> 并且这一位有线性基。如果这一位有线性基就可以毫无顾虑地异或是不是就很简单了？</span></p><p><span>欸？如果我们强制保证是最高位的那些位仅在那一位的线性基上是 </span><span class='math-in-toc'>$1$</span><span> 不就做完了？</span></p><p><span>所以我们只需要对每个最高位的线性基进行检查，具体的如果比它更小的线性基在这一位有值就异或上他。从小到大进行检查即可。</span></p><p><span>或者，你用小线性基去消大线性基也是一个道理。当然这还没有结束，我们还需要求 </span><span class='math-in-toc'>$k$</span><span> 小异或值。</span></p><p><span>解除了刚才的制约，我们真的不难想到，当你选择了更大的线性基的时候，小的线性基也无力回天。</span></p><p><span>大的严格压制小的，且不影响小的，那就和线段树分治等等的没区别了。更加明显的，每一次选与不选恰是 </span><span class='math-in-toc'>$k$</span><span> 的二进制位！</span></p><p><span>唯一需要注意的就是有没有 </span><span class='math-in-toc'>$0$</span><span> 了。代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">liner_base</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">v</span>[<span class="cm-number">62</span>], <span class="cm-variable">cnt</span>, <span class="cm-variable">rv</span>[<span class="cm-number">62</span>]; <span class="cm-variable-3">bool</span> <span class="cm-variable">zer</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">insert</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">a</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">\\</span>...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">init</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">n</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cnt</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">60</span>;<span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>;<span class="cm-operator">--</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;<span class="cm-variable">j</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">60</span>;<span class="cm-operator">++</span><span class="cm-variable">j</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">v</span>[<span class="cm-variable">j</span>] <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>) <span class="cm-variable">v</span>[<span class="cm-variable">j</span>] <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">60</span>;<span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">v</span>[<span class="cm-variable">i</span>]) <span class="cm-variable">rv</span>[<span class="cm-variable">cnt</span><span class="cm-operator">++</span>] <span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">cnt</span> <span class="cm-operator">!=</span> <span class="cm-variable">n</span>) <span class="cm-variable">zer</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> <span class="cm-variable">zer</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">int</span> <span class="cm-variable">calc</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">k</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">zer</span>) <span class="cm-variable">k</span><span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">k</span> <span class="cm-operator">&gt;=</span> (<span class="cm-number">1ll</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">cnt</span>)) <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">cnt</span>;<span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">k</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>) <span class="cm-variable">ret</span> <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-variable">rv</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">ret</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">res</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">v</span>, <span class="cm-number">0</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">v</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">lb</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 621px;"></div><div class="CodeMirror-gutters" style="display: none; height: 621px;"></div></div></div></pre><h3><a name="前缀线性基" class="md-header-anchor"></a><span>前缀线性基</span></h3><p><span>这就很有生活了。他可以求解出一个数组在区间内的最大异或值！</span></p><p><span>怎么做到的呢？一句话：我只要最新版本。在下标 </span><span class='math-in-toc'>$i$</span><span> 时，先将 </span><span class='math-in-toc'>$i-1$</span><span> 位置的线性基拷贝过来，然后尝试加上 </span><span class='math-in-toc'>$i$</span><span> 位置的数。如果遇到空位就直接填进去。</span></p><p><span>如果这一位是 </span><span class='math-in-toc'>$1$</span><span> 且此位有线性基，那就比较二者的最后更新时间（初始状态下当前持有值的最后更新时间为 </span><span class='math-in-toc'>$i$</span><span>），如果持有值更新，就顶替原有值，并将手上拿的改为原有值。</span></p><p><span>做完了操作之后再异或一下手上的值（和线性基值），直到手上的值为 </span><span class='math-in-toc'>$0$</span><span> 或者填上坑了。</span></p><p><span>代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">ins</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">k</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">c</span><span class="cm-operator">++</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">np</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memcpy</span>(<span class="cm-variable">p</span>[<span class="cm-variable">c</span>], <span class="cm-variable">p</span>[<span class="cm-variable">c</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>], <span class="cm-keyword">sizeof</span> <span class="cm-variable">p</span>[<span class="cm-variable">c</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memcpy</span>(<span class="cm-variable">v</span>[<span class="cm-variable">c</span>], <span class="cm-variable">v</span>[<span class="cm-variable">c</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>], <span class="cm-keyword">sizeof</span> <span class="cm-variable">v</span>[<span class="cm-variable">c</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>;<span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">--</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">k</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">i</span> <span class="cm-operator">&amp;</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">v</span>[<span class="cm-variable">c</span>][<span class="cm-variable">i</span>]) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">p</span>[<span class="cm-variable">c</span>][<span class="cm-variable">i</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">np</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">swap</span>(<span class="cm-variable">p</span>[<span class="cm-variable">c</span>][<span class="cm-variable">i</span>], <span class="cm-variable">np</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">swap</span>(<span class="cm-variable">v</span>[<span class="cm-variable">c</span>][<span class="cm-variable">i</span>], <span class="cm-variable">k</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">k</span> <span class="cm-variable">^</span><span class="cm-operator">=</span> <span class="cm-variable">v</span>[<span class="cm-variable">c</span>][<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">v</span>[<span class="cm-variable">c</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">k</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">p</span>[<span class="cm-variable">c</span>][<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">np</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 414px;"></div><div class="CodeMirror-gutters" style="display: none; height: 414px;"></div></div></div></pre><p><span>求 </span><span class='math-in-toc'>$[l,r]$</span><span> 的时候，第 </span><span class='math-in-toc'>$i$</span><span> 位的线性基有效当且仅当这一位的最后更新时间在 </span><span class='math-in-toc'>$l$</span><span> 及以后。</span></p><h3><a name="数论线性基" class="md-header-anchor"></a><span>数论线性基</span></h3><p><span>这个名称可能不严谨，但是确实能让我们知道他和异或线性基的区别。数论线性基可以理解为一堆向量的大小最小的基底。</span></p><p><span>这甚至更简单。就是拿着贪心的思路暴力模拟就完事了。</span></p><h1><a name="字符串" class="md-header-anchor"></a><span>字符串</span></h1><h2><a name="字符串哈希" class="md-header-anchor"></a><span>字符串哈希</span></h2><p><span>为什么这个东西放在了最前面呢？道理很简单。这个东西很简单，但是能替代部分需要用一些略显复杂的算法才能维护的东西。</span></p><p><span>假定我们现在有一个字符串 </span><span class='math-in-toc'>$s$</span><span>，下标从 </span><span class='math-in-toc'>$1$</span><span> 到 </span><span class='math-in-toc'>$n$</span><span>。那么 </span><span class='math-in-toc'>$l$</span><span> 位置对应的哈希值 </span><span class='math-in-toc'>$h_l$</span><span> 为 </span><span class='math-in-toc'>$\Sigma_{i=1}^lp^{l-i}\times v(s_i)\bmod mod$</span><span>。</span></p><p><span>其中，</span><span class='math-in-toc'>$p$</span><span> 为一个选定的至少比 </span><span class='math-in-toc'>$s$</span><span> 的字符集大的质数（常用 </span><span class='math-in-toc'>$31,37,103,10003,\dots$</span><span>），</span><span class='math-in-toc'>$v(s_i)$</span><span> 是对 </span><span class='math-in-toc'>$s$</span><span> 字符集到数字的唯一对应，</span><span class='math-in-toc'>$mod$</span><span> 是一个指定的模数。有时用 </span><code>unsigned long long</code><span> 的自然溢出，即 </span><span class='math-in-toc'>$mod=2^{64}$</span><span>，但是容易被卡，所以 </span><span class='math-in-toc'>$mod$</span><span> 也常用一些大质数（常用 </span><span class='math-in-toc'>$998244353,10^9+7,\dots$</span><span>）。</span></p><p><span>也有递推的形式，更加常见：</span><span class='math-in-toc'>$h_l=p\times h_{l-1}+v(s_l)$</span><span>。</span></p><p><span>那么具体怎么用呢？哈希最常用的用处就是判断两个量相不相等。用哈希来比较两个完整串显然大材小用，一般他会用来比较多个字串是否相等。</span></p><p><span>对于 </span><span class='math-in-toc'>$l$</span><span> 到 </span><span class='math-in-toc'>$r$</span><span> 的字串，其哈希值为 </span><span class='math-in-toc'>$h_r-h_{l-1}\times p^{r-l+1}$</span><span>。</span></p><p><span>显然，对于任意的字符串，只要你选取的 </span><span class='math-in-toc'>$v$</span><span> 映射方式和 </span><span class='math-in-toc'>$mod,p$</span><span> 数一致，那么对于任意的相同子串的哈希值也是一样的。下证：</span></p><p><span>看回 </span><span class='math-in-toc'>$h$</span><span> 的直接计算形式，并带回哈希值计算方法，发现其值为 </span><span class='math-in-toc'>$(\Sigma_{i=1}^rp^{r-i}\times v(s_i)\bmod mod)-(\Sigma_{i=1}^{l-1}p^{l-1-i}\times v(s_i)\bmod mod)\times p^{r-l+1}=\Sigma_{i=l}^rp^{r-i}\times v(s_i)$</span><span>。我们令这个子串为 </span><span class='math-in-toc'>$s^\prime$</span><span>，不难发现，对 </span><span class='math-in-toc'>$s$</span><span> 整个串做哈希，其值为 </span><span class='math-in-toc'>$\Sigma_{i=1}^{r-l+1}p^{r-l+1-i}\times v(s^\prime_i)$</span><span>。又因为 </span><span class='math-in-toc'>$s^\prime_i=s_{i+l-1}$</span><span>，所以 </span><span class='math-in-toc'>$\Sigma_{i=1}^{r-l+1}p^{r-l+1-i}\times v(s^\prime_i)=\Sigma_{i=l}^rp^{r-i}\times v(s_i)$</span><span>。</span></p><p><span>也就是说，用一个字符串 </span><span class='math-in-toc'>$s$</span><span> 去截取子串所得到的哈希值，等于这个子串本身的哈希值。那么任意一个串中去截取同样的一段得到的哈希值也必然是一样的。</span></p><p><span>于是，恭喜你，得到了一种快速比较两个子串是否一样的方法。其作用不用我说也是相当大的。</span></p><h2><a name="kmp" class="md-header-anchor"></a><span>KMP</span></h2><p><span>主要是最长 </span><span class='math-in-toc'>$\text{border}$</span><span>。一般记一个串在 </span><span class='math-in-toc'>$i$</span><span> 位置的最长 </span><span class='math-in-toc'>$\text{border}$</span><span> 为 </span><span class='math-in-toc'>$\pi(i)$</span><span>。</span></p><p><span>最长 </span><span class='math-in-toc'>$\text{border}$</span><span> 指以位置 </span><span class='math-in-toc'>$i$</span><span> 结束且是字符串前缀的子串的最大长度。</span><span class='math-in-toc'>$z(i)$</span><span> 表示以位置 </span><span class='math-in-toc'>$i$</span><span> 开始且是字符串前缀的子串的最大长度。特别约定 </span><span class='math-in-toc'>$z(1)=0$</span><span>。</span></p><p><span>那 KMP 怎么玩 </span><span class='math-in-toc'>$\text{border}$</span><span> 呢？</span></p><p><span>暴力求解可以被形如 </span><span class='math-in-toc'>$aaaaaa\dots$</span><span> 的串卡到 </span><span class='math-in-toc'>$n^3$</span><span>，我们需要一些性质来优化。</span></p><p><span>假设有一个串，我们来求他的 </span><span class='math-in-toc'>$\text{border}$</span><span>，并且已经求出了前 </span><span class='math-in-toc'>$k$</span><span> 位的值。</span></p><p><span>在考虑 </span><span class='math-in-toc'>$k+1$</span><span> 位置的时候，我们不难发现，</span><span class='math-in-toc'>$\pi(k+1)\le\pi(k)+1$</span><span>。这一点可以使用 </span><span class='math-in-toc'>$\text{border}$</span><span> 的性质使用反证法非常方便的证明出来，不作赘述。</span></p><p><span>但是只是用这一点的话并不能做出什么特别有效的优化，毕竟往回跳的时候会需要 </span><span class='math-in-toc'>$O(n)$</span><span> 的验证，整体是 </span><span class='math-in-toc'>$O(n^2)$</span><span> 的。</span></p><p><span>再接着思考一下，当 </span><span class='math-in-toc'>$\pi(k+1)=\pi(k)+1$</span><span> 的时候，</span><span class='math-in-toc'>$s_{\pi(k)+1}=s_{k+1}$</span><span>。当 </span><span class='math-in-toc'>$\pi(k+1)\neq\pi(k)+1$</span><span> 时，我们则希望找出一个仍满足 </span><span class='math-in-toc'>$\pi$</span><span> 的性质，且长度最长的一个前缀兼后缀字串。这至少可以告诉我们，这两个字符串除最后一个字符以外的字符一定一模一样。</span></p><p><span>仔细想一下，因为现在我们有每一个前缀字串的最长公共前后缀，对于一个最长公共前后缀的最长公共前后缀，他也一定仍然是原前缀子串的公共前后缀。也就是说，在长度尽可能长的情况下，</span><span class='math-in-toc'>$\pi(\pi(k))$</span><span> 会是我们第二个考虑的可能的字符串。如果仍然不对，我们就一直考虑 </span><span class='math-in-toc'>$\pi(\pi(\dots(\pi(k))\dots))$</span><span>，直到上述值为 </span><span class='math-in-toc'>$0$</span><span>（即不存在符合要求的公共前后缀）或找到一个符合要求的值，使得 </span><span class='math-in-toc'>$s_{\pi(\pi(\dots(\pi(k))\dots))+1}=s_{k+1}$</span><span>。</span></p><p><span>这样，因为每一次 </span><span class='math-in-toc'>$\pi(k)$</span><span> 都至多增大 </span><span class='math-in-toc'>$1$</span><span>，而且后退的次数一定不大于前进次数，因此复杂度为 </span><span class='math-in-toc'>$O(n)$</span><span>。</span></p><p><span>其实说起来复杂做起来简单。核心代码大概就是 </span><span class='math-in-toc'>$5$</span><span> 行的样子。那这个 </span><span class='math-in-toc'>$\text{border}$</span><span> 有什么用呢？</span></p><p><span>很简单，字符串匹配。对于一个主串 </span><span class='math-in-toc'>$s_1$</span><span> 和一个模式串 </span><span class='math-in-toc'>$s_2$</span><span>，它可以用 </span><span class='math-in-toc'>$O(|s_1|+|s_2|)$</span><span> 的时间求解出来 </span><span class='math-in-toc'>$s_2$</span><span> 在 </span><span class='math-in-toc'>$s_1$</span><span> 中出现了多少次。</span></p><p><span>我们回忆一下暴力匹配的过程：从头匹配，遇到不符合就匹配下一个位置，直到匹配完匹配串。</span></p><p><span>再思考一下最长 </span><span class='math-in-toc'>$\text{border}$</span><span> 的性质，不难发现，如果这一个位置匹配不上，那么他的最长 </span><span class='math-in-toc'>$\text{border}$</span><span> 位置是最长的仍与前面的字符匹配的前缀子串。也就是说，我们没必要从头开始匹配，而是变相的从这个位置继续，改变已匹配的位置之后接着匹配。</span></p><p><span>这样做显然不会漏解，要是漏了，就与最长 </span><span class='math-in-toc'>$\text{border}$</span><span> 的性质相违背。</span></p><p><span>对于</span><a href='https://www.luogu.com.cn/problem/P3375'><span>【模板】KMP </span></a><span>而言，他就是问你 </span><span class='math-in-toc'>$s_2$</span><span> 的 </span><span class='math-in-toc'>$\pi(i)$</span><span> 函数值和 </span><span class='math-in-toc'>$s_2$</span><span> 在 </span><span class='math-in-toc'>$s_1$</span><span> 出现的位置。可解。</span></p><h2><a name="exkmp" class="md-header-anchor"></a><span>EXKMP</span></h2><p><span>主要是 </span><span class='math-in-toc'>$\text{LCP}$</span><span> 函数。一般记一个串在 </span><span class='math-in-toc'>$i$</span><span> 位置的 </span><span class='math-in-toc'>$\text{LCP}$</span><span> 为 </span><span class='math-in-toc'>$z(i)$</span><span>。那 EXKMP 和 </span><span class='math-in-toc'>$\text{LCP}$</span><span> 是什么呢？</span></p><h6><a name="这里有你没写完的东西杂鱼-n3989" class="md-header-anchor"></a><span>这里有你没写完的东西，杂鱼...</span></h6><h2><a name="sam" class="md-header-anchor"></a><span>SAM</span></h2><p><span>SAM 虽然叫做后缀自动机，但实际上他对于所有子串的优秀的压缩效果及其用途才是我们更为关心的。直观上，字符串的 SAM 可以理解为给定字符串的所有子串的压缩形式。实质上，字符串 </span><span class='math-in-toc'>$s$</span><span> 的 SAM 是一个接受 </span><span class='math-in-toc'>$s$</span><span> 的所有后缀的最小 DFA。</span></p><p><span>首先，SAM 本身包括这么些东西：</span></p><ol start='' ><li><span>点（状态），其实就是为了便于边的维护。</span></li><li><span>边（转移），边带权，带的是字符集中的某种字符。</span></li><li><span>终止状态，如果我们从初始状态 </span><span class='math-in-toc'>$t$</span><span> 出发，最终转移到了一个终止状态，则路径上的所有转移连接起来一定是原串的一个后缀。原串的每个后缀均可用一条从 </span><span class='math-in-toc'>$t$</span><span> 到某个终止状态的路径构成。</span></li></ol><p><span>仅仅考虑这些的话，SAM 就是一个 DAG。</span></p><p><span>SAM 最重要的性质是，它包含关于原串的所有子串的信息。任意从初始状态 </span><span class='math-in-toc'>$t$</span><span> 开始的路径，如果我们将转移路径上的权写下来，都会形成原串的一个子串。反之每个原串的子串对应从 </span><span class='math-in-toc'>$t$</span><span> 开始的某条路径。</span></p><p><span>到达某个状态的路径可能不止一条，因此我们说一个状态对应一些字符串的集合，这个集合的每个元素对应这些路径。</span></p><p><span>看起来好像确实非常有用，但是问题在于我们怎么用一个高效的方式给他构造出来呢？实际上，我们可以做到线性时空复杂度。我们需要两个非常重要的东西：结束位置(</span><code>endpos</code><span>)和后缀链接(</span><code>link</code><span>)。</span></p><h3><a name="结束位置endpos" class="md-header-anchor"></a><span>结束位置(</span><code>endpos</code><span>)</span></h3><p><span>考虑字符串 </span><span class='math-in-toc'>$s$</span><span> 的任意非空子串 </span><span class='math-in-toc'>$t$</span><span>，我们记 </span><span class='math-in-toc'>$\operatorname{endpos}(t)$</span><span> 为在字符串 </span><span class='math-in-toc'>$s$</span><span> 中 </span><span class='math-in-toc'>$t$</span><span> 的所有结束位置（假设对字符串中字符的编号从零开始）。例如，对于字符串 </span><span class='math-in-toc'>$\texttt{abcbc}$</span><span>，我们有 </span><span class='math-in-toc'>$\operatorname{endpos}(\texttt{bc})=2,4$</span><span>。</span></p><p><span>两个子串 </span><span class='math-in-toc'>$t_1$</span><span> 与 </span><span class='math-in-toc'>$t_2$</span><span> 的 </span><span class='math-in-toc'>$\operatorname{endpos}$</span><span> 集合可能相等：</span><span class='math-in-toc'>$\operatorname{endpos}(t_1)=\operatorname{endpos}(t_2)$</span><span>。这样所有字符串 </span><span class='math-in-toc'>$s$</span><span> 的非空子串都可以根据它们的 </span><span class='math-in-toc'>$\operatorname{endpos}$</span><span> 集合被分为若干等价类。</span></p><p><span>显然，SAM 中的每个状态对应一个或多个 </span><span class='math-in-toc'>$\operatorname{endpos}$</span><span> 相同的子串。换句话说，SAM 中的状态数等于所有子串的等价类的个数，再加上初始状态。SAM 的状态个数等价于 </span><span class='math-in-toc'>$\operatorname{endpos}$</span><span> 相同的一个或多个子串所组成的集合的个数 </span><span class='math-in-toc'>$+1$</span><span>。</span></p><p><code>endpos</code><span> 有若干定理性质，</span><span class='math-in-toc'>$\texttt{oi-wiki}$</span><span> 中写了三条，但其中 </span><span class='math-in-toc'>$1,3$</span><span> 条均可由第 </span><span class='math-in-toc'>$2$</span><span> 条得到：</span></p><p><span>若 </span><span class='math-in-toc'>$u,v\in s,\,u,v\neq\empty,|u|\le|v|$</span><span>，则：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n4010" cid="n4010" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><script type="math/tex; mode=display">\operatorname{endpos}(u)\cap\operatorname{endpos}(v)\begin{cases}
   \operatorname{endpos}(v) &\text{u is a suffix of v}\\
   \emptyset &\text{otherwise}
\end{cases}</script></div></div><p><span>正确性显然。</span></p><h3><a name="后缀链接link" class="md-header-anchor"></a><span>后缀链接(</span><code>link</code><span>)</span></h3><p><span>考虑 SAM 中某个不是 </span><span class='math-in-toc'>$t$</span><span> 的状态 </span><span class='math-in-toc'>$v$</span><span>。我们已经知道状态 </span><span class='math-in-toc'>$v$</span><span> 对应于具有相同 </span><span class='math-in-toc'>$\operatorname{endpos}$</span><span> 的等价类。我们如果定义 </span><span class='math-in-toc'>$w$</span><span> 为这些字符串中最长的一个，则所有其它的字符串都是 </span><span class='math-in-toc'>$w$</span><span> 的后缀。</span></p><p><span>我们还知道字符串 </span><span class='math-in-toc'>$w$</span><span> 的前几个后缀（按长度降序考虑）全部包含于这个等价类，且所有其它后缀（至少有一个——空后缀）在其它的等价类中。我们记 </span><span class='math-in-toc'>$p$</span><span> 为最长的这样的后缀，然后将 </span><span class='math-in-toc'>$v$</span><span> 的后缀链接连到 </span><span class='math-in-toc'>$p$</span><span> 上。</span></p><p><span>换句话说，一个后缀链接 </span><span class='math-in-toc'>$\operatorname{link}(v)$</span><span> 连接到对应于 </span><span class='math-in-toc'>$w$</span><span> 的最长后缀的另一个 </span><span class='math-in-toc'>$\operatorname{endpos}$</span><span> 等价类的状态。</span></p><p><span>与之相关的也有两个性质定理：</span></p><p><span>所有后缀链接构成一棵根节点为 </span><span class='math-in-toc'>$t$</span><span> 的树。</span></p><p><span>通过 </span><span class='math-in-toc'>$\operatorname{endpos}$</span><span> 集合构造的树（每个子节点的 </span><span class='math-in-toc'>$\texttt{subset}$</span><span> 都包含在父节点的 </span><span class='math-in-toc'>$\texttt{subset}$</span><span> 中）与通过后缀链接 </span><span class='math-in-toc'>$\operatorname{link}$</span><span> 构造的树相同。</span></p><p><span>这两个性质放一起构成了 SAM 构造中最重要的理论依据。现在我们终于可以讲构造过程了。这个算法是在线算法，我们可以逐个加入字符串中的每个字符，并且在每一步中对应地维护 SAM。任务转化为实现给当前字符串添加一个字符 </span><span class='math-in-toc'>$c$</span><span> 的过程。一开始 SAM 只包含一个状态 </span><span class='math-in-toc'>$t$</span><span>，编号为 </span><span class='math-in-toc'>$0$</span><span>（其它状态的编号为 </span><span class='math-in-toc'>$1,2,\dots$</span><span>）。为了方便，对于状态 </span><span class='math-in-toc'>$t$</span><span> 我们指定 </span><span class='math-in-toc'>$\operatorname{len}=0,\operatorname{link}=-1$</span><span>（</span><span class='math-in-toc'>$-1$</span><span> 表示虚拟状态）。算法流程如下：</span></p><ol start='' ><li><span>令 </span><span class='math-in-toc'>$\texttt{last}$</span><span> 为添加字符 </span><span class='math-in-toc'>$c$</span><span> 之前，整个字符串对应的状态（一开始我们设 </span><span class='math-in-toc'>$\texttt{last}=0$</span><span>，算法的最后一步更新 </span><span class='math-in-toc'>$\texttt{last}$</span><span>）。</span></li><li><span>创建一个新的状态 </span><span class='math-in-toc'>$\texttt{cur}$</span><span>，并将 </span><span class='math-in-toc'>$\operatorname{len}(\texttt{cur})$</span><span> 赋值为 </span><span class='math-in-toc'>$\operatorname{len}(\texttt{last})+1$</span><span>，在这时 </span><span class='math-in-toc'>$\operatorname{link}(\texttt{cur})$</span><span> 的值还未知。</span></li><li><span>现在我们按以下流程进行（从状态 </span><span class='math-in-toc'>$\texttt{last}$</span><span> 开始）。如果还没有到字符 </span><span class='math-in-toc'>$c$</span><span> 的转移，我们就添加一个到状态 </span><span class='math-in-toc'>$\texttt{cur}$</span><span> 的转移，遍历后缀链接。如果在某个点已经存在到字符 </span><span class='math-in-toc'>$c$</span><span> 的转移，我们就停下来，并将这个状态标记为 </span><span class='math-in-toc'>$p$</span><span>。</span></li><li><span>如果没有找到这样的状态 </span><span class='math-in-toc'>$p$</span><span>，我们就到达了虚拟状态 </span><span class='math-in-toc'>$-1$</span><span>，我们将 </span><span class='math-in-toc'>$\operatorname{link}(\texttt{cur})$</span><span> 赋值为 </span><span class='math-in-toc'>$0$</span><span> 并退出。</span></li><li><span>假设现在我们找到了一个状态 </span><span class='math-in-toc'>$p$</span><span>，其可以通过字符 </span><span class='math-in-toc'>$c$</span><span> 转移。我们将转移到的状态标记为 </span><span class='math-in-toc'>$q$</span><span>。</span></li><li><span>现在我们分类讨论两种状态，要么 </span><span class='math-in-toc'>$\operatorname{len}(p) + 1 = \operatorname{len}(q)$</span><span>，要么不是。</span></li><li><span>如果 </span><span class='math-in-toc'>$\operatorname{len}(p)+1=\operatorname{len}(q)$</span><span>，我们只要将 </span><span class='math-in-toc'>$\operatorname{link}(\texttt{cur})$</span><span> 赋值为 q 并退出。</span></li><li><span>否则就会有些复杂。需要复制状态 </span><span class='math-in-toc'>$q$</span><span>：我们创建一个新的状态 </span><span class='math-in-toc'>$\texttt{clone}$</span><span>，复制 </span><span class='math-in-toc'>$q$</span><span> 的除了 </span><span class='math-in-toc'>$\operatorname{len}$</span><span> 的值以外的所有信息（后缀链接和转移）。我们将 </span><span class='math-in-toc'>$\operatorname{len}(\texttt{clone})$</span><span> 赋值为 </span><span class='math-in-toc'>$\operatorname{len}(p)+1$</span><span>。</span></li><li><span>复制之后，我们将后缀链接从 </span><span class='math-in-toc'>$\texttt{cur}$</span><span> 指向 </span><span class='math-in-toc'>$\texttt{clone}$</span><span>，也从 </span><span class='math-in-toc'>$q$</span><span> 指向 </span><span class='math-in-toc'>$\texttt{clone}$</span><span>。</span></li><li><span>最终我们需要使用后缀链接从状态 </span><span class='math-in-toc'>$p$</span><span> 往回走，只要存在一条通过 </span><span class='math-in-toc'>$p$</span><span> 到状态 </span><span class='math-in-toc'>$q$</span><span> 的转移，就将该转移重定向到状态 </span><span class='math-in-toc'>$\texttt{clone}$</span><span>。</span></li><li><span>以上三种情况，在完成这个过程之后，我们将 </span><span class='math-in-toc'>$\texttt{last}$</span><span> 的值更新为状态 </span><span class='math-in-toc'>$\texttt{cur}$</span><span>。</span></li></ol><p><span>算法本体讲解完毕，模板题代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">constexpr</span> <span class="cm-variable-3">int</span> <span class="cm-variable">siz</span> <span class="cm-operator">=</span> <span class="cm-number">2e6</span> <span class="cm-operator">+</span> <span class="cm-number">5</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">long</span> <span class="cm-variable-3">long</span> <span class="cm-variable">ans</span>; <span class="cm-variable-3">char</span> <span class="cm-variable">c</span>[<span class="cm-variable">siz</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-number">1</span>]; <span class="cm-variable">vector</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">int</span><span class="cm-operator">&gt;</span><span class="cm-variable">son</span>[<span class="cm-variable">siz</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">suf_atm</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">sn</span>[<span class="cm-variable">siz</span>][<span class="cm-number">26</span>], <span class="cm-variable">lk</span>[<span class="cm-variable">siz</span>], <span class="cm-variable">ln</span>[<span class="cm-variable">siz</span>], <span class="cm-variable">cnt</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">sz</span>[<span class="cm-variable">siz</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">add</span>(<span class="cm-variable-3">char</span> <span class="cm-variable">c</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">pv</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">lp</span>; <span class="cm-variable">sz</span>[<span class="cm-variable">lp</span> <span class="cm-operator">=</span> <span class="cm-operator">++</span><span class="cm-variable">cnt</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">ln</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">=</span> <span class="cm-variable">pv</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">p</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-variable">c</span>]) <span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-variable">c</span>] <span class="cm-operator">=</span> <span class="cm-variable">lp</span>, <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">lk</span>[<span class="cm-variable">p</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">p</span>) <span class="cm-keyword">return</span> <span class="cm-variable-3">void</span>(<span class="cm-variable">lk</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>); <span class="cm-variable-3">int</span> <span class="cm-variable">np</span> <span class="cm-operator">=</span> <span class="cm-variable">sn</span>[<span class="cm-variable">p</span>][<span class="cm-variable">c</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">ln</span>[<span class="cm-variable">p</span>] <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-operator">==</span> <span class="cm-variable">ln</span>[<span class="cm-variable">np</span>]) <span class="cm-keyword">return</span> <span class="cm-variable-3">void</span>(<span class="cm-variable">lk</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">=</span> <span class="cm-variable">np</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ln</span>[<span class="cm-operator">++</span><span class="cm-variable">cnt</span>] <span class="cm-operator">=</span> <span class="cm-variable">ln</span>[<span class="cm-variable">p</span>] <span class="cm-operator">+</span> <span class="cm-number">1</span>; <span class="cm-variable">lk</span>[<span class="cm-variable">cnt</span>] <span class="cm-operator">=</span> <span class="cm-variable">lk</span>[<span class="cm-variable">np</span>]; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">lk</span>[<span class="cm-variable">np</span>] <span class="cm-operator">=</span> <span class="cm-variable">lk</span>[<span class="cm-variable">lp</span>] <span class="cm-operator">=</span> <span class="cm-variable">cnt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memcpy</span>(<span class="cm-variable">sn</span>[<span class="cm-variable">cnt</span>], <span class="cm-variable">sn</span>[<span class="cm-variable">np</span>], <span class="cm-keyword">sizeof</span> <span class="cm-variable">sn</span>[<span class="cm-variable">np</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">p</span>; <span class="cm-variable">sn</span>[<span class="cm-variable">i</span>][<span class="cm-variable">c</span>] <span class="cm-operator">==</span> <span class="cm-variable">np</span>; <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">lk</span>[<span class="cm-variable">i</span>]) <span class="cm-variable">sn</span>[<span class="cm-variable">i</span>][<span class="cm-variable">c</span>] <span class="cm-operator">=</span> <span class="cm-variable">cnt</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">pre</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">cnt</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">son</span>[<span class="cm-variable">lk</span>[<span class="cm-variable">i</span>]].<span class="cm-variable">emplace_back</span>(<span class="cm-variable">i</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">inline</span> <span class="cm-variable-3">void</span> <span class="cm-variable">dfs</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">sp</span> : <span class="cm-variable">son</span>[<span class="cm-variable">p</span>]) <span class="cm-variable">dfs</span>(<span class="cm-variable">sp</span>), <span class="cm-variable">sz</span>[<span class="cm-variable">p</span>] <span class="cm-operator">+=</span> <span class="cm-variable">sz</span>[<span class="cm-variable">sp</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">sz</span>[<span class="cm-variable">p</span>] <span class="cm-operator">!=</span> <span class="cm-number">1</span>) <span class="cm-variable">ans</span> <span class="cm-operator">=</span> <span class="cm-variable">max</span>(<span class="cm-variable">ans</span>, <span class="cm-variable">sz</span>[<span class="cm-variable">p</span>] <span class="cm-operator">*</span> <span class="cm-number">1ll</span> <span class="cm-operator">*</span> <span class="cm-variable">ln</span>[<span class="cm-variable">p</span>]);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">sam</span>;<span class="cm-comment">//没有按讲的来写，p=0就是虚拟状态，t=1作为起始点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>); <span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> (<span class="cm-variable">c</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">c</span>[<span class="cm-variable">i</span>]; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">sam</span>.<span class="cm-variable">add</span>(<span class="cm-variable">c</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-string">'a'</span>, <span class="cm-variable">i</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sam</span>.<span class="cm-variable">pre</span>(); <span class="cm-variable">sam</span>.<span class="cm-variable">dfs</span>(<span class="cm-number">1</span>); <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">ans</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 667px;"></div><div class="CodeMirror-gutters" style="display: none; height: 667px;"></div></div></div></pre><p><span>看看这个：</span><a href='yutong.site/sam/'><span>yutong.site/sam/</span></a><span>。</span></p><p><span>那他的应用呢？挺多的，列例题讲解吧。</span></p><p><a href='https://www.luogu.com.cn/problem/P3804'><span>T0,【模板】后缀自动机（SAM）,</span><span class='math-in-toc'>$\color{purple}\texttt{省选/NOI−}$</span></a><span>，板子题。</span></p><p><a href='https://www.luogu.com.cn/problem/SP7258'><span>T1-1,SUBLEX,</span><span class='math-in-toc'>$\color{purple}\texttt{省选/NOI−}$</span></a><span>&amp;&amp;</span><a href='https://www.luogu.com.cn/problem/P3975'><span>T1-2,[TJOI2015] 弦论,</span><span class='math-in-toc'>$\color{purple}\texttt{省选/NOI−}$</span></a><span>，SAM 求字典序第 </span><span class='math-in-toc'>$k$</span><span> 大子串。</span></p><p><span>HINT：字典序第 </span><span class='math-in-toc'>$k$</span><span> 大的子串对应于 SAM 中字典序第 </span><span class='math-in-toc'>$k$</span><span> 大的路径，因此在计算每个状态的路径数后，我们可以很容易地从 SAM 的根开始找到第 </span><span class='math-in-toc'>$k$</span><span> 大的路径。</span></p><p><a href='https://www.luogu.com.cn/problem/P1368'><span>T2,【模板】最小表示法,</span><span class='math-in-toc'>$\color{blue}提高+/省选-$</span></a><span>，SAM 求最小表示法。</span></p><p><span>HINT：容易发现字符串 </span><span class='math-in-toc'>$S+S$</span><span> 包含字符串 </span><span class='math-in-toc'>$S$</span><span> 的所有循环移位作为子串。所以问题简化为在 </span><span class='math-in-toc'>$S+S$</span><span> 对应的后缀自动机上寻找最小的长度为 </span><span class='math-in-toc'>$|S|$</span><span> 的路径。</span></p><p><span>Query：你还记得他的更简便的求法吗？</span></p><p><a href='https://www.luogu.com.cn/problem/SP1811'><span>T3-1,LCS,</span><span class='math-in-toc'>$\color{purple}\texttt{省选/NOI−}$</span></a><span>&amp;&amp;</span><a href='https://www.luogu.com.cn/problem/SP10570'><span>T3-2,LONGCS,</span><span class='math-in-toc'>$\color{purple}\texttt{省选/NOI−}$</span></a><span>&amp;&amp;</span><a href='https://www.luogu.com.cn/problem/SP1812'><span>T3-3,LCS2,</span><span class='math-in-toc'>$\color{purple}\texttt{省选/NOI−}$</span></a><span>，SAM 求两个/多个字符串的最长公共子串。</span></p><p><span>HINT1：求两个的话，我们可以构造出一个字符串的 SAM，我们现在处理另一个字符串，对于每一个前缀，都在 SAM 中寻找这个前缀的最长后缀，求最大值即可。转移的时候，类似于 KMP 的跳 </span><span class='math-in-toc'>$\texttt{border}$</span><span>，ACAM 的跳失配指针，我们跳后缀链接并更新长度即可。</span></p><p><span>HINT2：求多个的话，我们将所有的子串连接成一个较长的字符串 </span><span class='math-in-toc'>$T$</span><span>，以特殊字符 </span><span class='math-in-toc'>$D_i$</span><span> 分开每个字符串（一个字符对应一个字符串）：</span><span class='math-in-toc'>$T=S_1+D_1+S_2+D_2+\cdots+S_k+D_k$</span><span>。然后对字符串 T 构造后缀自动机。答案就是最深的且它的子树中具有所有分节符的非叶子节点。</span></p><p><a href='https://www.luogu.com.cn/problem/P4070'><span>T4,[SDOI2016] 生成魔咒,</span><span class='math-in-toc'>$\color{purple}\texttt{省选/NOI−}$</span></a><span>，动态求本质不同子串的个数。</span></p><p><span>HINT：每次新出现的本质不同的子串个数就等于 </span><span class='math-in-toc'>$\large{len_{newp}-len_{link_{newp}}}$</span><span>。</span></p><p><span>还有很多啊，比如出现次数，第一次出现的位置，所有出现的位置等，但是大多可以用 ACAM 吃掉。</span></p><p><span>依据</span><a href='https://www.luogu.com/discuss/774815'><span>这个帖子</span></a><span>，SA 胜过 SAM 的地方在于 SAM 不能（或者很难）</span><span class='math-in-toc'>$O(1)$</span><span> 比较两个后缀的字典序（by 366338），而 SAM 中的 </span><span class='math-in-toc'>$\texttt{parent tree}$</span><span> 却可以用来干很多恶心人的事。不过，二者似乎可以在 </span><span class='math-in-toc'>$O(n|\Sigma|)$</span><span> 的时间内互相转化，因此不太存在只能用其一解的题。</span></p><p><span>Tip：有的文章会说在牺牲一点点效率的情况下可以做到严格线性的空间复杂度，带 </span><span class='math-in-toc'>$\log$</span><span> 或常数的时间复杂度，但是实际上，</span><code>map&lt;int,int&gt;</code><span> 在 gcc 下初始状态下会占 </span><span class='math-in-toc'>$48bit$</span><span>，</span><code>unordered_map&lt;int,int&gt;</code><span> 更是会占到 </span><span class='math-in-toc'>$152bit$</span><span>。前者相当于 </span><span class='math-in-toc'>$12$</span><span> 个 </span><code>int</code><span>，后者相当于 </span><span class='math-in-toc'>$38$</span><span> 个 </span><code>int</code><span>。因此，实际应用中（多为小写字母 </span><span class='math-in-toc'>$26$</span><span> 大小字符集），可以酌情选择前者，一定不要选择后者。</span></p><h2><a name="sa" class="md-header-anchor"></a><span>SA</span></h2><p><span>部分进阶知识可以参见</span><a href='https://github.com/OI-wiki/libs/blob/master/%E9%9B%86%E8%AE%AD%E9%98%9F%E5%8E%86%E5%B9%B4%E8%AE%BA%E6%96%87/%E5%9B%BD%E5%AE%B6%E9%9B%86%E8%AE%AD%E9%98%9F2009%E8%AE%BA%E6%96%87%E9%9B%86/11.%E7%BD%97%E7%A9%97%E9%AA%9E%E3%80%8A%E5%90%8E%E7%BC%80%E6%95%B0%E7%BB%84%E2%80%94%E2%80%94%E5%A4%84%E7%90%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%89%E5%8A%9B%E5%B7%A5%E5%85%B7%E3%80%8B/%E5%90%8E%E7%BC%80%E6%95%B0%E7%BB%84%E2%80%94%E2%80%94%E5%A4%84%E7%90%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%89%E5%8A%9B%E5%B7%A5%E5%85%B7.pdf'><span>这篇</span></a><span>集训队论文。</span></p><p><span>SA，全称 </span><span class='math-in-toc'>$\texttt{Suffix Array}$</span><span>，译为后缀数组。</span><span class='math-in-toc'>$sa_i$</span><span> 在所有后缀中的字典序升序排名的第 </span><span class='math-in-toc'>$i$</span><span> 个后缀的开始位置，表示的是</span><span class='math-in-toc'>$rk_i$</span><span> 表示的是后缀 </span><span class='math-in-toc'>$[i,n]$</span><span> 在所有后缀中的字典序升序排名。</span><span class='math-in-toc'>$height_i$</span><span> 表示 </span><span class='math-in-toc'>$\operatorname{LCP}(sa_i,sa_{i-1})$</span><span>。</span></p><p><span>怎么求 </span><span class='math-in-toc'>$sa$</span><span> 呢？首先有一种暴力的 </span><span class='math-in-toc'>$O(n\log^2n)$</span><span> 的做法。我们将所有的后缀拿过来排序。这不是 </span><span class='math-in-toc'>$O(n^2\log n)$</span><span> 的吗？但事实上，比较两个字符串就是在比较它们第一处不一样的位置的大小。因此我们可以用 Hash+BinarySearch 优化到 </span><span class='math-in-toc'>$O(n\log^2n)$</span><span>。</span></p><p><span>但是这样做时间复杂度仍然有些高，能不能优化到 </span><span class='math-in-toc'>$O(n\log n)$</span><span> 呢？可以，不过我们换一种方式。</span></p><p><span>假如说我们已经排出了这些后缀在考虑前 </span><span class='math-in-toc'>$2^i$</span><span> 个字符时的大小，那么怎么拓展到 </span><span class='math-in-toc'>$2^{i+1}$</span><span> 个字符呢？显然我们只需要对有序二元组 </span><span class='math-in-toc'>$(sa_p,sa_{p+2^i})$</span><span> 排序就行了。正确性显然。</span></p><p><span>但是这样不还是 </span><span class='math-in-toc'>$O(n\log^2 n)$</span><span> 的吗？不是。不难注意到 </span><span class='math-in-toc'>$sa\le n$</span><span>，也就是说我们可以不基于比较进行排序。我们采用计数排序。</span></p><p><span>欸？二维的怎么计数排序？很简单啊，先把第二维升序排了再把第一维顺序排了。</span></p><p><span>那你的 </span><span class='math-in-toc'>$rk$</span><span> 数组怎么处理？最后处理吗？显然不是，计数排序的时候我们就需要 </span><span class='math-in-toc'>$rk$</span><span> 数组。但是一定要注意 </span><span class='math-in-toc'>$rk$</span><span> 只在两维都排完之后才会更新。毕竟两次排序本质上是一次二维排序。你中间就把排名改了能对就怪了。</span></p><p><span>这样就优化到 </span><span class='math-in-toc'>$O(n\log n)$</span><span> 了。还能更优吗？可以。你可以使用 </span><a href='https://riteme.site/blog/2016-6-19/sais.html'><span>SA-IS</span></a><span> 算法做到 </span><span class='math-in-toc'>$O(n)$</span><span>，他要更优于 DC3。为什么？因为提高了缓存命中率（喜）。</span></p><p><span>这不重要，来看 </span><span class='math-in-toc'>$height$</span><span> 数组吧。首先很显然，</span><span class='math-in-toc'>$height$</span><span> 数组仍然可以用 Hash+BinarySearch 做到 </span><span class='math-in-toc'>$O(n\log n)$</span><span>，但是能不能更优呢？</span></p><p><span>可以的。很难(?)注意到一个性质：</span><span class='math-in-toc'>$height[rk[i]]\ge height[rk[i-1]]-1$</span><span>。总之，有了这个性质，我们就可以暴力模拟这个性质获得 </span><span class='math-in-toc'>$O(n)$</span><span> 的简短的算法。为什么是 </span><span class='math-in-toc'>$O(n)$</span><span> 呢？因为最多 </span><span class='math-in-toc'>$n$</span><span> 次减一，对应最多 </span><span class='math-in-toc'>$O(n)$</span><span> 次加一。</span></p><p><span>比模板题更模板的</span><a href='https://www.luogu.com.cn/problem/P10469'><span>模板题</span></a><span>代码如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="cpp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="cpp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include&lt;bits/stdc++.h&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">using</span> <span class="cm-keyword">namespace</span> <span class="cm-def">std</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">string</span> <span class="cm-variable">s</span>; <span class="cm-variable-3">int</span> <span class="cm-variable">n</span>, <span class="cm-variable">sa</span>[<span class="cm-number">1000005</span>], <span class="cm-variable">rk</span>[<span class="cm-number">1000005</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>], <span class="cm-variable">h</span>[<span class="cm-number">1000005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">bc</span>[<span class="cm-number">1000005</span>], <span class="cm-variable">oldrk</span>[<span class="cm-number">1000005</span> <span class="cm-operator">*</span> <span class="cm-number">2</span>], <span class="cm-variable">oldsa</span>[<span class="cm-number">1000005</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">signed</span> <span class="cm-def">main</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">ios::sync_with_stdio</span>(<span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cin</span> <span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">s</span>; <span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-variable">s</span>.<span class="cm-variable">size</span>(); <span class="cm-variable">s</span> <span class="cm-operator">=</span> <span class="cm-string">' '</span> <span class="cm-operator">+</span> <span class="cm-variable">s</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">s</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-=</span> <span class="cm-string">'a'</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-operator">++</span><span class="cm-variable">bc</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">s</span>[<span class="cm-variable">i</span>]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">26</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">bc</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+=</span> <span class="cm-variable">bc</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">n</span>; <span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span><span class="cm-operator">--</span>) <span class="cm-variable">sa</span>[<span class="cm-variable">bc</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">i</span>]]<span class="cm-operator">--</span>] <span class="cm-operator">=</span> <span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memcpy</span>(<span class="cm-variable">oldrk</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">rk</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>) <span class="cm-operator">*</span> <span class="cm-variable">n</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span>]] <span class="cm-operator">=</span> (<span class="cm-variable">p</span> <span class="cm-operator">+=</span> (<span class="cm-variable">oldrk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span>]] <span class="cm-operator">!=</span> <span class="cm-variable">oldrk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]]));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">w</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">w</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">n</span>; <span class="cm-variable">w</span> <span class="cm-operator">&lt;&lt;=</span> <span class="cm-number">1</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">bc</span>, <span class="cm-number">0</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">bc</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memcpy</span>(<span class="cm-variable">oldsa</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">sa</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>) <span class="cm-operator">*</span> <span class="cm-variable">n</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-operator">++</span><span class="cm-variable">bc</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">oldsa</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-variable">w</span>]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">bc</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+=</span> <span class="cm-variable">bc</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">n</span>; <span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span><span class="cm-operator">--</span>) <span class="cm-variable">sa</span>[<span class="cm-variable">bc</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">oldsa</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-variable">w</span>]]<span class="cm-operator">--</span>] <span class="cm-operator">=</span> <span class="cm-variable">oldsa</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memset</span>(<span class="cm-variable">bc</span>, <span class="cm-number">0</span>, <span class="cm-keyword">sizeof</span> <span class="cm-variable">bc</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memcpy</span>(<span class="cm-variable">oldsa</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">sa</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>) <span class="cm-operator">*</span> <span class="cm-variable">n</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-operator">++</span><span class="cm-variable">bc</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">oldsa</span>[<span class="cm-variable">i</span>]]];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">bc</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+=</span> <span class="cm-variable">bc</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">n</span>; <span class="cm-variable">i</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span><span class="cm-operator">--</span>) <span class="cm-variable">sa</span>[<span class="cm-variable">bc</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">oldsa</span>[<span class="cm-variable">i</span>]]]<span class="cm-operator">--</span>] <span class="cm-operator">=</span> <span class="cm-variable">oldsa</span>[<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">memcpy</span>(<span class="cm-variable">oldrk</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">rk</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>) <span class="cm-operator">*</span> <span class="cm-variable">n</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">rk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span>]] <span class="cm-operator">=</span> (<span class="cm-variable">p</span> <span class="cm-operator">+=</span> (<span class="cm-variable">oldrk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span>]] <span class="cm-operator">!=</span> <span class="cm-variable">oldrk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>]] <span class="cm-operator">||</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">oldrk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span>] <span class="cm-operator">+</span> <span class="cm-variable">w</span>] <span class="cm-operator">!=</span> <span class="cm-variable">oldrk</span>[<span class="cm-variable">sa</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>] <span class="cm-operator">+</span> <span class="cm-variable">w</span>]));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">sa</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-number">1</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-string">" "</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>; <span class="cm-comment">//O(nlogn) 求 sa</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">k</span>) <span class="cm-variable">k</span><span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">rk</span>[<span class="cm-variable">i</span>] <span class="cm-operator">==</span> <span class="cm-number">1</span>) <span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">j</span> <span class="cm-operator">=</span> <span class="cm-variable">sa</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-number">1</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-variable">s</span>[<span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-variable">k</span>] <span class="cm-operator">==</span> <span class="cm-variable">s</span>[<span class="cm-variable">j</span> <span class="cm-operator">+</span> <span class="cm-variable">k</span>]) <span class="cm-variable">k</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">h</span>[<span class="cm-variable">rk</span>[<span class="cm-variable">i</span>]] <span class="cm-operator">=</span> <span class="cm-variable">k</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">n</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>) <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">h</span>[<span class="cm-variable">i</span>] <span class="cm-operator">&lt;&lt;</span> <span class="cm-string">" "</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>; <span class="cm-comment">//O(n) 求 height</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1012px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1012px;"></div></div></div></pre></div>
</body>
</html>